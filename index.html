<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Russia</title>
    
    <!-- üëá –ù–ê–°–¢–†–û–ô–ö–ò üëá -->
    <script>
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkA8d8DIy994lgU70DGQ604EZ6e59kkEPm_Zhfaj8eG_QxmbwKltgFK5kRF3bl41_LzA/exec"; 
        const POLICY_URL = "https://docs.google.com/document/d/19ZXBWJGYijUGIw7GwUUcuK4CkDfFuSqPxvbQEBJjqnQ/edit?usp=sharing";
        
        // –ê—Ä—Ç–∏–∫—É–ª—ã Wildberries
        const WB_URL_SINGLE = "https://www.wildberries.ru/catalog/176733207/detail.aspx"; 
        const WB_URL_SET = "https://www.wildberries.ru/catalog/237586968/detail.aspx";    
        
        const VALID_CODES = ["6433", "0309", "5528"];
    </script>
    <!-- üëÜ –ö–û–ù–ï–¶ –ù–ê–°–¢–†–û–ï–ö üëÜ -->

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #ff0055;
            --accent: #ffcc00;
            --bg-grad-start: #1a0b0b;
            --bg-grad-end: #000000;
            --text-color: white;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: var(--text-color); display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
            transition: background 0.5s;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        /* –ò–ì–†–û–í–û–ô –ö–†–£–ì */
        .score-circle {
            width: 210px; height: 210px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 10px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: border-color 0.1s; position: relative; z-index: 2;
        }
        
        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
        .volume-meter {
            width: 200px; height: 8px; background: #333; border-radius: 4px; margin-top: 15px;
            position: relative; overflow: hidden;
        }
        .volume-bar {
            height: 100%; background: #00ff88; width: 0%; transition: width 0.05s, background 0.2s;
        }
        .volume-bar.locked { background: #ff0055; } /* –ö—Ä–∞—Å–Ω—ã–π –∫–æ–≥–¥–∞ –∑–∞–Ω—è—Ç */
        
        .volume-threshold {
            position: absolute; top: 0; bottom: 0; width: 2px; background: white; z-index: 5;
            left: 20%; box-shadow: 0 0 5px white;
        }
        
        @keyframes shake-anim {
            0% { transform: translate(1px, 1px); } 25% { transform: translate(-2px, -2px); }
            50% { transform: translate(2px, 0px); } 75% { transform: translate(-1px, 2px); } 100% { transform: translate(0, 0); }
        }
        .shake { animation: shake-anim 0.2s; }

        .hit { border-color: var(--primary); box-shadow: 0 0 50px var(--primary); color: var(--primary); }

        button {
            padding: 16px 0; font-size: 17px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; z-index: 5;
            transition: background 0.3s;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #444; color: #888; box-shadow: none; cursor: not-allowed; }
        button.channel-btn { background: #2AABEE; color: white; box-shadow: 0 4px 15px rgba(42, 171, 238, 0.3); }
        button.secondary-btn { background: transparent; border: 1px solid #444; color: #aaa; box-shadow: none; font-size: 14px; margin-top: 15px; padding: 12px; }

        /* –í–´–ë–û–† –†–ï–ñ–ò–ú–ê */
        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; width: 95%; max-width: 340px; }
        .mode-btn { flex: 1; padding: 10px 5px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #aaa; border-radius: 12px; font-size: 11px; font-weight: bold; margin: 0; box-shadow: none; }
        .mode-btn.active-mode { background: var(--primary); color: white; border-color: var(--primary); }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-panel { background: rgba(30,30,30,0.95); border: 1px solid #555; padding: 20px; border-radius: 15px; margin-bottom: 20px; width: 85%; max-width: 300px; display: none; z-index: 10; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        input[type=range] { width: 100%; margin: 15px 0; accent-color: var(--primary); cursor: pointer; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; color: #ccc; }
        .toggle-switch { width: 40px; height: 20px; background: #555; border-radius: 10px; position: relative; cursor: pointer; }
        .toggle-switch.on { background: var(--primary); }
        .toggle-knob { width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; }
        .toggle-switch.on .toggle-knob { left: 22px; }

        /* –õ–ò–î–ï–†–ë–û–†–î */
        .leaderboard-box { background: rgba(0,0,0,0.3); width: 100%; max-height: 35vh; overflow-y: auto; border-radius: 16px; margin: 15px 0; }
        .leader-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .leader-name { font-size: 14px; font-weight: bold; display: block; color: #eee; text-align: left; }
        .leader-date { font-size: 10px; color: #888; display: block; margin-top: 3px; text-align: left; }
        .leader-score { font-size: 18px; font-weight: bold; color: #fff; }
        .leader-row:nth-child(1) .leader-name, .leader-row:nth-child(1) .leader-score { color: var(--accent); }

        .shield-icon { font-size: 10px; color: #00ff88; margin-bottom: 10px; border: 1px solid #00ff88; padding: 4px 8px; border-radius: 20px; align-self: flex-start; margin-top: 10px; }
        .legal-checkbox-area { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px; width: 90%; max-width: 300px; text-align: left; font-size: 11px; color: #aaa; }
        .legal-link { color: var(--primary); text-decoration: underline; cursor: pointer; }

        /* –ú–ê–ì–ê–ó–ò–ù –°–ö–ò–ù–û–í */
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; }
        .skin-card { background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 10px; padding: 10px; cursor: pointer; position: relative; opacity: 0.5; }
        .skin-card.unlocked { opacity: 1; border-color: #666; }
        .skin-card.active-skin { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .skin-color { width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 5px; }
        .skin-name { font-size: 12px; font-weight: bold; }
        .lock-icon { font-size: 20px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; }

        /* –û–ö–ù–ê */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 20px; border: 2px solid var(--primary); text-align: center; width: 85%; max-width: 320px; max-height: 80vh; overflow-y: auto; }

        .career-box { margin-bottom: 20px; padding: 10px; border-top: 1px solid #333; border-bottom: 1px solid #333; width: 100%; }
        .career-text { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .career-num { font-size: 24px; color: #fff; font-weight: 900; }
        .rank-badge { font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 5px; text-transform: uppercase; }
        
        .confetti { position: absolute; width: 10px; height: 10px; animation: fall linear forwards; z-index: 100; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        
        /* –í–∫–ª–∞–¥–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ */
        .leader-tabs { display: flex; width: 100%; margin-bottom: 10px; border-bottom: 1px solid #444; }
        .leader-tab { flex: 1; padding: 10px; font-size: 10px; font-weight: bold; color: #666; cursor: pointer; }
        .leader-tab.active-tab { color: #ff0055; border-bottom: 2px solid #ff0055; }
        .leader-tab.survival-tab.active-tab { color: #ffcc00; border-bottom: 2px solid #ffcc00; }
        .leader-tab.rhythm-tab.active-tab { color: #00ff88; border-bottom: 2px solid #00ff88; }
    </style>
</head>
<body>

    <!-- –û–ö–ù–û –û–¢–ó–´–í–ê -->
    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div style="font-size: 24px; margin-bottom: 10px;">üéâ –ù–û–í–´–ô –†–ï–ö–û–†–î!</div>
            <div style="color: #ccc; font-size: 14px; margin-bottom: 20px;">
                –¢—ã –º–∞—à–∏–Ω–∞! ü§ñ<br>–ü–æ–º–æ–≥–∏ –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ ‚Äî –æ—Å—Ç–∞–≤—å –æ—Ç–∑—ã–≤.
            </div>
            <p style="font-size:12px; color:#888; margin-bottom:5px;">–í–´–ë–ï–†–ò –°–í–û–ô –ù–ê–ë–û–†:</p>
            <button onclick="openReviewLink(WB_URL_SINGLE)" style="background: var(--accent); color: #000; margin-bottom: 10px;">‚≠êÔ∏è –ú–Ø–ß 60–≥—Ä (1—à—Ç)</button>
            <button onclick="openReviewLink(WB_URL_SET)" style="background: var(--accent); color: #000; margin-bottom: 10px;">‚≠êÔ∏è –ù–ê–ë–û–† (3—à—Ç)</button>
            <button onclick="document.getElementById('reviewModal').style.display='none'" style="background: transparent; border: 1px solid #555;">–ü–û–ó–ñ–ï</button>
        </div>
    </div>

    <!-- –û–ö–ù–û –¢–ï–ú (–ú–ê–ì–ê–ó–ò–ù) -->
    <div id="skinsModal" class="modal-overlay">
        <div class="modal-content" style="border-color: #fff;">
            <h3>üé® –í–´–ë–ï–†–ò –°–¢–ò–õ–¨</h3>
            <p style="font-size:12px; color:#888;">–ù–∞–±–∏–≤–∞–π —É–¥–∞—Ä—ã, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–µ —Ü–≤–µ—Ç–∞!</p>
            <div class="skins-grid" id="skinsGrid"></div>
            <button onclick="document.getElementById('skinsModal').style.display='none'" style="margin-top:15px; background: #333;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <!-- 1. –í–•–û–î -->
    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px; margin-bottom: 5px;">BOXBALL</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 20px;">FINAL VERSION</p>
        
        <div class="career-box">
            <div class="career-text">–í—Å–µ–≥–æ —É–¥–∞—Ä–æ–≤</div>
            <div class="career-num" id="totalHitsLogin">0</div>
        </div>

        <input type="text" id="passInput" placeholder="4 –¶–ò–§–†–´ –ü–û–î –®–¢–†–ò–•–ö–û–î–û–ú" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:16px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò –í –ò–ì–†–£</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px; font-size:12px;">–ö–æ–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç. –ü–æ–ø—Ä–æ–±—É–π 6433, 0309 –∏–ª–∏ 5528</p>
        
        <div style="position: absolute; bottom: 10px; font-size: 9px; color: #444; width: 100%; text-align: center;">
            ¬© 2026 BOXBALL RUSSIA. –í–°–ï –ü–†–ê–í–ê –ó–ê–©–ò–©–ï–ù–´.
        </div>
    </div>

    <!-- 2. –ò–ì–†–ê -->
    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" id="btnSprint" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn" id="btnSurvival" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
            <button class="mode-btn" id="btnRhythm" onclick="setMode('rhythm')">üéµ –†–ò–¢–ú</button>
        </div>

        <div style="display:flex; justify-content:space-between; width:90%; align-items: center; margin-bottom: 5px;">
            <div style="background:rgba(255,255,255,0.1); padding:8px 25px; border-radius:20px; font-weight:bold; color:#fff; font-size: 42px; min-width: 110px;" id="timer">60</div>
            <div style="display:flex; flex-direction:column; align-items:flex-end;">
                <div class="shield-icon" style="margin:0 0 5px 0;">üõ°Ô∏è ANTI-CHEAT</div>
                <div style="font-size:12px; color:#aaa; cursor:pointer; border-bottom:1px dashed #555;" onclick="toggleSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –ù–ê–°–¢–†–û–ï–ö -->
        <div class="settings-panel" id="settingsPanel">
            <h3 style="margin-top:0; font-size:14px; margin-bottom:15px;">–ù–ê–°–¢–†–û–ô–ö–ò</h3>
            
            <div class="toggle-row">
                <span>üîä –ó–≤—É–∫</span>
                <div class="toggle-switch on" id="togSound" onclick="toggleOption('sound')"><div class="toggle-knob"></div></div>
            </div>

            <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">

            <label style="font-size:12px; color:#ccc;">–ü–æ—Ä–æ–≥ —É–¥–∞—Ä–∞: <span id="sensVal">20</span></label>
            <input type="range" id="sensRange" min="5" max="100" value="20" oninput="updateSens(this.value)">
            
            <button onclick="setRecommended()" style="background: #333; border: 1px solid #00ff88; color: #00ff88; padding: 10px; font-size: 12px; width: 100%; margin-bottom: 5px;">‚úÖ –°–±—Ä–æ—Å–∏—Ç—å (20)</button>
            
            <button onclick="openSkins()" style="background: linear-gradient(45deg, #FFD700, #DAA520); color: black; margin-bottom: 5px;">üé® –¢–ï–ú–´ / –°–ö–ò–ù–´</button>
            
            <button onclick="logout()" style="background: #220000; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 10px; font-size: 12px; margin-bottom: 5px;">üö™ –í—ã–π—Ç–∏</button>
            <button onclick="toggleSettings()" style="margin-top:5px; padding:10px; font-size:12px; background:#222; border:1px solid #444;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
        
        <div class="score-circle" id="scoreDisplay">0</div>
        
        <!-- –í–ò–ó–£–ê–õ–ò–ó–ê–¢–û–† –ì–†–û–ú–ö–û–°–¢–ò -->
        <div class="volume-meter">
            <div class="volume-bar" id="micLevel"></div>
            <div class="volume-threshold" id="micThresh"></div>
        </div>
        
        <div style="color:#666; font-size:12px; margin-top:5px; margin-bottom:10px;" id="modeHint">–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö</div>

        <button id="startBtn">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
        <button onclick="showLeaderboard(true)" class="secondary-btn">üèÜ –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</button>
    </div>

    <!-- 3. –†–ï–ó–£–õ–¨–¢–ê–¢ -->
    <div id="screen-save" class="screen">
        <div style="font-size:14px; color:#aaa;">–í–ê–® –†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <div class="rank-badge" id="rankDisplay">–ù–û–í–ò–ß–û–ö</div>
        <h1 style="font-size:80px; margin:0; color:var(--primary);" id="finalScore">0</h1>
        <div style="font-size:12px; color:var(--accent); font-weight:bold; margin-bottom:10px;" id="recordMsg"></div>

        <div style="display:flex; gap:15px; justify-content:center; margin-bottom:15px;">
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:5px;">üî• <span id="resCalories">0</span> –ö–ö–ê–õ</div>
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:5px;">üéÆ <span id="resMode">–°–ü–†–ò–ù–¢</span></div>
        </div>
        
        <input type="text" id="nicknameInput" placeholder="–í–∞—à–µ –ò–º—è" maxlength="15" style="padding:14px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; width:80%; margin-bottom: 10px;">
        
        <div class="legal-checkbox-area">
            <input type="checkbox" id="legalCheck" onchange="toggleSaveBtn()">
            <label for="legalCheck">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ <span class="legal-link" onclick="openPolicy()">–æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö</span></label>
        </div>

        <button id="saveBtn" onclick="saveScore()" disabled>–°–û–•–†–ê–ù–ò–¢–¨ –í –¢–û–ü</button>
    </div>

    <!-- 4. –õ–ò–î–ï–†–´ -->
    <div id="screen-leaders" class="screen">
        <h3>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div class="leader-tabs">
            <div class="leader-tab active-tab" id="tabSprint" onclick="switchLeaderTab('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</div>
            <div class="leader-tab" id="tabSurvival" onclick="switchLeaderTab('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</div>
            <div class="leader-tab" id="tabRhythm" onclick="switchLeaderTab('rhythm')">üéµ –†–ò–¢–ú</div>
        </div>
        <div class="leaderboard-box" id="leaderList"><div style="padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
        <button id="leaderBackBtn" onclick="location.reload()" style="background: #333;">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <script>
        const MIN_HIT_DELAY = 140; 
        let SENSITIVITY = 20; 
        let score = 0, isRunning = false, lastHitTime = 0;
        let currentMode = 'sprint'; 
        let timeLeft = 60.0;
        let audioCtx;
        const synth = window.speechSynthesis;
        let timerInterval;
        let metronomeInterval;
        let totalHits = 0;
        let personalBest = 0;
        let isClipping = false; // –î–ª—è —Ç—Ä–∏–≥–≥–µ—Ä–∞ –®–º–∏—Ç—Ç–∞
        
        // –ù–ê–°–¢–†–û–ô–ö–ò
        let isSoundOn = true;
        let currentTheme = 'default';

        // –¢–ï–ú–´
        const THEMES = {
            'default': { name: '–ù–µ–æ–Ω (–°—Ç–∞–Ω–¥–∞—Ä—Ç)', color: '#ff0055', bg1: '#1a0b0b', bg2: '#000000', cost: 0 },
            'cyber': { name: '–ö–∏–±–µ—Ä (500 —É–¥.)', color: '#00ccff', bg1: '#0b1a1a', bg2: '#000000', cost: 500 },
            'toxic': { name: '–¢–æ–∫—Å–∏–∫ (1–∫ —É–¥.)', color: '#00ff88', bg1: '#0b1a0b', bg2: '#000000', cost: 1000 },
            'gold': { name: '–≠–õ–ò–¢–ê (5–∫ —É–¥.)', color: '#FFD700', bg1: '#1a1500', bg2: '#000000', cost: 5000 }
        };

        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) { window.Telegram.WebApp.expand(); }
            
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) { 
                SENSITIVITY = parseInt(savedSens);
                document.getElementById('sensRange').value = SENSITIVITY;
                updateSensUI(SENSITIVITY);
            } else {
                document.getElementById('sensRange').value = 20;
                updateSensUI(20);
            }

            totalHits = parseInt(localStorage.getItem('box_total_hits')) || 0;
            document.getElementById('totalHitsLogin').innerText = totalHits.toLocaleString();
            personalBest = parseInt(localStorage.getItem('box_pb_sprint')) || 0;
            
            if(localStorage.getItem('box_sound') === 'false') toggleOption('sound');
            
            const savedTheme = localStorage.getItem('box_theme');
            if(savedTheme && THEMES[savedTheme]) applyTheme(savedTheme);

            if (localStorage.getItem('box_auth') === 'true') showScreen('screen-game');
        };

        // --- –¢–ï–ú–´ ---
        function openSkins() {
            const grid = document.getElementById('skinsGrid');
            grid.innerHTML = '';
            for (const [key, theme] of Object.entries(THEMES)) {
                const locked = totalHits < theme.cost;
                const active = currentTheme === key ? 'active-skin' : '';
                const lockIcon = locked ? '<div class="lock-icon">üîí</div>' : '';
                const opacity = locked ? '0.5' : '1';
                grid.innerHTML += `
                <div class="skin-card ${active}" style="opacity:${opacity}" onclick="selectTheme('${key}', ${theme.cost})">
                    <div class="skin-color" style="background:${theme.color}"></div>
                    <div class="skin-name">${theme.name}</div>
                    ${lockIcon}
                </div>`;
            }
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('skinsModal').style.display = 'flex';
        }

        function selectTheme(key, cost) {
            if (totalHits < cost) {
                alert(`–ù—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å ${cost} —É–¥–∞—Ä–æ–≤! –£ —Ç–µ–±—è –ø–æ–∫–∞ ${totalHits}.`);
                return;
            }
            applyTheme(key);
            document.getElementById('skinsModal').style.display = 'none';
        }

        function applyTheme(key) {
            currentTheme = key;
            localStorage.setItem('box_theme', key);
            const t = THEMES[key];
            const root = document.documentElement;
            root.style.setProperty('--primary', t.color);
            root.style.setProperty('--bg-grad-start', t.bg1);
            root.style.setProperty('--bg-grad-end', t.bg2);
        }

        // --- –ù–ê–°–¢–†–û–ô–ö–ò ---
        function toggleOption(opt) {
            const el = document.getElementById('togSound');
            const isOn = el.classList.contains('on');
            if(isOn) {
                el.classList.remove('on');
                isSoundOn = false;
            } else {
                el.classList.add('on');
                isSoundOn = true;
            }
            localStorage.setItem('box_sound', !isOn);
        }

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        
        function checkCode() { 
            const val = document.getElementById('passInput').value.trim();
            if(VALID_CODES.includes(val)) { 
                localStorage.setItem('box_auth', 'true'); 
                showScreen('screen-game'); 
            } 
            else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        
        function logout() { localStorage.removeItem('box_auth'); location.reload(); }
        function toggleSaveBtn() { document.getElementById('saveBtn').disabled = !document.getElementById('legalCheck').checked; }
        function openPolicy() { window.Telegram.WebApp.openLink(POLICY_URL); }
        function toggleSettings() { const el = document.getElementById('settingsPanel'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
        
        // –§–£–ù–ö–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ë–ï–ó –ë–õ–û–ö–ò–†–û–í–ö–ò –ü–û–õ–ó–£–ù–ö–ê
        function updateSens(val) { 
            SENSITIVITY = parseInt(val); 
            updateSensUI(SENSITIVITY);
            localStorage.setItem('box_sens', SENSITIVITY); 
        }

        function updateSensUI(val) {
            document.getElementById('sensVal').innerText = val; 
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Ä–æ–≥ –Ω–∞ –ø–æ–ª–æ—Å–∫–µ
            const percent = Math.min(val, 100);
            const thresh = document.getElementById('micThresh');
            if(thresh) thresh.style.left = percent + "%";
        }
        
        function setRecommended() { 
            document.getElementById('sensRange').value = 20;
            updateSens(20); 
        }
        function openChannel() { window.Telegram.WebApp.openTelegramLink(CHANNEL_URL); }
        
        function openReviewLink(url) { 
            window.Telegram.WebApp.openLink(url); 
            document.getElementById('reviewModal').style.display = 'none'; 
        }
        
        function speak(text) { 
            if (!isSoundOn || synth.speaking) return; 
            const u = new SpeechSynthesisUtterance(text); u.lang = 'ru-RU'; u.rate = 1.2; synth.speak(u); 
        }

        function setMode(mode) {
            if(isRunning) return;
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.className = 'mode-btn');
            
            if(mode === 'sprint') {
                document.getElementById('btnSprint').className += ' active-mode';
                document.getElementById('timer').innerText = "60";
                document.getElementById('modeHint').innerText = "–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö";
                document.getElementById('timer').style.color = "#fff";
            } else if (mode === 'survival') {
                document.getElementById('btnSurvival').className += ' active-mode';
                document.getElementById('timer').innerText = "10";
                document.getElementById('modeHint').innerText = "–£–°–ö–û–†–Ø–ô–°–Ø, –ß–¢–û–ë–´ –í–´–ñ–ò–¢–¨!";
                document.getElementById('timer').style.color = "#ffcc00";
            } else if (mode === 'rhythm') {
                document.getElementById('btnRhythm').className += ' active-mode';
                document.getElementById('timer').innerText = "60";
                document.getElementById('modeHint').innerText = "–ë–ï–ô –í –¢–ê–ö–¢ –ú–ï–¢–†–û–ù–û–ú–ê";
                document.getElementById('timer').style.color = "#00ff88";
            }
        }

        function playSound(type) {
            if (!isSoundOn) return;
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if (type === 'hit') {
                osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime+0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
            } else if (type === 'tick') {
                osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.05);
                osc.type = 'square'; osc.start(); osc.stop(audioCtx.currentTime+0.05);
            } else {
                osc.frequency.value = 200; gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1.5);
                osc.start(); osc.stop(audioCtx.currentTime+1.5);
            }
        }

        function launchConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + 'vw';
                c.style.background = colors[Math.floor(Math.random()*colors.length)];
                c.style.animationDuration = (Math.random()*2+2) + 's';
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 4000);
            }
        }

        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', async () => {
            if(isRunning) return;
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const analyser = audioCtx.createAnalyser(); const mic = audioCtx.createMediaStreamSource(stream); const script = audioCtx.createScriptProcessor(2048, 1, 1);
                const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0.0;
                mic.connect(analyser); analyser.connect(script); script.connect(zeroGain); zeroGain.connect(audioCtx.destination);
                
                startBtn.style.display = 'none'; document.getElementById('settingsPanel').style.display = 'none';
                document.querySelector('.mode-selector').style.opacity = '0.3';
                document.querySelector('.secondary-btn').style.display = 'none'; 
                
                isRunning = true; score = 0; document.getElementById('scoreDisplay').innerText = 0; 
                timeLeft = (currentMode === 'survival') ? 10 : 60;
                document.getElementById('timer').innerText = timeLeft;
                isClipping = false; // –°–±—Ä–æ—Å —Ç—Ä–∏–≥–≥–µ—Ä–∞

                if (timerInterval) clearInterval(timerInterval);
                if (metronomeInterval) clearInterval(metronomeInterval);

                if(currentMode === 'rhythm') {
                    playSound('tick');
                    metronomeInterval = setInterval(() => { if(isRunning) playSound('tick'); }, 600);
                }

                timerInterval = setInterval(() => { 
                    timeLeft -= 1; document.getElementById('timer').innerText = Math.floor(timeLeft); 
                    if(timeLeft <= 0) { 
                        clearInterval(timerInterval); if(metronomeInterval) clearInterval(metronomeInterval);
                        isRunning = false; finishGame(); 
                    } 
                }, 1000);

                script.onaudioprocess = function() {
                    if(!isRunning) return;
                    const arr = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(arr);
                    let v = 0; for(let i=0; i<arr.length; i++) v+=arr[i];
                    let avg = v/arr.length;
                    
                    // –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø
                    const barW = Math.min(avg * 2, 100);
                    const barEl = document.getElementById('micLevel');
                    barEl.style.width = barW + "%";

                    // –ê–õ–ì–û–†–ò–¢–ú (–¢–†–ò–ì–ì–ï–† –®–ú–ò–¢–¢–ê)
                    if (!isClipping) {
                        // –ü–æ–ª–æ—Å–∫–∞ –∑–µ–ª–µ–Ω–∞—è - –ì–û–¢–û–í
                        barEl.classList.remove('locked');
                        
                        // –ñ–¥–µ–º —É–¥–∞—Ä–∞
                        if (avg > SENSITIVITY) {
                            // –£–î–ê–†!
                            const now = Date.now();
                            if(now - lastHitTime > MIN_HIT_DELAY) {
                                score++; registerHitVisual();
                                lastHitTime = now;
                                isClipping = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º
                            }
                        }
                    } else {
                        // –ü–æ–ª–æ—Å–∫–∞ –∫—Ä–∞—Å–Ω–∞—è - –ë–õ–û–ö (–ñ–î–ï–ú –¢–ò–®–ò–ù–´)
                        barEl.classList.add('locked');
                        
                        // –ñ–¥–µ–º –ø–∞–¥–µ–Ω–∏—è –≥—Ä–æ–º–∫–æ—Å—Ç–∏ –¥–æ 75% –æ—Ç –ø–æ—Ä–æ–≥–∞ (–ë–´–°–¢–†–ê–Ø –ü–ï–†–ï–ó–ê–†–Ø–î–ö–ê)
                        if (avg < (SENSITIVITY * 0.75)) {
                            isClipping = false; // –°–Ω–æ–≤–∞ –≥–æ—Ç–æ–≤
                        }
                    }
                }
            } catch(e) { alert("–û—à–∏–±–∫–∞: –†–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω!"); }
        });

        function registerHitVisual() {
            const el = document.getElementById('scoreDisplay'); el.innerText = score; 
            el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'), 300);

            if (currentMode === 'survival') {
                el.classList.add('hit-survival');
                let bonus = 1.0; if (score > 20) bonus = 0.5; if (score > 50) bonus = 0.25;
                timeLeft += bonus; if (timeLeft > 10) timeLeft = 10;
                document.getElementById('timer').innerText = Math.floor(timeLeft);
            } else { 
                el.classList.add('hit'); 
            }
            
            setTimeout(()=>el.className = 'score-circle', 100);
            playSound('hit'); 
        }

        function finishGame() { 
            isRunning = false; playSound('end'); launchConfetti();
            
            const cals = Math.floor(score * 0.05); 
            let rank = "–ù–û–í–ò–ß–û–ö";
            if(score > 30) rank = "–õ–Æ–ë–ò–¢–ï–õ–¨";
            if(score > 60) rank = "–ë–û–ï–¶";
            if(score > 100) rank = "–ú–ê–®–ò–ù–ê";
            if(score > 150) rank = "–õ–ï–ì–ï–ù–î–ê";

            totalHits += score;
            localStorage.setItem('box_total_hits', totalHits);

            document.getElementById('finalScore').innerText = score; 
            document.getElementById('resCalories').innerText = cals;
            document.getElementById('resMode').innerText = currentMode.toUpperCase();
            document.getElementById('rankDisplay').innerText = rank;
            
            personalBest = parseInt(localStorage.getItem('box_pb_' + currentMode)) || 0;
            if (score > personalBest && score > 10) {
                localStorage.setItem('box_pb_' + currentMode, score);
                document.getElementById('recordMsg').innerText = "üèÜ –ù–û–í–´–ô –õ–ò–ß–ù–´–ô –†–ï–ö–û–†–î!";
                document.getElementById('reviewModal').style.display = 'flex';
            } else {
                document.getElementById('recordMsg').innerText = "";
            }

            document.querySelector('.mode-selector').style.opacity = '1';
            document.getElementById('legalCheck').checked = false;
            toggleSaveBtn(); 
            showScreen('screen-save'); 
        }
        
        function saveScore() {
            const name = document.getElementById('nicknameInput').value.trim() || "–ê–Ω–æ–Ω–∏–º";
            const btn = document.querySelector('#screen-save button');
            if(name.length < 2) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê..."; btn.disabled = true;
            fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: name, score: score, mode: currentMode, date: new Date().toLocaleDateString() }) }).then(() => showLeaderboard(false, currentMode)).catch(() => showLeaderboard(false, currentMode));
        }

        function switchLeaderTab(mode) {
            document.querySelectorAll('.leader-tab').forEach(t => t.className = 'leader-tab');
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active-tab');
            fetchLeaderboardData(mode);
        }

        function showLeaderboard(fromMenu = false, initialMode = 'sprint') {
            showScreen('screen-leaders');
            const backBtn = document.getElementById('leaderBackBtn');
            if(fromMenu) {
                backBtn.innerText = "–ù–ê–ó–ê–î –í –ú–ï–ù–Æ";
                backBtn.onclick = function() { showScreen('screen-game'); };
            } else {
                backBtn.innerText = "–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê";
                backBtn.onclick = function() { location.reload(); };
            }
            switchLeaderTab(initialMode);
        }

        function fetchLeaderboardData(mode) {
            const list = document.getElementById('leaderList'); 
            list.innerHTML = "<div style='padding:20px'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";
            fetch(GOOGLE_SCRIPT_URL + "?mode=" + mode)
            .then(r=>r.json())
            .then(data => {
                list.innerHTML = "";
                if(!data.length) list.innerHTML = "<div style='padding:20px'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>";
                data.forEach((row, i) => {
                    let dateStr = row.date ? row.date : ''; 
                    list.innerHTML += `
                    <div class="leader-row">
                        <div class="leader-left">
                            <span class="leader-name">#${i+1} ${row.name}</span>
                            <span class="leader-date">${dateStr}</span>
                        </div>
                        <span class="leader-score">${row.score}</span>
                    </div>`;
                });
            });
        }
        
        function launchConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + 'vw';
                c.style.background = colors[Math.floor(Math.random()*colors.length)];
                c.style.animationDuration = (Math.random()*2+2) + 's';
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 4000);
            }
        }
    </script>
</body>
</html>
