<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Russia (iOS Fix)</title>
    
    <script>
        const GOOGLE_SCRIPT_URL = "–í–°–¢–ê–í–¨–¢–ï_–°–Æ–î–ê_–í–ê–®–£_–°–°–´–õ–ö–£"; 
        const POLICY_URL = "https://docs.google.com/document/d/–í–ê–®–ê_–°–°–´–õ–ö–ê";
        const WB_URL_SINGLE = "https://www.wildberries.ru/catalog/176733207/detail.aspx"; 
        const WB_URL_SET = "https://www.wildberries.ru/catalog/237586968/detail.aspx";     
        const VALID_CODES = ["6433", "0309", "5528"];
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #ff0055;
            --accent: #ffcc00;
            --bg-grad-start: #1a0b0b;
            --bg-grad-end: #000000;
            --text-color: white;
        }

        body {
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: var(--text-color); display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        /* –ò–ì–†–û–í–û–ô –ö–†–£–ì */
        .score-circle {
            width: 200px; height: 200px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 80px; font-weight: 900; margin: 10px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: border-color 0.1s; position: relative; z-index: 2;
        }
        
        /* DEBUG INFO */
        .debug-info {
            font-family: monospace; font-size: 10px; color: #00ff88; 
            background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px;
            margin-top: 10px; border: 1px solid #004422; width: 90%;
            display: flex; justify-content: space-around;
        }
        
        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
        .volume-meter {
            width: 240px; height: 12px; background: #222; border-radius: 6px; margin-top: 10px;
            position: relative; overflow: hidden; border: 1px solid #444;
        }
        .volume-bar { height: 100%; background: #00ff88; width: 0%; transition: width 0.05s; }
        .volume-threshold {
            position: absolute; top: 0; bottom: 0; width: 3px; background: #ff0055; z-index: 5;
            left: 0%; box-shadow: 0 0 5px #ff0055; opacity: 0.8; transition: left 0.2s;
        }
        
        @keyframes shake-anim {
            0% { transform: translate(1px, 1px); } 25% { transform: translate(-2px, -2px); }
            50% { transform: translate(2px, 0px); } 75% { transform: translate(-1px, 2px); } 100% { transform: translate(0, 0); }
        }
        .shake { animation: shake-anim 0.1s; }
        .hit { border-color: var(--primary); box-shadow: 0 0 40px var(--primary); color: var(--primary); }

        button {
            padding: 16px 0; font-size: 16px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 5;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; }
        button.secondary-btn { background: transparent; border: 1px solid #444; color: #aaa; box-shadow: none; font-size: 14px; margin-top: 15px; padding: 12px; }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-panel { background: rgba(20,20,20,0.98); border: 1px solid #444; padding: 20px; border-radius: 16px; width: 90%; max-width: 320px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: none; z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.9); }
        
        .control-group { margin-bottom: 15px; text-align: left; }
        .control-label { font-size: 12px; color: #aaa; display: flex; justify-content: space-between; margin-bottom: 5px; }
        .control-val { color: #fff; font-weight: bold; }
        input[type=range] { width: 100%; margin: 5px 0; accent-color: var(--primary); cursor: pointer; height: 6px; background: #333; border-radius: 3px; appearance: none; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 16px; height: 16px; background: white; border-radius: 50%; }

        /* Other UI */
        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; width: 95%; max-width: 340px; }
        .mode-btn { flex: 1; padding: 10px 5px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #aaa; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .mode-btn.active-mode { background: var(--primary); color: white; border-color: var(--primary); }

        /* Toasts & Modals */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 12px; border: 1px solid #00ff88; z-index: 150; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .toast.show { opacity: 1; }
        
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 20px; border: 2px solid var(--primary); text-align: center; width: 85%; max-width: 320px; }

        /* Leaderboard */
        .leaderboard-box { background: rgba(0,0,0,0.3); width: 100%; max-height: 40vh; overflow-y: auto; border-radius: 16px; margin: 15px 0; }
        .leader-row { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid #333; }
    </style>
</head>
<body>

    <div id="toast" class="toast">üì¢ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–∫—Ä—ã—Ç—ã! –ü–æ–¥–∫—Ä—É—Ç–∏ —É—Å–∏–ª–µ–Ω–∏–µ.</div>

    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px; margin-bottom: 5px;">BOXBALL</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 20px;">iOS GAIN FIX EDITION</p>
        <input type="text" id="passInput" placeholder="–ö–û–î –ò–ó –ö–û–†–û–ë–ö–ò" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:16px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px; font-size:12px;">–ö–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π.</p>
    </div>

    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" id="btnSprint" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn" id="btnSurvival" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
        </div>

        <div style="display:flex; justify-content:space-between; width:90%; align-items: center; margin-bottom: 5px;">
            <div style="background:rgba(255,255,255,0.1); padding:8px 25px; border-radius:20px; font-weight:bold; color:#fff; font-size: 42px; min-width: 100px;" id="timer">60</div>
            <div style="display:flex; flex-direction:column; align-items:flex-end;">
                <div style="font-size:12px; color:#aaa; cursor:pointer; border-bottom:1px dashed #555;" onclick="toggleSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
        </div>
        
        <div class="settings-panel" id="settingsPanel">
            <h3 style="margin-top:0; font-size:14px; margin-bottom:15px;">–ù–ê–°–¢–†–û–ô–ö–ò –ê–£–î–ò–û</h3>
            
            <div class="control-group">
                <div class="control-label">üöÄ –£–°–ò–õ–ï–ù–ò–ï (PRE-AMP) <span id="gainVal" class="control-val">5x</span></div>
                <input type="range" id="gainRange" min="1" max="20" step="1" value="5" oninput="updateAudioSettings()">
                <div style="font-size:10px; color:#666; margin-top:2px;">–ï—Å–ª–∏ iPhone –Ω–µ —Å–ª—ã—à–∏—Ç ‚Äî —Å—Ç–∞–≤—å 10x-20x</div>
            </div>

            <div class="control-group">
                <div class="control-label">üéØ –ü–û–†–û–ì –°–†–ê–ë–ê–¢–´–í–ê–ù–ò–Ø <span id="sensVal" class="control-val">15dB</span></div>
                <input type="range" id="sensRange" min="5" max="40" value="15" oninput="updateAudioSettings()">
                <div style="font-size:10px; color:#666; margin-top:2px;">–†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É —à—É–º–æ–º –∏ —É–¥–∞—Ä–æ–º</div>
            </div>

            <hr style="border:0; border-top:1px solid #444; margin: 15px 0;">
            <button onclick="toggleSettings()" style="padding:10px; font-size:12px; background:#333;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
        
        <div class="score-circle" id="scoreDisplay">0</div>
        
        <div class="debug-info" id="debugLine">Waiting for start...</div>

        <div class="volume-meter">
            <div class="volume-bar" id="micLevel"></div>
            <div class="volume-threshold" id="micThresh"></div>
        </div>
        
        <div style="color:#666; font-size:12px; margin-top:10px;" id="modeHint">–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö</div>

        <button id="startBtn">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
    </div>

    <div id="screen-save" class="screen">
        <div style="font-size:14px; color:#aaa;">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h1 style="font-size:80px; margin:0; color:var(--primary);" id="finalScore">0</h1>
        
        <input type="text" id="nicknameInput" placeholder="–í–ê–®–ï –ò–ú–Ø" style="padding:14px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; width:80%; margin: 15px 0;">
        <button id="saveBtn" onclick="saveScore()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button onclick="location.reload()" class="secondary-btn">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <div id="screen-leaders" class="screen">
        <h3>–¢–û–ü –ò–ì–†–û–ö–û–í</h3>
        <div class="leaderboard-box" id="leaderList"></div>
        <button onclick="location.reload()" style="background: #333;">–ù–ê–ó–ê–î</button>
    </div>

    <script>
        // --- CONFIG ---
        const HIT_DELAY_MS = 200; // –ñ–¥–µ–º 200–º—Å –ø–æ—Å–ª–µ —É–¥–∞—Ä–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç —ç—Ö–∞)
        
        // --- STATE ---
        let audioCtx, analyser, gainNode;
        let isRunning = false;
        let score = 0;
        let timeLeft = 60;
        let currentMode = 'sprint';
        
        // --- AUDIO VARS ---
        let noiseFloor = -80; // dB
        let lastHitTime = 0;
        
        // Settings defaults
        let SETTING_GAIN = 5; // Pre-amp gain
        let SETTING_SENS = 15; // Threshold delta

        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) { window.Telegram.WebApp.expand(); }
            
            // Load Settings
            if(localStorage.getItem('box_gain')) SETTING_GAIN = parseInt(localStorage.getItem('box_gain'));
            if(localStorage.getItem('box_sens')) SETTING_SENS = parseInt(localStorage.getItem('box_sens'));
            
            updateUIControls();

            if (localStorage.getItem('box_auth') === 'true') {
                showScreen('screen-game');
            }
        };

        function updateUIControls() {
            document.getElementById('gainRange').value = SETTING_GAIN;
            document.getElementById('gainVal').innerText = SETTING_GAIN + "x";
            
            document.getElementById('sensRange').value = SETTING_SENS;
            document.getElementById('sensVal').innerText = SETTING_SENS + "dB";
            
            // –ï—Å–ª–∏ –∏–≥—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º GainNode –Ω–∞ –ª–µ—Ç—É
            if(gainNode) gainNode.gain.setTargetAtTime(SETTING_GAIN, audioCtx.currentTime, 0.1);
        }

        function updateAudioSettings() {
            SETTING_GAIN = parseInt(document.getElementById('gainRange').value);
            SETTING_SENS = parseInt(document.getElementById('sensRange').value);
            localStorage.setItem('box_gain', SETTING_GAIN);
            localStorage.setItem('box_sens', SETTING_SENS);
            updateUIControls();
        }

        // --- CORE AUDIO ENGINE ---
        async function startAudioEngine() {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();

                // 1. Get Mic Stream (Raw)
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        autoGainControl: false, // Try to disable system AGC
                        noiseSuppression: false,
                        latency: 0
                    }
                });

                const source = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.smoothingTimeConstant = 0.1; // Fast reaction
                analyser.fftSize = 512;

                // 2. Create Chain Nodes
                const highPass = audioCtx.createBiquadFilter();
                highPass.type = 'highpass'; highPass.frequency.value = 300;

                const lowPass = audioCtx.createBiquadFilter();
                lowPass.type = 'lowpass'; lowPass.frequency.value = 1200;

                gainNode = audioCtx.createGain(); // üöÄ THE BOOSTER
                gainNode.gain.value = SETTING_GAIN;

                // 3. Connect: Source -> HP -> LP -> GAIN -> Analyser
                source.connect(highPass);
                highPass.connect(lowPass);
                lowPass.connect(gainNode);
                gainNode.connect(analyser);

                processLoop();

            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + e.message);
            }
        }

        function processLoop() {
            if(!isRunning) return;
            requestAnimationFrame(processLoop);

            const bufferLength = analyser.frequencyBinCount;
            const data = new Uint8Array(bufferLength);
            analyser.getByteTimeDomainData(data);

            // 1. Calculate RMS
            let sum = 0;
            for(let i = 0; i < bufferLength; i++) {
                let x = (data[i] - 128) / 128.0;
                sum += x * x;
            }
            let rms = Math.sqrt(sum / bufferLength);

            // 2. Convert to Decibels (dB)
            // Add epsilon to avoid log(0) = -Infinity
            let db = 20 * Math.log10(rms + 0.0000001); 

            // 3. Dynamic Noise Floor
            // logic: Drop fast to noise, Rise VERY slow to hits
            if (db < noiseFloor) {
                noiseFloor = noiseFloor * 0.90 + db * 0.10; // Fall fast
            } else {
                noiseFloor = noiseFloor * 0.999 + db * 0.001; // Rise extremely slow
            }

            // 4. Hit Detection Logic
            const threshold = noiseFloor + SETTING_SENS;
            const now = Date.now();
            const isHold = (now - lastHitTime < HIT_DELAY_MS); // Debounce check

            let isHit = false;
            if (db > threshold && !isHold) {
                isHit = true;
                lastHitTime = now;
                registerHit();
            }

            // 5. Update Debug Info (Realtime)
            const diff = (db - noiseFloor).toFixed(1);
            const dbStr = db.toFixed(1);
            const thrStr = threshold.toFixed(1);
            
            // Visual Debug Line
            const debugEl = document.getElementById('debugLine');
            debugEl.innerHTML = `Sig: ${dbStr} | Thr: ${thrStr} | <span style="color:${isHit?'#fff':'#888'}">Diff: ${diff}</span>`;
            if(isHit) debugEl.style.background = "var(--primary)";
            else debugEl.style.background = "rgba(0,0,0,0.5)";

            // 6. Visual Bar (Normalized -60db to 0db)
            let visPct = (db + 60) * 2; 
            if(visPct<0) visPct=0; if(visPct>100) visPct=100;
            document.getElementById('micLevel').style.width = visPct + "%";
            
            // Threshold marker visual
            let thrPct = (threshold + 60) * 2;
            document.getElementById('micThresh').style.left = thrPct + "%";
        }

        function registerHit() {
            score++;
            const el = document.getElementById('scoreDisplay');
            el.innerText = score;
            el.classList.add('shake');
            el.classList.add('hit');
            setTimeout(() => {
                el.classList.remove('shake'); 
                el.classList.remove('hit');
            }, 150);

            // Survival Mode Logic
            if(currentMode === 'survival') {
                timeLeft += 0.5; if(timeLeft > 10) timeLeft = 10;
                document.getElementById('timer').innerText = Math.floor(timeLeft);
            }
            
            playSound();
        }

        function playSound() {
            // Simple Beep
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g); g.connect(audioCtx.destination);
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
            g.gain.setValueAtTime(0.3, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }

        // --- GAME LOGIC ---
        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', async () => {
            if(isRunning) return;
            await startAudioEngine();
            
            // Hide UI
            startBtn.style.display = 'none';
            document.querySelector('.mode-selector').style.opacity = '0.3';
            
            isRunning = true; 
            score = 0; 
            document.getElementById('scoreDisplay').innerText = 0;
            
            timeLeft = (currentMode === 'survival') ? 10 : 60;
            document.getElementById('timer').innerText = timeLeft;

            const timerInt = setInterval(() => {
                timeLeft -= 1;
                document.getElementById('timer').innerText = Math.floor(timeLeft);
                if(timeLeft <= 0) {
                    clearInterval(timerInt);
                    isRunning = false;
                    finishGame();
                }
            }, 1000);
        });

        function finishGame() {
            showScreen('screen-save');
            document.getElementById('finalScore').innerText = score;
        }

        // --- NAVIGATION & UTILS ---
        function checkCode() {
            if(VALID_CODES.includes(document.getElementById('passInput').value.trim())) {
                localStorage.setItem('box_auth', 'true');
                showScreen('screen-game');
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function toggleSettings() { const s = document.getElementById('settingsPanel'); s.style.display = (s.style.display==='block')?'none':'block'; }
        function setMode(m) { 
            if(isRunning) return; 
            currentMode = m; 
            document.querySelectorAll('.mode-btn').forEach(b => b.className='mode-btn');
            document.getElementById(m==='sprint'?'btnSprint':'btnSurvival').classList.add('active-mode');
            document.getElementById('timer').innerText = (m==='survival')?10:60;
        }
        function saveScore() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê...";
            // Mock Save
            setTimeout(() => { btn.innerText = "–°–û–•–†–ê–ù–ï–ù–û"; setTimeout(()=>location.reload(), 1000); }, 1000);
        }
    </script>
</body>
</html>
