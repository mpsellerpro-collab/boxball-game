<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Test Fix</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #111;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            text-align: center;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top:0; }
        .active { display: flex; }

        .score-circle {
            width: 200px; height: 200px; border-radius: 50%; border: 5px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 80px; font-weight: bold; margin: 20px 0;
            transition: 0.05s;
        }
        .hit { transform: scale(1.1); border-color: #00ff88; color: #00ff88; box-shadow: 0 0 30px #00ff88; }

        button {
            padding: 15px 30px; font-size: 18px; font-weight: bold;
            background: #00ff88; border: none; border-radius: 30px; margin-top: 20px; cursor: pointer;
        }

        /* ПОЛОСКА ГРОМКОСТИ (ИНДИКАТОР) */
        .mic-bar-container {
            width: 80%; height: 20px; background: #333; border-radius: 10px; margin: 10px 0; overflow: hidden; border: 1px solid #555;
        }
        .mic-bar {
            width: 0%; height: 100%; background: linear-gradient(90deg, #00ff88, #ff0055); transition: width 0.05s;
        }

        /* НАСТРОЙКИ */
        .controls {
            background: #222; padding: 15px; border-radius: 15px; width: 80%; margin-bottom: 20px;
        }
        input[type=range] { width: 100%; accent-color: #00ff88; }
    </style>
</head>
<body>

    <!-- ВХОД -->
    <div id="screen-login" class="screen active">
        <h1>BOXBALL</h1>
        <p style="color:#aaa">ВВЕДИ КОД: BOX2025</p>
        <input type="text" id="passInput" placeholder="КОД" style="padding:10px; font-size:16px; text-align:center;">
        <button onclick="checkCode()">ВОЙТИ</button>
    </div>

    <!-- ИГРА -->
    <div id="screen-game" class="screen">
        <div id="timer" style="font-size:20px; color:#aaa;">60s</div>
        
        <div class="score-circle" id="scoreDisplay">0</div>

        <!-- ТЕСТ МИКРОФОНА -->
        <div class="controls">
            <div style="font-size:14px; margin-bottom:5px;">УРОВЕНЬ ШУМА:</div>
            <div class="mic-bar-container">
                <div class="mic-bar" id="micLevel"></div>
            </div>
            
            <div style="font-size:14px; margin-top:15px; margin-bottom:5px;">ЧУВСТВИТЕЛЬНОСТЬ:</div>
            <input type="range" id="sensRange" min="1" max="100" value="20" oninput="updateSens(this.value)">
            <div style="font-size:12px; color:#aaa;">
                Текущая: <span id="sensVal">20</span> 
                (Меньше = чувствительнее)
            </div>
        </div>

        <button id="startBtn">ВКЛЮЧИТЬ МИКРОФОН</button>
        <div id="debugText" style="font-size: 10px; color: #555; margin-top: 10px;">Статус: Ожидание...</div>
    </div>

    <script>
        const SECRET_CODE = "BOX2025";
        let SENSITIVITY = 20;
        let score = 0, isRunning = false, lastHit = 0;
        let audioCtx; // Инициализируем только по клику!

        function checkCode() {
            if(document.getElementById('passInput').value.trim().toUpperCase() === SECRET_CODE) {
                document.getElementById('screen-login').classList.remove('active');
                document.getElementById('screen-game').classList.add('active');
            } else { alert("Неверный код"); }
        }

        function updateSens(val) {
            SENSITIVITY = val;
            document.getElementById('sensVal').innerText = val;
        }
        
        function debug(msg) {
            document.getElementById('debugText').innerText = "Статус: " + msg;
            console.log(msg);
        }

        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', async () => {
            try {
                debug("Запуск Аудио...");
                
                // 1. Создаем контекст ТОЛЬКО внутри клика (для iOS)
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                // 2. Принудительно будим его
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }

                debug("Запрос прав...");
                // 3. Запрос микрофона
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                debug("Микрофон получен. Настройка...");
                const analyser = audioCtx.createAnalyser();
                const mic = audioCtx.createMediaStreamSource(stream);
                const script = audioCtx.createScriptProcessor(2048, 1, 1);
                
                // 4. Подключаем: Микрофон -> Анализатор -> Скрипт -> (Заглушка) -> Выход
                // Это нужно, чтобы браузер не останавливал процесс "в никуда"
                const zeroGain = audioCtx.createGain();
                zeroGain.gain.value = 0.0; // Глушим звук, чтобы не пищало
                
                mic.connect(analyser);
                analyser.connect(script);
                script.connect(zeroGain);
                zeroGain.connect(audioCtx.destination);
                
                startBtn.style.display = 'none';
                isRunning = true;
                debug("Слушаю...");
                
                // Таймер
                let timeLeft = 60;
                setInterval(() => {
                    timeLeft--;
                    document.getElementById('timer').innerText = timeLeft + "s";
                    if(timeLeft <= 0) {
                        alert("Время вышло! Счет: " + score);
                        isRunning = false;
                    }
                }, 1000);

                // ОБРАБОТКА ЗВУКА
                script.onaudioprocess = function() {
                    if (!isRunning) return;
                    
                    const arr = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(arr);
                    
                    // Считаем среднюю громкость
                    let values = 0;
                    for(let i=0; i<arr.length; i++) values += arr[i];
                    let average = values / arr.length;

                    // 1. ВИЗУАЛИЗАЦИЯ (ПРЫГАЮЩАЯ ПОЛОСКА)
                    const barWidth = Math.min(average * 3, 100); // Умножаем для наглядности
                    document.getElementById('micLevel').style.width = barWidth + "%";

                    // 2. ДЕТЕКЦИЯ УДАРА
                    // Если громкость выше чувствительности
                    if(average > SENSITIVITY) {
                        if(Date.now() - lastHit > 150) { // Задержка 150мс
                            score++;
                            const el = document.getElementById('scoreDisplay');
                            el.innerText = score;
                            el.classList.add('hit');
                            setTimeout(()=>el.classList.remove('hit'), 100);
                            lastHit = Date.now();
                        }
                    }
                }
            } catch(e) {
                debug("ОШИБКА: " + e.message);
                alert("ОШИБКА ДОСТУПА: " + e.message + ". Проверьте, что сайт открыт через HTTPS и права выданы.");
            }
        });
    </script>
</body>
</html>
