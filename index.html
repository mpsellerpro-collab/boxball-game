<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall 2 Modes</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: radial-gradient(circle at center, #1a0b0b 0%, #000000 100%);
            color: white;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        .score-circle {
            width: 210px; height: 210px; border-radius: 50%; 
            border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 20px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: 0.05s; position: relative; z-index: 2;
        }
        .hit { transform: scale(1.1); border-color: #ff0055; box-shadow: 0 0 50px rgba(255,0,85,0.4); color: #ff0055; }
        .hit-survival { transform: scale(1.1); border-color: #ffcc00; box-shadow: 0 0 50px rgba(255,204,0,0.4); color: #ffcc00; }

        button {
            padding: 16px 0; font-size: 17px; font-weight: 800;
            background: #ff0055; color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 4px 15px rgba(255, 0, 85, 0.3);
            position: relative; z-index: 5;
        }
        button:active { transform: scale(0.96); }
        button.channel-btn { background: #2AABEE; color: white; box-shadow: 0 4px 15px rgba(42, 171, 238, 0.3); }

        /* –í–´–ë–û–† –†–ï–ñ–ò–ú–ê */
        .mode-selector {
            display: flex; gap: 10px; margin-bottom: 15px; width: 90%; max-width: 320px;
        }
        .mode-btn {
            flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid #444;
            color: #aaa; border-radius: 12px; font-size: 13px; font-weight: bold; margin: 0; box-shadow: none;
        }
        .mode-btn.active-mode {
            background: #ff0055; color: white; border-color: #ff0055; box-shadow: 0 0 15px rgba(255,0,85,0.3);
        }
        .mode-btn.survival-mode.active-mode {
            background: #ffcc00; color: black; border-color: #ffcc00; box-shadow: 0 0 15px rgba(255,204,0,0.3);
        }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-panel {
            background: rgba(30,30,30,0.95); border: 1px solid #555;
            padding: 20px; border-radius: 15px; margin-bottom: 20px; width: 85%; max-width: 300px;
            display: none; z-index: 10; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }
        input[type=range] { width: 100%; margin: 15px 0; accent-color: #ff0055; }

        .rules-box { background: rgba(255, 0, 85, 0.1); border: 1px solid rgba(255, 0, 85, 0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; width: 90%; max-width: 300px; font-size: 12px; line-height: 1.4; color: #ffcccc; }
        .leaderboard-box { background: rgba(0,0,0,0.3); width: 100%; max-height: 35vh; overflow-y: auto; border-radius: 16px; margin: 15px 0; }
        .leader-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        .shield-icon { font-size: 12px; color: #00ff88; margin-bottom: 10px; border: 1px solid #00ff88; padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>

    <!-- 1. –í–•–û–î -->
    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px; margin-bottom: 5px;">BOXBALL</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 30px;">DUAL MODE</p>
        <input type="text" id="passInput" placeholder="–ö–û–î –ò–ó –ö–û–†–û–ë–ö–ò" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:18px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò –í –ò–ì–†–£</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px;">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</p>
    </div>

    <!-- 2. –ò–ì–†–ê -->
    <div id="screen-game" class="screen">
        
        <!-- –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –†–ï–ñ–ò–ú–û–í -->
        <div class="mode-selector">
            <button class="mode-btn active-mode" id="btnSprint" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn survival-mode" id="btnSurvival" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
        </div>

        <div style="display:flex; justify-content:space-between; width:80%; margin-bottom:10px; align-items: center;">
            <div style="background:rgba(255,255,255,0.1); padding:6px 15px; border-radius:15px; font-weight:bold; color:#fff; font-size: 18px;" id="timer">60s</div>
            <div class="shield-icon">üõ°Ô∏è ANTI-CHEAT</div>
        </div>

        <div style="font-size:12px; color:#aaa; cursor:pointer; margin-bottom:10px; border-bottom:1px dashed #555;" onclick="toggleSettings()">
            ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        </div>
        
        <!-- –ü–ê–ù–ï–õ–¨ –ù–ê–°–¢–†–û–ï–ö -->
        <div class="settings-panel" id="settingsPanel">
            <label style="font-size:12px; color:#ccc;">–ü–æ—Ä–æ–≥ —É–¥–∞—Ä–∞: <span id="sensVal">15</span></label>
            <input type="range" id="sensRange" min="5" max="50" value="15" oninput="updateSens(this.value)">
            <button onclick="setRecommended()" style="background: #333; border: 1px solid #00ff88; color: #00ff88; padding: 10px; font-size: 12px; width: 100%; box-shadow: none; margin-bottom: 5px;">
                ‚úÖ –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç (15)
            </button>
            <button onclick="toggleSettings()" style="margin-top:5px; padding:10px; font-size:12px; background:#222; border:1px solid #444;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
        
        <div class="score-circle" id="scoreDisplay">0</div>
        <div style="color:#666; font-size:12px; margin-top:-10px; margin-bottom:20px;" id="modeHint">–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö</div>

        <button id="startBtn">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
    </div>

    <!-- 3. –†–ï–ó–£–õ–¨–¢–ê–¢ -->
    <div id="screen-save" class="screen">
        <div style="font-size:14px; color:#aaa; margin-bottom: 5px;">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h1 style="font-size:80px; margin:0; color:#ff0055;" id="finalScore">0</h1>
        <div style="font-size:14px; color:#ffcc00; margin-bottom: 20px; font-weight:bold;" id="modeResultLabel">–°–ü–†–ò–ù–¢</div>
        
        <div class="rules-box">‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï:</b><br>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∏–¥–µ–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ. Anti-Cheat –∞–∫—Ç–∏–≤–µ–Ω.</div>
        <input type="text" id="nicknameInput" placeholder="–í–∞—à–µ –ò–º—è" maxlength="15" style="padding:14px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; width:80%;">
        <button onclick="saveScore()">–°–û–•–†–ê–ù–ò–¢–¨ –í –¢–û–ü</button>
        <button class="channel-btn" onclick="openChannel()">üèÜ –ö–ê–ù–ê–õ –¢–£–†–ù–ò–†–ê</button>
    </div>

    <!-- 4. –õ–ò–î–ï–†–´ -->
    <div id="screen-leaders" class="screen">
        <h3>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div class="leaderboard-box" id="leaderList"><div style="padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div></div>
        <button onclick="location.reload()" style="background: #333;">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <script>
        // === –í–ê–®–ò –°–°–´–õ–ö–ò ===
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx9uYsrQUk5WUn4mBXSv__HUAY_oxnbyK-w3rKORU7wEGLNDWSYpLTMdvt1NCtrsLc4tw/exec"; 
        const CHANNEL_URL = "https://t.me/DUROV"; 
        const SECRET_CODE = "BOX2025";
        
        const MIN_HIT_DELAY = 180;
        let SENSITIVITY = 15;
        let score = 0, isRunning = false, lastHitTime = 0;
        let currentMode = 'sprint'; // 'sprint' –∏–ª–∏ 'survival'
        let timeLeft = 60;
        let audioCtx;
        const synth = window.speechSynthesis;
        let timerInterval;

        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) { window.Telegram.WebApp.expand(); }
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) { 
                SENSITIVITY = savedSens; 
                document.getElementById('sensRange').value = savedSens;
                document.getElementById('sensVal').innerText = savedSens;
            }
            if (localStorage.getItem('box_auth') === 'true') showScreen('screen-game');
        };

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function checkCode() { 
            if(document.getElementById('passInput').value.trim().toUpperCase() === SECRET_CODE) { localStorage.setItem('box_auth', 'true'); showScreen('screen-game'); } 
            else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        
        // --- –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –†–ï–ñ–ò–ú–û–í ---
        function setMode(mode) {
            if(isRunning) return; // –ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
            currentMode = mode;
            
            // –í–∏–∑—É–∞–ª –∫–Ω–æ–ø–æ–∫
            document.getElementById('btnSprint').className = 'mode-btn';
            document.getElementById('btnSurvival').className = 'mode-btn survival-mode';
            
            if(mode === 'sprint') {
                document.getElementById('btnSprint').classList.add('active-mode');
                document.getElementById('timer').innerText = "60s";
                document.getElementById('modeHint').innerText = "–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö";
                document.getElementById('timer').style.color = "#fff";
            } else {
                document.getElementById('btnSurvival').classList.add('active-mode');
                document.getElementById('timer').innerText = "10s";
                document.getElementById('modeHint').innerText = "–£–î–ê–† = +1 –°–ï–ö–£–ù–î–ê. –ù–ï –û–°–¢–ê–ù–ê–í–õ–ò–í–ê–ô–°–Ø!";
                document.getElementById('timer').style.color = "#ffcc00";
            }
        }

        function toggleSettings() {
            const el = document.getElementById('settingsPanel');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }
        function updateSens(val) { 
            SENSITIVITY = val; 
            document.getElementById('sensVal').innerText = val;
            localStorage.setItem('box_sens', val); 
        }
        function setRecommended() { updateSens(15); document.getElementById('sensRange').value = 15; }
        
        function openChannel() { window.Telegram.WebApp.openTelegramLink(CHANNEL_URL); }
        function speak(text) { if (synth.speaking) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'ru-RU'; u.rate = 1.2; synth.speak(u); }

        function playSound(type) {
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'hit') {
                // –†–∞–∑–Ω—ã–µ –∑–≤—É–∫–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ä–µ–∂–∏–º–æ–≤
                const freq = currentMode === 'sprint' ? 600 : 400;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(freq + 400, audioCtx.currentTime+0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
                if (score > 0 && score % 20 === 0) { const phrases = ["–•–æ—Ä–æ—à!", "–î–∞–≤–∞–π –µ—â–µ!", "–î–µ—Ä–∂–∏ —Ä–∏—Ç–º!", "–ö—Ä–∞—Å–∞–≤—á–∏–∫!"]; speak(phrases[Math.floor(Math.random()*phrases.length)]); }
            } else {
                osc.frequency.value = 200; gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1.5);
                osc.start(); osc.stop(audioCtx.currentTime+1.5); setTimeout(() => speak("–°—Ç–æ–ø! –†–µ–∑—É–ª—å—Ç–∞—Ç " + score), 1000);
            }
        }

        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', async () => {
            if(isRunning) return;

            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();

                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const analyser = audioCtx.createAnalyser(); 
                const mic = audioCtx.createMediaStreamSource(stream); 
                const script = audioCtx.createScriptProcessor(2048, 1, 1);
                
                const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0.0;
                mic.connect(analyser); analyser.connect(script); script.connect(zeroGain); zeroGain.connect(audioCtx.destination);
                
                startBtn.style.display = 'none';
                document.getElementById('settingsPanel').style.display = 'none';
                document.querySelector('.mode-selector').style.opacity = '0.3'; // –ó–∞—Ç–µ–º–Ω–∏—Ç—å –≤—ã–±–æ—Ä —Ä–µ–∂–∏–º–æ–≤
                
                isRunning = true; 
                score = 0; document.getElementById('scoreDisplay').innerText = 0; 
                
                // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
                timeLeft = currentMode === 'sprint' ? 60 : 10;
                document.getElementById('timer').innerText = timeLeft + "s";
                
                speak("–ë–æ–π!");

                if (timerInterval) clearInterval(timerInterval);

                timerInterval = setInterval(() => { 
                    timeLeft--; 
                    document.getElementById('timer').innerText = timeLeft + "s"; 
                    
                    if(timeLeft <= 0) { 
                        clearInterval(timerInterval); 
                        isRunning = false; 
                        finishGame(); 
                    } 
                }, 1000);

                script.onaudioprocess = function() {
                    if(!isRunning) return;
                    const arr = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(arr);
                    let v = 0; for(let i=0; i<arr.length; i++) v+=arr[i];
                    let avg = v/arr.length;

                    if(avg > SENSITIVITY) {
                        const now = Date.now();
                        if(now - lastHitTime > MIN_HIT_DELAY) {
                            score++; 
                            const el = document.getElementById('scoreDisplay'); el.innerText = score; 
                            
                            // –≠—Ñ—Ñ–µ–∫—Ç –∏ –ª–æ–≥–∏–∫–∞ –í–´–ñ–ò–í–ê–ù–ò–Ø
                            if (currentMode === 'survival') {
                                el.classList.add('hit-survival');
                                timeLeft += 1; // +1 –°–ï–ö–£–ù–î–ê
                                document.getElementById('timer').innerText = timeLeft + "s";
                            } else {
                                el.classList.add('hit');
                            }
                            
                            setTimeout(()=>el.className = 'score-circle', 100);
                            
                            playSound('hit'); 
                            if(window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                            lastHitTime = now;
                        }
                    }
                }
            } catch(e) { 
                alert("–û—à–∏–±–∫–∞: –†–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω!"); 
            }
        });

        function finishGame() { 
            isRunning = false;
            playSound('end'); 
            document.getElementById('finalScore').innerText = score; 
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, –≤ –∫–∞–∫–æ–º —Ä–µ–∂–∏–º–µ –±—ã–ª —Ä–µ–∫–æ—Ä–¥
            document.getElementById('modeResultLabel').innerText = currentMode === 'sprint' ? "–†–ï–ñ–ò–ú –°–ü–†–ò–ù–¢" : "–†–ï–ñ–ò–ú –í–´–ñ–ò–í–ê–ù–ò–ï";
            document.querySelector('.mode-selector').style.opacity = '1';
            showScreen('screen-save'); 
        }
        
        function saveScore() {
            const name = document.getElementById('nicknameInput').value.trim() || "–ê–Ω–æ–Ω–∏–º";
            const btn = document.querySelector('#screen-save button');
            if(name.length < 2) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê..."; btn.disabled = true;
            fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: name, score: score, mode: currentMode, date: new Date().toLocaleDateString() }) }).then(() => showLeaderboard()).catch(() => showLeaderboard());
        }
        function showLeaderboard() {
            showScreen('screen-leaders');
            fetch(GOOGLE_SCRIPT_URL).then(r=>r.json()).then(data => {
                const list = document.getElementById('leaderList'); list.innerHTML = "";
                if(!data.length) list.innerHTML = "<div style='padding:20px'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>";
                data.forEach((row, i) => list.innerHTML += `<div class="leader-row"><span>#${i+1} ${row.name}</span><span>${row.score}</span></div>`);
            });
        }
    </script>
</body>
</html>
