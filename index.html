<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Tournament</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: radial-gradient(circle at center, #1a0b0b 0%, #000000 100%);
            color: white; display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }
        .score-circle {
            width: 220px; height: 220px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 20px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: 0.05s; position: relative; z-index: 2;
        }
        .hit { transform: scale(1.1); border-color: #ff0055; box-shadow: 0 0 50px rgba(255,0,85,0.4); color: #ff0055; }
        button {
            padding: 16px 0; font-size: 17px; font-weight: 800; background: #ff0055; color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.3); position: relative; z-index: 5;
        }
        button:active { transform: scale(0.96); }
        button.channel-btn { background: #2AABEE; color: white; box-shadow: 0 4px 15px rgba(42, 171, 238, 0.3); }
        .rules-box { background: rgba(255, 0, 85, 0.1); border: 1px solid rgba(255, 0, 85, 0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; width: 90%; max-width: 300px; font-size: 12px; line-height: 1.4; color: #ffcccc; }
        .leaderboard-box { background: rgba(0,0,0,0.3); width: 100%; max-height: 35vh; overflow-y: auto; border-radius: 16px; margin: 15px 0; }
        .leader-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 14px; }
        .shield-icon { font-size: 12px; color: #00ff88; margin-bottom: 10px; border: 1px solid #00ff88; padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>
    <!-- –í–•–û–î -->
    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px; margin-bottom: 5px;">BOXBALL</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 30px;">TOURNAMENT EDITION</p>
        <input type="text" id="passInput" placeholder="–ö–û–î –ò–ó –ö–û–†–û–ë–ö–ò" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:18px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò –í –ò–ì–†–£</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px;">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</p>
    </div>
    <!-- –ò–ì–†–ê -->
    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; width:80%; margin-bottom:10px; align-items: center;">
            <div style="background:rgba(255,255,255,0.1); padding:6px 15px; border-radius:15px; font-weight:bold; color:#fff; font-size: 18px;" id="timer">60s</div>
            <div class="shield-icon">üõ°Ô∏è ANTI-CHEAT</div>
        </div>
        <div class="score-circle" id="scoreDisplay">0</div>
        <div style="color:#666; font-size:12px; margin-top:-10px; margin-bottom:20px;">–ë–ï–ô –í –†–ò–¢–ú</div>
        <div id="devSettings" style="display:none; margin-bottom: 10px;">
             <input type="range" id="sensRange" min="1" max="50" value="10" oninput="updateSens(this.value)">
             <div style="font-size:10px">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <span id="sensVal">10</span></div>
        </div>
        <button id="startBtn">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
    </div>
    <!-- –†–ï–ó–£–õ–¨–¢–ê–¢ -->
    <div id="screen-save" class="screen">
        <h1 style="font-size:80px; margin:0; color:#ff0055;" id="finalScore">0</h1>
        <div style="font-size:14px; color:#aaa; margin-bottom: 20px;">–í–ê–® –†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <div class="rules-box">‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï:</b><br>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∏–¥–µ–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ. Anti-Cheat –∞–∫—Ç–∏–≤–µ–Ω.</div>
        <input type="text" id="nicknameInput" placeholder="–í–∞—à–µ –ò–º—è" maxlength="15" style="padding:14px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; width:80%;">
        <button onclick="saveScore()">–°–û–•–†–ê–ù–ò–¢–¨ –í –¢–û–ü</button>
        <button class="channel-btn" onclick="openChannel()">üèÜ –°–õ–ï–î–ò–¢–¨ –ó–ê –¢–£–†–ù–ò–†–û–ú</button>
    </div>
    <!-- –õ–ò–î–ï–†–´ -->
    <div id="screen-leaders" class="screen">
        <h3>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div class="leaderboard-box" id="leaderList"><div style="padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div></div>
        <button onclick="location.reload()" style="background: #333;">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <script>
        // === –í–ê–ñ–ù–û: –í–°–¢–ê–í–¨–¢–ï –°–Æ–î–ê –í–ê–®–ò –°–°–´–õ–ö–ò ===
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx9uYsrQUk5WUn4mBXSv__HUAY_oxnbyK-w3rKORU7wEGLNDWSYpLTMdvt1NCtrsLc4tw/exec"; 
        const CHANNEL_URL = "https://t.me/DUROV"; // –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∞—à –∫–∞–Ω–∞–ª
        const SECRET_CODE = "BOX2025";
        
        const MIN_HIT_DELAY = 180; 
        let SENSITIVITY = 10;
        let score = 0, isRunning = false, lastHitTime = 0;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const synth = window.speechSynthesis;

        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) { window.Telegram.WebApp.expand(); window.Telegram.WebApp.enableClosingConfirmation(); }
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) { SENSITIVITY = savedSens; document.getElementById('sensRange').value = savedSens; document.getElementById('sensVal').innerText = savedSens; }
            if (localStorage.getItem('box_auth') === 'true') showScreen('screen-game');
        };

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function checkCode() { 
            if(document.getElementById('passInput').value.trim().toUpperCase() === SECRET_CODE) { localStorage.setItem('box_auth', 'true'); showScreen('screen-game'); } 
            else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        
        let tapCount = 0;
        document.querySelector('#screen-game div[style*="margin-top:-10px"]').addEventListener('click', () => { tapCount++; if(tapCount === 5) document.getElementById('devSettings').style.display = 'block'; });
        function updateSens(val) { SENSITIVITY = val; document.getElementById('sensVal').innerText = val; localStorage.setItem('box_sens', val); }
        function openChannel() { window.Telegram.WebApp.openTelegramLink(CHANNEL_URL); }
        function speak(text) { if (synth.speaking) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'ru-RU'; u.rate = 1.2; synth.speak(u); }

        function playSound(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'hit') {
                osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1000, audioCtx.currentTime+0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
                if (score > 0 && score % 20 === 0) { const phrases = ["–•–æ—Ä–æ—à!", "–î–∞–≤–∞–π –µ—â–µ!", "–î–µ—Ä–∂–∏ —Ä–∏—Ç–º!", "–ö—Ä–∞—Å–∞–≤—á–∏–∫!"]; speak(phrases[Math.floor(Math.random()*phrases.length)]); }
            } else {
                osc.frequency.value = 200; gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1.5);
                osc.start(); osc.stop(audioCtx.currentTime+1.5); setTimeout(() => speak("–°—Ç–æ–ø! –†–µ–∑—É–ª—å—Ç–∞—Ç " + score), 1000);
            }
        }

        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const analyser = audioCtx.createAnalyser(); const mic = audioCtx.createMediaStreamSource(stream); const script = audioCtx.createScriptProcessor(1024, 1, 1);
                mic.connect(analyser); analyser.connect(script); script.connect(audioCtx.destination);
                startBtn.style.display = 'none'; document.getElementById('devSettings').style.display = 'none';
                isRunning = true; let timeLeft = 60; lastHitTime = 0; score = 0; document.getElementById('scoreDisplay').innerText = 0; speak("–ë–æ–π!");
                const tInt = setInterval(() => { timeLeft--; document.getElementById('timer').innerText = timeLeft + "s"; if(timeLeft <= 0) { clearInterval(tInt); isRunning = false; finishGame(); } }, 1000);
                script.onaudioprocess = function() {
                    if(!isRunning) return;
                    const arr = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(arr);
                    let v = 0; for(let i=0; i<arr.length; i++) v+=arr[i];
                    if(v/arr.length > SENSITIVITY) {
                        const now = Date.now();
                        if(now - lastHitTime > MIN_HIT_DELAY) {
                            score++; const el = document.getElementById('scoreDisplay'); el.innerText = score; 
                            el.classList.add('hit'); setTimeout(()=>el.classList.remove('hit'), 100);
                            playSound('hit'); if(window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                            lastHitTime = now;
                        }
                    }
                }
            } catch(e) { alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω!"); }
        });

        function finishGame() { playSound('end'); document.getElementById('finalScore').innerText = score; showScreen('screen-save'); }
        function saveScore() {
            const name = document.getElementById('nicknameInput').value.trim() || "–ê–Ω–æ–Ω–∏–º";
            const btn = document.querySelector('#screen-save button');
            if(name.length < 2) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê..."; btn.disabled = true;
            fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: name, score: score, date: new Date().toLocaleDateString() }) }).then(() => showLeaderboard()).catch(() => showLeaderboard());
        }
        function showLeaderboard() {
            showScreen('screen-leaders');
            fetch(GOOGLE_SCRIPT_URL).then(r=>r.json()).then(data => {
                const list = document.getElementById('leaderList'); list.innerHTML = "";
                if(!data.length) list.innerHTML = "<div style='padding:20px'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>";
                data.forEach((row, i) => list.innerHTML += `<div class="leader-row"><span>#${i+1} ${row.name}</span><span>${row.score}</span></div>`);
            });
        }
    </script>
</body>
</html>
