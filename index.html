<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Legal</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: radial-gradient(circle at center, #1a0b0b 0%, #000000 100%);
            color: white;
            display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        .score-circle {
            width: 210px; height: 210px; border-radius: 50%; 
            border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 15px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: 0.05s; position: relative; z-index: 2;
        }
        .hit { transform: scale(1.1); border-color: #ff0055; box-shadow: 0 0 50px rgba(255,0,85,0.4); color: #ff0055; }
        .hit-survival { transform: scale(1.1); border-color: #ffcc00; box-shadow: 0 0 50px rgba(255,204,0,0.4); color: #ffcc00; }

        button {
            padding: 16px 0; font-size: 17px; font-weight: 800;
            background: #ff0055; color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 4px 15px rgba(255, 0, 85, 0.3);
            position: relative; z-index: 5;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #444; color: #888; box-shadow: none; cursor: not-allowed; }
        
        button.channel-btn { background: #2AABEE; color: white; box-shadow: 0 4px 15px rgba(42, 171, 238, 0.3); }
        button.secondary-btn { background: transparent; border: 1px solid #444; color: #aaa; box-shadow: none; font-size: 14px; margin-top: 15px; padding: 12px; }

        /* –í–´–ë–û–† –†–ï–ñ–ò–ú–ê */
        .mode-selector { display: flex; gap: 10px; margin-bottom: 10px; width: 90%; max-width: 320px; }
        .mode-btn { flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #aaa; border-radius: 12px; font-size: 13px; font-weight: bold; margin: 0; box-shadow: none; }
        .mode-btn.active-mode { background: #ff0055; color: white; border-color: #ff0055; box-shadow: 0 0 15px rgba(255,0,85,0.3); }
        .mode-btn.survival-mode.active-mode { background: #ffcc00; color: black; border-color: #ffcc00; box-shadow: 0 0 15px rgba(255,204,0,0.3); }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-panel { background: rgba(30,30,30,0.95); border: 1px solid #555; padding: 20px; border-radius: 15px; margin-bottom: 20px; width: 85%; max-width: 300px; display: none; z-index: 10; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        input[type=range] { width: 100%; margin: 15px 0; accent-color: #ff0055; }

        .rules-box { background: rgba(255, 0, 85, 0.1); border: 1px solid rgba(255, 0, 85, 0.3); padding: 15px; border-radius: 12px; margin-bottom: 20px; width: 90%; max-width: 300px; font-size: 12px; line-height: 1.4; color: #ffcccc; }
        .leaderboard-box { background: rgba(0,0,0,0.3); width: 100%; max-height: 35vh; overflow-y: auto; border-radius: 16px; margin: 15px 0; }
        .leader-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .leader-left { text-align: left; }
        .leader-name { font-size: 14px; font-weight: bold; display: block; color: #eee; }
        .leader-date { font-size: 10px; color: #888; display: block; margin-top: 3px; }
        .leader-score { font-size: 18px; font-weight: bold; color: #fff; }
        .leader-row:nth-child(1) .leader-name, .leader-row:nth-child(1) .leader-score { color: #ffcc00; text-shadow: 0 0 10px rgba(255,204,0,0.3); }

        .shield-icon { font-size: 10px; color: #00ff88; margin-bottom: 10px; border: 1px solid #00ff88; padding: 4px 8px; border-radius: 20px; align-self: flex-start; margin-top: 10px; }
        @keyframes pulse-red { 0% { color: #fff; transform: scale(1); } 50% { color: #ff0000; transform: scale(1.2); } 100% { color: #fff; transform: scale(1); } }
        .critical-time { animation: pulse-red 0.5s infinite; }

        .leader-tabs { display: flex; width: 100%; margin-bottom: 10px; border-bottom: 1px solid #444; }
        .leader-tab { flex: 1; padding: 10px; font-size: 12px; font-weight: bold; color: #666; cursor: pointer; transition: 0.2s; }
        .leader-tab.active-tab { color: #ff0055; border-bottom: 2px solid #ff0055; background: rgba(255,0,85,0.05); }
        .leader-tab.survival-tab.active-tab { color: #ffcc00; border-bottom: 2px solid #ffcc00; background: rgba(255,204,0,0.05); }

        /* –Æ–†–ò–î–ò–ß–ï–°–ö–ò–ô –ë–õ–û–ö */
        .legal-footer { position: absolute; bottom: 10px; font-size: 9px; color: #444; width: 100%; text-align: center; line-height: 1.4; }
        .legal-checkbox-area { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px; width: 90%; max-width: 300px; text-align: left; font-size: 11px; color: #aaa; }
        .legal-checkbox-area input { margin-top: 2px; }
        .legal-link { color: #00ff88; text-decoration: underline; cursor: pointer; }
    </style>
</head>
<body>

    <!-- 1. –í–•–û–î -->
    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px; margin-bottom: 5px;">BOXBALL</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 30px;">RUSSIA</p>
        <input type="text" id="passInput" placeholder="–ö–û–î –ò–ó –ö–û–†–û–ë–ö–ò" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:18px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò –í –ò–ì–†–£</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px;">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</p>
        
        <!-- –ö–û–ü–ò–†–ê–ô–¢ -->
        <div class="legal-footer">
            ¬© 2026 BOXBALL RUSSIA. –í–°–ï –ü–†–ê–í–ê –ó–ê–©–ò–©–ï–ù–´.<br>
            –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ü–†–ï–°–õ–ï–î–£–ï–¢–°–Ø –ü–û –ó–ê–ö–û–ù–£ –†–§.
        </div>
    </div>

    <!-- 2. –ò–ì–†–ê -->
    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" id="btnSprint" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn survival-mode" id="btnSurvival" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
        </div>

        <div style="display:flex; justify-content:space-between; width:90%; align-items: center; margin-bottom: 5px;">
            <div style="background:rgba(255,255,255,0.1); padding:8px 25px; border-radius:20px; font-weight:bold; color:#fff; font-size: 42px; min-width: 110px;" id="timer">60</div>
            <div style="display:flex; flex-direction:column; align-items:flex-end;">
                <div class="shield-icon" style="margin:0 0 5px 0;">üõ°Ô∏è ANTI-CHEAT</div>
                <div style="font-size:12px; color:#aaa; cursor:pointer; border-bottom:1px dashed #555;" onclick="toggleSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            </div>
        </div>
        
        <div class="settings-panel" id="settingsPanel">
            <label style="font-size:12px; color:#ccc;">–ü–æ—Ä–æ–≥ —É–¥–∞—Ä–∞: <span id="sensVal">15</span></label>
            <input type="range" id="sensRange" min="5" max="50" value="15" oninput="updateSens(this.value)">
            <button onclick="setRecommended()" style="background: #333; border: 1px solid #00ff88; color: #00ff88; padding: 10px; font-size: 12px; width: 100%; box-shadow: none; margin-bottom: 5px;">‚úÖ –°–±—Ä–æ—Å–∏—Ç—å –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç (15)</button>
            <button onclick="logout()" style="background: #220000; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 10px; font-size: 12px; width: 100%; box-shadow: none; margin-bottom: 5px;">üö™ –í—ã–π—Ç–∏</button>
            <button onclick="toggleSettings()" style="margin-top:5px; padding:10px; font-size:12px; background:#222; border:1px solid #444;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
        
        <div class="score-circle" id="scoreDisplay">0</div>
        <div style="color:#666; font-size:12px; margin-top:-10px; margin-bottom:10px;" id="modeHint">–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö</div>

        <button id="startBtn">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
        <button onclick="showLeaderboard(true)" class="secondary-btn">üèÜ –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</button>
    </div>

    <!-- 3. –†–ï–ó–£–õ–¨–¢–ê–¢ (–° –ó–ê–©–ò–¢–û–ô –î–ê–ù–ù–´–•) -->
    <div id="screen-save" class="screen">
        <div style="font-size:14px; color:#aaa; margin-bottom: 5px;">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h1 style="font-size:80px; margin:0; color:#ff0055;" id="finalScore">0</h1>
        <div style="font-size:14px; color:#ffcc00; margin-bottom: 20px; font-weight:bold;" id="modeResultLabel">–°–ü–†–ò–ù–¢</div>
        
        <div class="rules-box">‚ö†Ô∏è <b>–í–ù–ò–ú–ê–ù–ò–ï:</b><br>–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–∑–æ–≤ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∏–¥–µ–æ-–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ.</div>
        <input type="text" id="nicknameInput" placeholder="–í–∞—à–µ –ò–º—è" maxlength="15" style="padding:14px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; width:80%; margin-bottom: 15px;">
        
        <!-- –ì–ê–õ–û–ß–ö–ê –°–û–ì–õ–ê–°–ò–Ø -->
        <div class="legal-checkbox-area">
            <input type="checkbox" id="legalCheck" onchange="toggleSaveBtn()">
            <label for="legalCheck">
                –Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ <span class="legal-link" onclick="openPolicy()">–æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span> –∏ –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è.
            </label>
        </div>

        <button id="saveBtn" onclick="saveScore()" disabled title="–ü–æ—Å—Ç–∞–≤—å—Ç–µ –≥–∞–ª–æ—á–∫—É —Å–æ–≥–ª–∞—Å–∏—è">–°–û–•–†–ê–ù–ò–¢–¨ –í –¢–û–ü</button>
        <button class="channel-btn" onclick="openChannel()">üèÜ –ö–ê–ù–ê–õ –¢–£–†–ù–ò–†–ê</button>
    </div>

    <!-- 4. –õ–ò–î–ï–†–´ -->
    <div id="screen-leaders" class="screen">
        <h3>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div class="leader-tabs">
            <div class="leader-tab active-tab" id="tabSprint" onclick="switchLeaderTab('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</div>
            <div class="leader-tab survival-tab" id="tabSurvival" onclick="switchLeaderTab('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</div>
        </div>
        <div class="leaderboard-box" id="leaderList"><div style="padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
        <button id="leaderBackBtn" onclick="location.reload()" style="background: #333;">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <script>
        // === –í–ê–®–ò –°–°–´–õ–ö–ò ===
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxkA8d8DIy994lgU70DGQ604EZ6e59kkEPm_Zhfaj8eG_QxmbwKltgFK5kRF3bl41_LzA/exec"; 
        const CHANNEL_URL = "https://t.me/DUROV"; 
        const POLICY_URL = "https://docs.google.com/document/d/–í–ê–®–ê_–°–°–´–õ–ö–ê_–ù–ê_–ü–†–ê–í–ò–õ–ê"; // –°—Å—ã–ª–∫–∞ –Ω–∞ –≥—É–≥–ª –¥–æ–∫ —Å –ø—Ä–∞–≤–∏–ª–∞–º–∏
        const SECRET_CODE = "BOX2025";
        
        const MIN_HIT_DELAY = 180;
        let SENSITIVITY = 15;
        let score = 0, isRunning = false, lastHitTime = 0;
        let currentMode = 'sprint'; 
        let timeLeft = 60.0;
        let audioCtx;
        const synth = window.speechSynthesis;
        let timerInterval;
        let viewingLeaderboardMode = 'sprint';

        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) { window.Telegram.WebApp.expand(); }
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) { 
                SENSITIVITY = savedSens; 
                document.getElementById('sensRange').value = savedSens;
                document.getElementById('sensVal').innerText = savedSens;
            }
            if (localStorage.getItem('box_auth') === 'true') showScreen('screen-game');
        };

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function checkCode() { 
            if(document.getElementById('passInput').value.trim().toUpperCase() === SECRET_CODE) { localStorage.setItem('box_auth', 'true'); showScreen('screen-game'); } 
            else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        function logout() { localStorage.removeItem('box_auth'); location.reload(); }
        
        // --- –Æ–†–ò–î–ò–ß–ï–°–ö–ê–Ø –õ–û–ì–ò–ö–ê ---
        function toggleSaveBtn() {
            const chk = document.getElementById('legalCheck');
            const btn = document.getElementById('saveBtn');
            btn.disabled = !chk.checked;
        }
        function openPolicy() { window.Telegram.WebApp.openLink(POLICY_URL); }

        function setMode(mode) {
            if(isRunning) return;
            currentMode = mode;
            document.getElementById('btnSprint').className = 'mode-btn';
            document.getElementById('btnSurvival').className = 'mode-btn survival-mode';
            if(mode === 'sprint') {
                document.getElementById('btnSprint').classList.add('active-mode');
                document.getElementById('timer').innerText = "60";
                document.getElementById('modeHint').innerText = "–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö";
                document.getElementById('timer').style.color = "#fff";
                document.getElementById('timer').classList.remove('critical-time');
            } else {
                document.getElementById('btnSurvival').classList.add('active-mode');
                document.getElementById('timer').innerText = "10";
                document.getElementById('modeHint').innerText = "–£–°–ö–û–†–Ø–ô–°–Ø, –ß–¢–û–ë–´ –í–´–ñ–ò–¢–¨!";
                document.getElementById('timer').style.color = "#ffcc00";
            }
        }

        function toggleSettings() {
            const el = document.getElementById('settingsPanel');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }
        function updateSens(val) { SENSITIVITY = val; document.getElementById('sensVal').innerText = val; localStorage.setItem('box_sens', val); }
        function setRecommended() { updateSens(15); document.getElementById('sensRange').value = 15; }
        function openChannel() { window.Telegram.WebApp.openTelegramLink(CHANNEL_URL); }
        function speak(text) { if (synth.speaking) return; const u = new SpeechSynthesisUtterance(text); u.lang = 'ru-RU'; u.rate = 1.2; synth.speak(u); }

        function playSound(type) {
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'hit') {
                const freq = currentMode === 'sprint' ? 600 : 400;
                osc.frequency.setValueAtTime(freq, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(freq + 400, audioCtx.currentTime+0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
                if (score > 0 && score % 20 === 0) { const phrases = ["–•–æ—Ä–æ—à!", "–î–∞–≤–∞–π –µ—â–µ!", "–î–µ—Ä–∂–∏ —Ä–∏—Ç–º!", "–ö—Ä–∞—Å–∞–≤—á–∏–∫!"]; speak(phrases[Math.floor(Math.random()*phrases.length)]); }
            } else {
                osc.frequency.value = 200; gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1.5);
                osc.start(); osc.stop(audioCtx.currentTime+1.5); setTimeout(() => speak("–°—Ç–æ–ø! –†–µ–∑—É–ª—å—Ç–∞—Ç " + score), 1000);
            }
        }

        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', async () => {
            if(isRunning) return;
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const analyser = audioCtx.createAnalyser(); const mic = audioCtx.createMediaStreamSource(stream); const script = audioCtx.createScriptProcessor(2048, 1, 1);
                const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0.0;
                mic.connect(analyser); analyser.connect(script); script.connect(zeroGain); zeroGain.connect(audioCtx.destination);
                
                startBtn.style.display = 'none'; document.getElementById('settingsPanel').style.display = 'none';
                document.querySelector('.mode-selector').style.opacity = '0.3';
                document.querySelector('.secondary-btn').style.display = 'none'; 
                
                isRunning = true; score = 0; document.getElementById('scoreDisplay').innerText = 0; 
                timeLeft = currentMode === 'sprint' ? 60 : 10;
                document.getElementById('timer').innerText = timeLeft;
                speak("–ë–æ–π!");

                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(() => { 
                    timeLeft -= 1; document.getElementById('timer').innerText = Math.floor(timeLeft); 
                    if(timeLeft <= 3) document.getElementById('timer').classList.add('critical-time');
                    else document.getElementById('timer').classList.remove('critical-time');
                    if(timeLeft <= 0) { clearInterval(timerInterval); isRunning = false; finishGame(); } 
                }, 1000);

                script.onaudioprocess = function() {
                    if(!isRunning) return;
                    const arr = new Uint8Array(analyser.frequencyBinCount); analyser.getByteFrequencyData(arr);
                    let v = 0; for(let i=0; i<arr.length; i++) v+=arr[i];
                    let avg = v/arr.length;
                    if(avg > SENSITIVITY) {
                        const now = Date.now();
                        if(now - lastHitTime > MIN_HIT_DELAY) {
                            score++; const el = document.getElementById('scoreDisplay'); el.innerText = score; 
                            if (currentMode === 'survival') {
                                el.classList.add('hit-survival');
                                let bonus = 1.0; 
                                if (score > 20) bonus = 0.5; if (score > 50) bonus = 0.25;
                                timeLeft += bonus; if (timeLeft > 10) timeLeft = 10;
                                document.getElementById('timer').innerText = Math.floor(timeLeft);
                                document.getElementById('timer').classList.remove('critical-time');
                            } else { el.classList.add('hit'); }
                            setTimeout(()=>el.className = 'score-circle', 100);
                            playSound('hit'); if(window.Telegram.WebApp.HapticFeedback) window.Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                            lastHitTime = now;
                        }
                    }
                }
            } catch(e) { alert("–û—à–∏–±–∫–∞: –†–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω!"); }
        });

        function finishGame() { 
            isRunning = false; playSound('end'); 
            document.getElementById('finalScore').innerText = score; 
            document.getElementById('modeResultLabel').innerText = currentMode === 'sprint' ? "–†–ï–ñ–ò–ú –°–ü–†–ò–ù–¢" : "–†–ï–ñ–ò–ú –í–´–ñ–ò–í–ê–ù–ò–ï";
            document.querySelector('.mode-selector').style.opacity = '1';
            
            // –°–±—Ä–æ—Å –≥–∞–ª–æ—á–∫–∏ –¥–ª—è –Ω–æ–≤–æ–π –∏–≥—Ä—ã
            document.getElementById('legalCheck').checked = false;
            toggleSaveBtn(); 
            
            showScreen('screen-save'); 
        }
        
        function saveScore() {
            const name = document.getElementById('nicknameInput').value.trim() || "–ê–Ω–æ–Ω–∏–º";
            const btn = document.querySelector('#screen-save button');
            if(name.length < 2) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê..."; btn.disabled = true;
            fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: name, score: score, mode: currentMode, date: new Date().toLocaleDateString() }) }).then(() => showLeaderboard(false, currentMode)).catch(() => showLeaderboard(false, currentMode));
        }

        function switchLeaderTab(mode) {
            viewingLeaderboardMode = mode;
            document.getElementById('tabSprint').className = 'leader-tab';
            document.getElementById('tabSurvival').className = 'leader-tab survival-tab';
            if(mode === 'sprint') document.getElementById('tabSprint').classList.add('active-tab');
            else document.getElementById('tabSurvival').classList.add('active-tab');
            fetchLeaderboardData(mode);
        }

        function showLeaderboard(fromMenu = false, initialMode = 'sprint') {
            showScreen('screen-leaders');
            const backBtn = document.getElementById('leaderBackBtn');
            if(fromMenu) {
                backBtn.innerText = "–ù–ê–ó–ê–î –í –ú–ï–ù–Æ";
                backBtn.onclick = function() { showScreen('screen-game'); };
                initialMode = currentMode; 
            } else {
                backBtn.innerText = "–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê";
                backBtn.onclick = function() { location.reload(); };
            }
            switchLeaderTab(initialMode);
        }

        function fetchLeaderboardData(mode) {
            const list = document.getElementById('leaderList'); 
            list.innerHTML = "<div style='padding:20px'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";
            fetch(GOOGLE_SCRIPT_URL + "?mode=" + mode)
            .then(r=>r.json())
            .then(data => {
                list.innerHTML = "";
                if(!data.length) list.innerHTML = "<div style='padding:20px'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>";
                data.forEach((row, i) => {
                    let dateStr = row.date ? row.date : ''; 
                    list.innerHTML += `
                    <div class="leader-row">
                        <div class="leader-left">
                            <span class="leader-name">#${i+1} ${row.name}</span>
                            <span class="leader-date">${dateStr}</span>
                        </div>
                        <span class="leader-score">${row.score}</span>
                    </div>`;
                });
            });
        }
    </script>
</body>
</html>
