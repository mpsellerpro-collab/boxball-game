<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Pro Ultimate</title>
    
    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const GOOGLE_SCRIPT_URL = "–í–°–¢–ê–í–¨_–°–Æ–î–ê_–°–°–´–õ–ö–£_–ù–ê_–°–ö–†–ò–ü–¢"; 
        const WB_URL_SINGLE = "https://www.wildberries.ru/catalog/176733207/detail.aspx"; 
        const VALID_CODES = ["6433", "0309", "5528", "admin"]; // –î–æ–±–∞–≤–∏–ª admin –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --primary: #ff0055;
            --accent: #00ff88;
            --bg-grad-start: #1a0b0b;
            --bg-grad-end: #000000;
            --nav-height: 70px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: white; display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        /* –≠–ö–†–ê–ù–´ */
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; padding-bottom: 90px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        /* –ò–ì–†–û–í–û–ô –ö–†–£–ì */
        .score-circle {
            width: 220px; height: 220px; border-radius: 50%; border: 6px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 100px; font-weight: 900; margin: 20px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            text-shadow: 0 0 20px rgba(255,0,85,0.5);
            position: relative; z-index: 2; transition: all 0.1s;
        }
        
        .pulse { animation: pulse-anim 2s infinite ease-in-out; }
        @keyframes pulse-anim { 0% { border-color: #333; transform: scale(1); } 50% { border-color: #555; transform: scale(1.02); } 100% { border-color: #333; transform: scale(1); } }
        
        .hit { border-color: var(--primary) !important; box-shadow: 0 0 60px var(--primary), inset 0 0 20px var(--primary); color: #fff; animation: none; transform: scale(1.08); }
        
        /* –í–ò–ó–£–ê–õ–ò–ó–ê–¢–û–† */
        .volume-meter { width: 260px; height: 8px; background: #222; border-radius: 4px; margin-top: 15px; position: relative; overflow: hidden; }
        .volume-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.05s linear; box-shadow: 0 0 10px var(--accent); }
        .noise-gate { position: absolute; top:0; bottom:0; width: 2px; background: #ff0055; left: 0%; z-index: 5; opacity: 0.7; }

        /* –ö–ù–û–ü–ö–ò */
        button {
            padding: 18px; font-size: 16px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 16px;
            width: 100%; max-width: 280px; margin-top: 12px; cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 6px 20px rgba(255, 0, 85, 0.4); transition: transform 0.1s;
        }
        button:active { transform: scale(0.96); }
        .secondary-btn { background: transparent; border: 2px solid #333; color: #888; box-shadow: none; margin-top: 15px; padding: 14px; }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(15px);
            border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; padding-bottom: 10px; 
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: #555; font-size: 9px; font-weight: bold;
            background: none; border: none; box-shadow: none; padding: 0; margin: 0; width: auto; height: auto;
        }
        .nav-item.active-nav { color: var(--primary); text-shadow: 0 0 10px rgba(255,0,85,0.4); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; display: block; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-content { background: #161616; padding: 30px; border-radius: 24px; border: 1px solid #333; text-align: center; width: 85%; max-width: 320px; position: relative; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –°–õ–ê–ô–î–ï–†–´ –ò –≠–õ–ï–ú–ï–ù–¢–´ */
        .mode-selector { display: flex; gap: 8px; margin-bottom: 15px; width: 95%; max-width: 340px; background: #111; padding: 5px; border-radius: 14px; }
        .mode-btn { flex: 1; padding: 12px; background: transparent; border: none; color: #666; border-radius: 10px; font-size: 11px; font-weight: bold; box-shadow: none; margin: 0; }
        .mode-btn.active-mode { background: #222; color: white; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        
        input[type=range] { width: 100%; margin: 20px 0; accent-color: var(--primary); height: 6px; background: #333; border-radius: 3px; appearance: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; background: white; border-radius: 50%; box-shadow: 0 0 10px white; }

        .leader-row { display: flex; justify-content: space-between; padding: 15px; border-bottom: 1px solid #222; font-size: 14px; color: #ddd; }
        .leader-row:first-child { color: var(--accent); font-weight: bold; font-size: 16px; border-bottom: 1px solid var(--accent); }
    </style>
</head>
<body>

    <div id="bottomMenu" class="bottom-nav" style="display:none;">
        <button class="nav-item active-nav" id="navGame" onclick="switchScreen('game')"><span class="nav-icon">‚ö°Ô∏è</span>–ò–ì–†–ê</button>
        <button class="nav-item" id="navSkins" onclick="switchScreen('skins')"><span class="nav-icon">üéí</span>–°–ö–ò–ù–´</button>
        <button class="nav-item" id="navLeaders" onclick="switchScreen('leaders')"><span class="nav-icon">üèÜ</span>–¢–û–ü</button>
        <button class="nav-item" id="navSettings" onclick="switchScreen('settings')"><span class="nav-icon">‚öôÔ∏è</span>–ò–ù–§–û</button>
    </div>

    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content" style="border-color: var(--accent);">
            <div style="font-size: 40px; margin-bottom: 10px;">üèÜ</div>
            <h2 style="margin:0; color:white;">–ù–û–í–´–ô –†–ï–ö–û–†–î!</h2>
            <p style="color:#aaa; font-size:14px; margin-top:5px; margin-bottom:20px;">–¢—ã –º–∞—à–∏–Ω–∞! –û—Å—Ç–∞–≤—å –æ—Ç–∑—ã–≤, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω—Ä–∞–≤–∏—Ç—Å—è.</p>
            <button onclick="window.Telegram.WebApp.openLink(WB_URL_SINGLE)" style="background: var(--accent); color:black;">‚≠êÔ∏è –û–°–¢–ê–í–ò–¢–¨ –û–¢–ó–´–í</button>
            <button onclick="document.getElementById('reviewModal').style.display='none'" class="secondary-btn">–ó–ê–ö–†–´–¢–¨</button>
        </div>
    </div>

    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 3px; font-style: italic; margin-bottom:5px;">BOXBALL</h1>
        <div style="background: var(--primary); color:white; font-size:10px; padding: 2px 8px; border-radius:4px; font-weight:bold; margin-bottom:40px;">PRO EDITION</div>
        
        <input type="tel" id="passInput" placeholder="–ö–û–î –° –£–ü–ê–ö–û–í–ö–ò" style="padding:18px; border-radius:14px; border:1px solid #333; background:#111; color:white; text-align:center; font-size:20px; width:80%; outline:none; letter-spacing: 2px;">
        <button onclick="checkCode()">–í–û–ô–¢–ò</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; font-size:12px; margin-top:15px; opacity: 0.8;">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π 6433</p>
    </div>

    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢ 60s</button>
            <button class="mode-btn" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
        </div>

        <div style="font-size:70px; font-weight:bold; margin:10px 0; font-variant-numeric: tabular-nums;" id="timer">60</div>
        
        <div class="score-circle pulse" id="scoreDisplay">0</div>
        
        <div class="volume-meter">
            <div class="volume-bar" id="gameMicLevel"></div>
            <div class="noise-gate" id="visualGate"></div> 
        </div>
        <div style="font-size:10px; color:#444; margin-top:8px;">ALGORITHM: <span style="color:#00ff88">ADAPTIVE WAVE V2</span></div>

        <button id="startBtn" onclick="startGame()">–ù–ê–ß–ê–¢–¨</button>
    </div>

    <div id="screen-settings" class="screen">
        <h3>–ù–ê–°–¢–†–û–ô–ö–ò</h3>
        
        <div style="width:100%; text-align:left; background:#111; padding:20px; border-radius:16px; box-sizing:border-box;">
            <label style="font-size:12px; color:#aaa; display:flex; justify-content:space-between;">
                <span>–ß–£–í–°–¢–í–ò–¢–ï–õ–¨–ù–û–°–¢–¨</span>
                <span id="sensValDisplay" style="color:white;">50%</span>
            </label>
            <input type="range" id="sensRange" min="1" max="100" value="50" oninput="updateSens(this.value)">
            <p style="font-size:10px; color:#555; margin:0;">‚Üê –ú–µ–Ω—å—à–µ —à—É–º–∞ | –ë–æ–ª—å—à–µ –¥–∏—Å—Ç–∞–Ω—Ü–∏—è ‚Üí</p>
        </div>

        <div style="margin-top:20px; font-size:12px; color:#666; line-height:1.6;">
            –°–æ–≤–µ—Ç—ã –ø—Ä–æ—Ñ–∏:<br>
            1. –í–∫–ª—é—á–∏ –∑–≤—É–∫ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –Ω–∞ –º–∞–∫—Å–∏–º—É–º.<br>
            2. –ù–µ –∑–∞–∫—Ä—ã–≤–∞–π –º–∏–∫—Ä–æ—Ñ–æ–Ω —Ä—É–∫–æ–π.<br>
            3. –ë–µ–π —Ä–∏—Ç–º–∏—á–Ω–æ.
        </div>

        <button onclick="logout()" style="background:#220000; border:1px solid #500; color:#f55; margin-top:auto;">–í–´–ô–¢–ò –ò–ó –ê–ö–ö–ê–£–ù–¢–ê</button>
    </div>

    <div id="screen-save" class="screen">
        <div style="color:#aaa; font-size:14px; letter-spacing: 2px;">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h1 style="font-size:100px; margin:10px 0; color:white; text-shadow: 0 0 30px var(--primary);" id="finalScore">0</h1>
        <div id="newRecordBadge" style="color:var(--accent); font-weight:bold; margin-bottom:30px; font-size:18px;"></div>
        
        <input type="text" id="nickInput" placeholder="–¢–≤–æ–µ –∏–º—è" style="padding:15px; background:#111; border:1px solid #333; color:white; border-radius:12px; text-align:center; width: 70%;">
        <button onclick="saveScore()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button onclick="switchScreen('game')" class="secondary-btn">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <div id="screen-leaders" class="screen">
        <h3>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div id="leaderList" style="width:100%; text-align:left; overflow-y:auto; max-height:70vh;">
            <div style="padding:20px; color:#555;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>
    
    <div id="screen-skins" class="screen">
        <h3>–ú–ê–ì–ê–ó–ò–ù</h3>
        <p style="color:#666;">–°–∫–æ—Ä–æ –æ—Ç–∫—Ä—ã—Ç–∏–µ...</p>
        <div style="font-size:50px; opacity:0.3; margin-top:20px;">ü•ä ‚öΩÔ∏è üéæ</div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let audioContext = null;
        let mediaStream = null;
        let analyser = null;
        let scriptProcessor = null;
        
        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–≥—Ä–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
        let score = 0;
        let isGameRunning = false;
        let gameMode = 'sprint';
        let timeLeft = 60;
        let timerInterval = null;
        let personalBest = parseInt(localStorage.getItem('box_pb') || '0');

        // --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï AUDIO ENGINE V2 (ADAPTIVE) ---
        let noiseFloor = 0;       // –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å —à—É–º–∞
        let sensitivity = 50;     // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (1-100)
        let lastHitTime = 0;      // –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —É–¥–∞—Ä–∞ (debounce)
        const NOISE_ALPHA = 0.05; // –°–∫–æ—Ä–æ—Å—Ç—å –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∫ —à—É–º—É
        const MIN_VOL = 3;        // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ (noise gate)

        window.onload = () => {
            if(window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.enableClosingConfirmation();
            }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) {
                sensitivity = parseInt(savedSens);
                document.getElementById('sensRange').value = sensitivity;
                updateSensUI(sensitivity);
            }

            if(localStorage.getItem('box_auth') === 'true') switchScreen('game');
        };

        // --- –ê–£–î–ò–û –Ø–î–†–û (PRO VERSION) ---
        async function initAudio() {
            try {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') await audioContext.resume();

                const constraints = {
                    audio: {
                        echoCancellation: false, noiseSuppression: false, autoGainControl: false,
                        latency: 0
                    }
                };

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                const source = audioContext.createMediaStreamSource(mediaStream);

                // 1. BANDPASS FILTER (–í—ã–¥–µ–ª—è–µ–º —É–¥–∞—Ä)
                const bandPass = audioContext.createBiquadFilter();
                bandPass.type = 'bandpass';
                bandPass.frequency.value = 500; // –ß–∞—Å—Ç–æ—Ç–∞ "—à–ª–µ–ø–∫–∞"
                bandPass.Q.value = 1.0;

                // 2. COMPRESSOR (–í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –¥–∏–Ω–∞–º–∏–∫—É)
                const compressor = audioContext.createDynamicsCompressor();
                compressor.threshold.value = -50;
                compressor.knee.value = 40;
                compressor.ratio.value = 12;
                compressor.attack.value = 0;
                compressor.release.value = 0.25;

                // 3. ANALYSER
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;

                // –¶–µ–ø–æ—á–∫–∞
                source.connect(bandPass);
                bandPass.connect(compressor);
                compressor.connect(analyser);

                // –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä
                scriptProcessor = audioContext.createScriptProcessor(512, 1, 1);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                scriptProcessor.onaudioprocess = processAudioLogic;
                
                return true;
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: " + e.message);
                return false;
            }
        }

        function processAudioLogic() {
            if (!isGameRunning) return;

            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(array);

            // 1. –ü–æ–∏—Å–∫ –ø–∏–∫–∞ (Peak Detection) –≤–º–µ—Å—Ç–æ RMS
            let maxVal = 0;
            for (let i = 0; i < array.length; i++) {
                let val = Math.abs(array[i] - 128);
                if (val > maxVal) maxVal = val;
            }

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
            const meter = document.getElementById('gameMicLevel');
            const visualVal = Math.min(maxVal * 4, 100);
            if(meter) meter.style.width = visualVal + "%";

            // 2. –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ—Ä–æ–≥–∞ —à—É–º–∞
            // –ü–ª–∞–≤–Ω–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ñ–æ–Ω–∞
            noiseFloor = (noiseFloor * (1 - NOISE_ALPHA)) + (maxVal * NOISE_ALPHA);

            // 3. –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Ä–æ–≥–∞
            // sensitivity 1..100 -> –º–Ω–æ–∂–∏—Ç–µ–ª—å –æ—Ç 1.2 –¥–æ 4.0
            // –ú–µ–Ω—å—à–µ sens = –±–æ–ª—å—à–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å (—Ç—è–∂–µ–ª–µ–µ –ø—Ä–æ–±–∏—Ç—å)
            // –ë–æ–ª—å—à–µ sens = –º–µ–Ω—å—à–µ –º–Ω–æ–∂–∏—Ç–µ–ª—å (–ª–µ–≥—á–µ –ø—Ä–æ–±–∏—Ç—å)
            // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –¥–ª—è UX: 100% = –º–∞–∫—Å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å = –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥
            
            const inverseSens = (100 - sensitivity) / 100; // 0..1
            const thresholdMultiplier = 1.2 + (inverseSens * 3.0); 
            
            const dynamicThreshold = noiseFloor * thresholdMultiplier;
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ä–æ–≥–∞ (–∫—Ä–∞—Å–Ω–∞—è —á–µ—Ä—Ç–∞)
            const gateEl = document.getElementById('visualGate');
            if(gateEl) gateEl.style.left = Math.min(dynamicThreshold * 4, 100) + "%";

            // 4. –î–µ—Ç–µ–∫—Ü–∏—è —É–¥–∞—Ä–∞
            if (maxVal > dynamicThreshold && maxVal > MIN_VOL) {
                let now = Date.now();
                // –ö—É–ª–¥–∞—É–Ω 90–º—Å (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö —É–¥–∞—Ä–æ–≤, –Ω–æ —Ä–µ–∂–µ—Ç –¥–≤–æ–π–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è)
                if (now - lastHitTime > 90) { 
                    registerHit();
                    lastHitTime = now;
                    
                    // –•–∞–∫: —Ä–µ–∑–∫–æ –ø–æ–¥–Ω–∏–º–∞–µ–º —à—É–º, —á—Ç–æ–±—ã —Ö–≤–æ—Å—Ç —ç—Ç–æ–≥–æ –∂–µ —É–¥–∞—Ä–∞ –Ω–µ —Å—á–∏—Ç–∞–ª—Å—è –∑–∞ –Ω–æ–≤—ã–π
                    noiseFloor = maxVal; 
                }
            }
        }

        function stopAudio() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
        }

        // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
        async function startGame() {
            // Wake Lock
            if ('wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); } catch(e) {}
            }

            const inited = await initAudio();
            if(!inited) return;

            // –°–±—Ä–æ—Å UI
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('bottomMenu').style.display = 'none';
            document.getElementById('scoreDisplay').classList.remove('pulse');
            
            score = 0;
            noiseFloor = 5; // –°–±—Ä–æ—Å —É—Ä–æ–≤–Ω—è —à—É–º–∞ –Ω–∞ —Å—Ç–∞—Ä—Ç
            document.getElementById('scoreDisplay').innerText = "0";
            timeLeft = (gameMode === 'survival') ? 10 : 60;
            
            isGameRunning = true;
            
            // –¢–∞–π–º–µ—Ä
            timerInterval = setInterval(() => {
                if (gameMode === 'sprint') {
                    timeLeft--;
                } else {
                    timeLeft -= 1; 
                }
                
                document.getElementById('timer').innerText = Math.max(0, Math.floor(timeLeft));

                if (timeLeft <= 0) finishGame();
            }, 1000);
        }

        function registerHit() {
            score++;
            const el = document.getElementById('scoreDisplay');
            el.innerText = score;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è
            el.classList.add('hit');
            // –í–∏–±—Ä–∞—Ü–∏—è (Haptic)
            if(window.navigator.vibrate) window.navigator.vibrate(15); 
            
            setTimeout(() => { el.classList.remove('hit'); }, 80);

            // –í—ã–∂–∏–≤–∞–Ω–∏–µ
            if (gameMode === 'survival') {
                timeLeft += 0.6; // +0.6 —Å–µ–∫ –∑–∞ —É–¥–∞—Ä
                if(timeLeft > 15) timeLeft = 15;
                document.getElementById('timer').innerText = Math.floor(timeLeft);
            }
        }

        function finishGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            stopAudio();

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∫–æ—Ä–¥–∞
            if (score > personalBest && score > 5) {
                localStorage.setItem('box_pb', score);
                personalBest = score;
                document.getElementById('newRecordBadge').innerText = "üî• –ù–û–í–´–ô –†–ï–ö–û–†–î!";
                setTimeout(() => { document.getElementById('reviewModal').style.display = 'flex'; }, 800);
            } else {
                document.getElementById('newRecordBadge').innerText = "";
            }

            document.getElementById('finalScore').innerText = score;
            switchScreen('save');
            
            // –í–æ–∑–≤—Ä–∞—Ç UI
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('scoreDisplay').classList.add('pulse');
        }

        // --- UI –§–£–ù–ö–¶–ò–ò ---
        function updateSens(val) {
            sensitivity = parseInt(val);
            updateSensUI(sensitivity);
            localStorage.setItem('box_sens', sensitivity);
        }

        function updateSensUI(val) {
            document.getElementById('sensValDisplay').innerText = val + "%";
        }

        function switchScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            const menu = document.getElementById('bottomMenu');
            menu.style.display = (name === 'login' || name === 'game') ? 'none' : 'flex';
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
            const map = { 'game': 'navGame', 'skins': 'navSkins', 'leaders': 'navLeaders', 'settings': 'navSettings' };
            if(map[name]) document.getElementById(map[name]).classList.add('active-nav');

            document.getElementById('screen-' + name).classList.add('active');
            
            if(name === 'leaders') loadLeaders();
        }

        function checkCode() {
            const val = document.getElementById('passInput').value;
            if(VALID_CODES.includes(val)) {
                localStorage.setItem('box_auth', 'true');
                switchScreen('game');
            } else {
                document.getElementById('errorMsg').style.display = 'block';
                // –ê–Ω–∏–º–∞—Ü–∏—è –æ—à–∏–±–∫–∏
                const inp = document.getElementById('passInput');
                inp.style.borderColor = 'red';
                setTimeout(()=>inp.style.borderColor = '#333', 500);
            }
        }
        
        function logout() { localStorage.removeItem('box_auth'); location.reload(); }
        function setMode(m) { gameMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-mode')); event.target.classList.add('active-mode'); }
        
        // --- –ë–≠–ö–ï–ù–î (Google Sheets) ---
        function saveScore() {
            const name = document.getElementById('nickInput').value || "–ë–æ–∫—Å–µ—Ä";
            const btn = event.target;
            btn.innerText = "–°–û–•–†–ê–ù–ï–ù–ò–ï...";
            
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫–∞
            // –ü–æ–∫–∞ –∏–º–∏—Ç–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞
            setTimeout(() => {
                switchScreen('leaders');
                btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨";
            }, 500);

            // –ï—Å–ª–∏ –µ—Å—Ç—å URL —Å–∫—Ä–∏–ø—Ç–∞, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π:
            /*
            fetch(GOOGLE_SCRIPT_URL, { 
                method: "POST", mode: "no-cors", 
                body: JSON.stringify({ name: name, score: score, mode: gameMode }) 
            });
            */
        }
        
        function loadLeaders() {
            const list = document.getElementById('leaderList');
            // –§–µ–π–∫–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ, –ø–æ–∫–∞ –Ω–µ—Ç –±—ç–∫–µ–Ω–¥–∞
            const fakeData = [
                {name: "–¢–∞–π—Å–æ–Ω", score: 320},
                {name: "–ê–ª–∏", score: 295},
                {name: "–¢—ã", score: personalBest}
            ];
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            fakeData.sort((a,b) => b.score - a.score);

            list.innerHTML = "";
            fakeData.forEach((r, i) => {
                let color = i === 0 ? "gold" : (i === 1 ? "silver" : "#ddd");
                list.innerHTML += `<div class="leader-row" style="color:${color}"><span>#${i+1} ${r.name}</span><b>${r.score}</b></div>`;
            });
            
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –±—ç–∫–µ–Ω–¥:
            /*
            fetch(GOOGLE_SCRIPT_URL + "?mode=" + gameMode)
            .then(r => r.json())
            .then(data => { ...–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ... });
            */
        }
    </script>
</body>
</html>
