<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Pro Max</title>
    
    <script>
        const GOOGLE_SCRIPT_URL = "ВСТАВЬТЕ_СЮДА_ВАШУ_ССЫЛКУ_ИЗ_GOOGLE"; 
        const POLICY_URL = "https://docs.google.com/document/d/ВАША_ССЫЛКА_НА_ПРАВИЛА";
        const VALID_CODES = ["6433", "0309", "5528"];
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --primary: #ff0055; --bg-grad-start: #1a0b0b; --bg-grad-end: #000000; --text-color: white; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: var(--text-color); display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; box-sizing: border-box; }
        .active { display: flex; }

        /* ИГРОВОЙ КРУГ */
        .score-circle {
            width: 210px; height: 210px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 10px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: all 0.1s;
        }
        .hit { border-color: var(--primary); box-shadow: 0 0 50px var(--primary); color: var(--primary); transform: scale(1.05); }

        /* Визуализатор */
        .energy-bar-container { width: 200px; height: 6px; background: #333; border-radius: 3px; margin-top: 20px; position: relative; overflow: hidden; }
        .energy-bar-fill { height: 100%; width: 0%; background: #00ff88; transition: width 0.05s linear; }

        button { padding: 16px 0; font-size: 17px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 14px; width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer; text-transform: uppercase; }
        button:disabled { background: #444; color: #888; }

        /* Настройки */
        .settings-panel { background: rgba(30,30,30,0.95); border: 1px solid #555; padding: 20px; border-radius: 15px; position: absolute; top: 20%; z-index: 100; display: none; width: 80%; }
        input[type=range] { width: 100%; margin: 15px 0; accent-color: var(--primary); }
    </style>
</head>
<body>

    <video id="noSleepVideo" playsinline muted loop style="display:none;">
        <source src="data:video/mp4;base64,AAAAHGZ0eXBNNBB..." type="video/mp4"> 
        </video>

    <div id="screen-login" class="screen active">
        <h1>BOXBALL</h1>
        <p style="color:#666; font-size:12px;">V3.1 FIXED FREQUENCY</p>
        <input type="text" id="passInput" placeholder="КОД" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:16px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">ВОЙТИ</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px;">Неверный код</p>
    </div>

    <div id="screen-game" class="screen">
        <div style="font-size:42px; font-weight:bold; color:#fff;" id="timer">60</div>
        <div style="font-size:12px; color:#aaa; cursor:pointer; margin-bottom:10px;" onclick="toggleSettings()">⚙️ Чувствительность</div>

        <div class="settings-panel" id="settingsPanel">
            <h3>НАСТРОЙКИ</h3>
            <label style="color:#ccc;">Чувствительность: <span id="sensVal">5</span></label>
            <input type="range" id="sensRange" min="1" max="10" value="5" oninput="updateSens(this.value)">
            <p style="font-size:10px; color:#666;">1 = Ловит шепот<br>10 = Ловит кувалду</p>
            <button onclick="toggleSettings()" style="background:#444;">ЗАКРЫТЬ</button>
        </div>
        
        <div class="score-circle" id="scoreDisplay">0</div>
        
        <div class="energy-bar-container"><div class="energy-bar-fill" id="energyBar"></div></div>
        <div style="font-size: 10px; color: #666; font-family: monospace; margin-top: 5px;" id="debugStr">Ready</div>

        <button id="startBtn">НАЧАТЬ РАУНД</button>
    </div>

    <div id="screen-save" class="screen">
        <div style="font-size:14px; color:#aaa;">РЕЗУЛЬТАТ</div>
        <h1 style="font-size:80px; color:var(--primary);" id="finalScore">0</h1>
        <input type="text" id="nicknameInput" placeholder="Имя" style="padding:14px; background:#222; border:1px solid #444; color:white; border-radius:12px; text-align:center; width:80%; margin-bottom:10px;">
        <button id="saveBtn" onclick="saveScore()">СОХРАНИТЬ</button>
        <button onclick="location.reload()" style="background:transparent; border:1px solid #555; margin-top:10px;">ЗАНОВО</button>
    </div>

    <script>
        // === КОНСТАНТЫ V3.1 ===
        // Исправленная частота: ловим от 350Гц (чтобы поймать пик 546Гц)
        const FILTER_FREQ = 350; 
        const DEBOUNCE_TIME = 150; // Пауза после удара
        const SELF_MUTE_TIME = 120; // Пауза после нашего звука

        // Меньший буфер = быстрее реакция (11мс вместо 46мс)
        const BUFFER_SIZE = 512; 

        let SENSITIVITY = 5; 
        let SLOPE_THRESHOLD = 0.03; 

        let score = 0, isRunning = false, timeLeft = 60;
        let audioCtx, analyser, microphone, scriptProcessor;
        let lastEnergy = 0, lastHitTime = 0;
        let isMutedByApp = false;
        let timerInterval;

        // === ИНИЦИАЛИЗАЦИЯ ===
        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.expand();
            const savedSens = localStorage.getItem('box_sens_v3');
            if(savedSens) updateSens(savedSens);
        };

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
        function checkCode() { if(VALID_CODES.includes(document.getElementById('passInput').value.trim())) showScreen('screen-game'); else document.getElementById('errorMsg').style.display = 'block'; }
        function toggleSettings() { const el = document.getElementById('settingsPanel'); el.style.display = (el.style.display==='block')?'none':'block'; }

        function updateSens(val) {
            SENSITIVITY = parseInt(val);
            document.getElementById('sensVal').innerText = SENSITIVITY;
            document.getElementById('sensRange').value = SENSITIVITY;
            // 1 -> 0.005 (Супер чутко), 5 -> 0.03 (Норм), 10 -> 0.1 (Жестко)
            SLOPE_THRESHOLD = 0.005 + ((SENSITIVITY - 1) * 0.01);
            localStorage.setItem('box_sens_v3', SENSITIVITY);
        }

        // === ГЛАВНЫЙ АУДИО КОД ===
        document.getElementById('startBtn').addEventListener('click', async () => {
            if(isRunning) return;
            
            // Хак для No Sleep (воспроизводим невидимое видео)
            // Это нужно, чтобы iPhone не уснул через минуту
            const video = document.getElementById('noSleepVideo');
            video.src = "https://www.w3schools.com/html/mov_bbb.mp4"; // Маленький заглушечный файл, можно заменить на base64
            video.volume = 0;
            video.play().catch(()=>{});

            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();

                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false, latency: 0 }
                });

                // 1. Создаем узлы
                microphone = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                const filter = audioCtx.createBiquadFilter();
                const gainNode = audioCtx.createGain();

                // 2. Настройка: ЛОВИМ 546 Гц!
                filter.type = 'highpass';
                filter.frequency.value = FILTER_FREQ; // 350Hz (пропустит 546Hz)

                gainNode.gain.value = 6.0; // Усиливаем в 6 раз (для тихих iPhone)

                // 3. Цепь: Mic -> Filter -> Gain -> Analyser
                microphone.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(analyser);

                // 4. Процессор с МАЛЕНЬКИМ буфером (512)
                scriptProcessor = audioCtx.createScriptProcessor(BUFFER_SIZE, 1, 1);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioCtx.destination);

                scriptProcessor.onaudioprocess = processAudio;

                // Старт таймера
                score = 0; document.getElementById('scoreDisplay').innerText = 0;
                timeLeft = 60; isRunning = true;
                document.getElementById('startBtn').style.display = 'none';

                timerInterval = setInterval(() => {
                    timeLeft--;
                    document.getElementById('timer').innerText = timeLeft;
                    if(timeLeft <= 0) finishGame();
                }, 1000);

            } catch (e) { alert("Ошибка Mic: " + e); }
        });

        function processAudio(e) {
            if(!isRunning || isMutedByApp) return;

            const buf = e.inputBuffer.getChannelData(0);
            let sum = 0;
            // Считаем RMS (энергию)
            for(let i=0; i<buf.length; i++) sum += buf[i]*buf[i];
            const rms = Math.sqrt(sum / buf.length);

            // Детектор "Взрыва" (Slope)
            const slope = rms - lastEnergy;
            
            // Визуал
            const vis = Math.min(slope * 400, 100);
            document.getElementById('energyBar').style.width = Math.max(vis,0) + "%";
            document.getElementById('debugStr').innerText = `Slope: ${slope.toFixed(3)} / ${SLOPE_THRESHOLD.toFixed(3)}`;

            const now = Date.now();
            if (slope > SLOPE_THRESHOLD && (now - lastHitTime > DEBOUNCE_TIME)) {
                registerHit();
                lastHitTime = now;
            }
            lastEnergy = rms;
        }

        function registerHit() {
            score++;
            const el = document.getElementById('scoreDisplay');
            el.innerText = score;
            el.classList.add('hit');
            setTimeout(()=>el.classList.remove('hit'), 100);
            playBeep();
        }

        function playBeep() {
            isMutedByApp = true; // Глушим микрофон
            setTimeout(() => isMutedByApp = false, SELF_MUTE_TIME);

            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            
            // Короткий "клик" на 1000Гц
            o.frequency.setValueAtTime(1000, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.08);
            o.start(); o.stop(audioCtx.currentTime + 0.08);
        }

        function finishGame() {
            isRunning = false; clearInterval(timerInterval);
            if(scriptProcessor) { scriptProcessor.disconnect(); microphone.disconnect(); }
            document.getElementById('finalScore').innerText = score;
            showScreen('screen-save');
        }

        function saveScore() {
            const name = document.getElementById('nicknameInput').value;
            if(!name) return alert("Введи имя");
            document.getElementById('saveBtn').innerText = "ОТПРАВЛЕНО";
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST", mode: "no-cors",
                body: JSON.stringify({name: name, score: score, date: new Date().toLocaleDateString()})
            });
        }
    </script>
</body>
</html>
