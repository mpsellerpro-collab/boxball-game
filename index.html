<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Pro</title>
    
    <script>
        const GOOGLE_SCRIPT_URL = "–í–°–¢–ê–í–¨_–°–Æ–î–ê_–°–°–´–õ–ö–£_–ù–ê_–°–ö–†–ò–ü–¢"; 
        const POLICY_URL = "https://docs.google.com/document/d/–í–ê–®–ê_–°–°–´–õ–ö–ê";
        const WB_URL_SINGLE = "https://www.wildberries.ru/catalog/176733207/detail.aspx"; 
        const WB_URL_SET = "https://www.wildberries.ru/catalog/237586968/detail.aspx";    
        const VALID_CODES = ["6433", "0309", "5528"];
        const CHANNEL_URL = "https://t.me/DUROV";
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #ff0055;
            --accent: #ffcc00;
            --bg-grad-start: #1a0b0b;
            --bg-grad-end: #000000;
            --nav-height: 70px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: white; display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; padding-bottom: 90px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        /* –ò–ì–†–û–í–û–ô –ö–†–£–ì */
        .score-circle {
            width: 210px; height: 210px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 20px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: border-color 0.1s; position: relative; z-index: 2;
        }
        
        .pulse { animation: pulse-anim 2s infinite ease-in-out; }
        @keyframes pulse-anim { 0% { transform: scale(1); border-color: #333; } 50% { transform: scale(1.02); border-color: #555; } 100% { transform: scale(1); border-color: #333; } }
        
        .hit { border-color: var(--primary) !important; box-shadow: 0 0 50px var(--primary); color: var(--primary); animation: none; transform: scale(1.05); }
        .shake { animation: shake-anim 0.1s; }
        @keyframes shake-anim { 0% { transform: translate(2px, 2px); } 50% { transform: translate(-2px, -2px); } 100% { transform: translate(0, 0); } }

        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä */
        .volume-meter { width: 240px; height: 10px; background: #222; border-radius: 5px; margin-top: 10px; position: relative; overflow: hidden; }
        .volume-bar { height: 100%; background: #00ff88; width: 0%; transition: width 0.05s; }
        .volume-threshold { position: absolute; top:0; bottom:0; width: 2px; background: #ff0055; left: 0%; z-index: 5; }

        /* –ö–ù–û–ü–ö–ò */
        button {
            padding: 16px; font-size: 16px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #444; color: #888; cursor: not-allowed; box-shadow: none; }
        .secondary-btn { background: transparent; border: 1px solid #444; color: #aaa; margin-top: 15px; padding: 12px; font-size: 12px; }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(15, 15, 15, 0.95); backdrop-filter: blur(10px);
            border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; padding-bottom: 10px; 
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: #666; font-size: 9px; font-weight: bold;
            background: none; border: none; box-shadow: none; padding: 5px; margin: 0; width: auto;
        }
        .nav-item.active-nav { color: var(--primary); }
        .nav-icon { font-size: 24px; margin-bottom: 3px; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 20px; border: 1px solid var(--primary); text-align: center; width: 85%; max-width: 320px; }
        
        /* –ö–ê–õ–ò–ë–†–û–í–ö–ê */
        .calib-circle { width: 150px; height: 150px; border: 4px solid #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; color: #00ff88; margin: 0 auto 20px; }
        
        /* –°—Ç–∏–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; width: 95%; max-width: 340px; }
        .mode-btn { flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #aaa; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .mode-btn.active-mode { background: var(--primary); color: white; border-color: var(--primary); }
        
        input[type=range] { width: 100%; margin: 15px 0; accent-color: var(--primary); }
        .leader-row { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid #333; font-size: 14px; }
        
        .confetti { position: absolute; width: 10px; height: 10px; background: #f00; animation: fall 3s linear forwards; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
    </style>
</head>
<body>

    <div id="bottomMenu" class="bottom-nav" style="display:none;">
        <button class="nav-item active-nav" id="navGame" onclick="switchScreen('game')"><span class="nav-icon">ü•ä</span>–ò–ì–†–ê</button>
        <button class="nav-item" id="navSkins" onclick="switchScreen('skins')"><span class="nav-icon">üéí</span>–°–ö–ò–ù–´</button>
        <button class="nav-item" id="navLeaders" onclick="switchScreen('leaders')"><span class="nav-icon">üèÜ</span>–¢–û–ü</button>
        <button class="nav-item" id="navSettings" onclick="switchScreen('settings')"><span class="nav-icon">‚öôÔ∏è</span>–û–ü–¶–ò–ò</button>
    </div>

    <div id="calibModal" class="modal-overlay" style="z-index: 300;">
        <div class="modal-content" style="border-color: #00ff88;">
            <h2 style="color:#00ff88; margin:0;">–ù–ê–°–¢–†–û–ô–ö–ê</h2>
            <p style="color:#aaa; font-size:12px; margin-bottom:20px;">–ë–µ–π –ø–æ –º—è—á—É –≤ —Å–≤–æ–µ–º —Ç–µ–º–ø–µ.<br>–ú—ã –∑–∞–ø–æ–º–Ω–∏–º —Å–∏–ª—É —É–¥–∞—Ä–∞.</p>
            <div class="calib-circle" id="calibTimer">15</div>
            <div class="volume-meter"><div class="volume-bar" id="calibBarVisual"></div></div>
            <p id="calibStatus" style="font-size:10px; margin-top:10px; color:#666;">–°–ª—É—à–∞–µ–º...</p>
        </div>
    </div>

    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div style="font-size: 30px; margin-bottom: 10px;">üèÜ –†–ï–ö–û–†–î!</div>
            <p style="color:#ccc; font-size:14px;">–¢—ã —Ä–∞–∑–Ω–µ—Å —ç—Ç–æ—Ç –º—è—á! üî•<br>–ü–æ–¥–µ–ª–∏—Å—å –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏—è–º–∏?</p>
            <button onclick="window.Telegram.WebApp.openLink(WB_URL_SINGLE)" style="background: var(--accent); color:black; margin-bottom:10px;">‚≠êÔ∏è –û–°–¢–ê–í–ò–¢–¨ –û–¢–ó–´–í</button>
            <button onclick="document.getElementById('reviewModal').style.display='none'" class="secondary-btn" style="margin-top:0;">–ü–û–ó–ñ–ï</button>
        </div>
    </div>

    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px;">BOXBALL PRO</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 30px;">AUDIO ENGINE V3.0</p>
        <input type="tel" id="passInput" placeholder="–ö–û–î (–ü–û–î –®–¢–†–ò–•–ö–û–î–û–ú)" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:18px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; font-size:12px; margin-top:10px;">–ö–æ–¥: 6433, 0309 –∏–ª–∏ 5528</p>
    </div>

    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
        </div>

        <div style="font-size:60px; font-weight:bold; margin:10px 0;" id="timer">60</div>
        
        <div class="score-circle pulse" id="scoreDisplay">0</div>
        
        <div class="volume-meter">
            <div class="volume-bar" id="gameMicLevel"></div>
            <div class="volume-threshold" id="gameMicThresh"></div>
        </div>
        <div style="font-size:10px; color:#555; margin-top:5px;">SENSITIVITY: <span id="debugSens">0</span></div>

        <button id="startBtn">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
    </div>

    <div id="screen-settings" class="screen">
        <h3>–ù–ê–°–¢–†–û–ô–ö–ò</h3>
        <button onclick="startCalibration()" style="background: linear-gradient(90deg, #00ff88, #008844); color:black;">ü™Ñ –ö–ê–õ–ò–ë–†–û–í–ö–ê (15 —Å–µ–∫)</button>
        
        <div style="width:100%; text-align:left; margin-top:20px;">
            <label style="font-size:12px; color:#aaa;">–†—É—á–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <span id="sensValDisplay">15</span></label>
            <input type="range" id="sensRange" min="5" max="100" value="15" oninput="updateSens(this.value)">
        </div>

        <button onclick="logout()" style="background:#330000; border:1px solid red; color:red; margin-top:30px;">–í–´–ô–¢–ò</button>
    </div>

    <div id="screen-save" class="screen">
        <div style="color:#aaa;">–†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h1 style="font-size:80px; margin:0; color:var(--primary);" id="finalScore">0</h1>
        <div id="newRecordBadge" style="color:var(--accent); font-weight:bold; margin-bottom:15px;"></div>
        
        <input type="text" id="nickInput" placeholder="–¢–≤–æ–µ –∏–º—è" style="padding:15px; background:#222; border:1px solid #444; color:white; border-radius:10px; text-align:center;">
        <button onclick="saveScore()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button onclick="switchScreen('game')" class="secondary-btn">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <div id="screen-leaders" class="screen">
        <h3>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div id="leaderList" style="width:100%; text-align:left;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
    
    <div id="screen-skins" class="screen">
        <h3>–ú–ê–ì–ê–ó–ò–ù</h3>
        <p style="color:#666;">–°–∫–æ—Ä–æ...</p>
    </div>

    <script>
        // –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï
        let audioContext = null;
        let mediaStream = null;
        let analyser = null;
        let scriptProcessor = null;
        let sensitivity = 15; // –ü–æ—Ä–æ–≥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let score = 0;
        let isGameRunning = false;
        let gameMode = 'sprint';
        let timeLeft = 60;
        let timerInterval = null;
        let lastHitTime = 0;
        let personalBest = 0;

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = () => {
            if(window.Telegram && window.Telegram.WebApp) window.Telegram.WebApp.expand();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) sensitivity = parseInt(savedSens);
            updateSensUI(sensitivity);

            personalBest = parseInt(localStorage.getItem('box_pb')) || 0;

            if(localStorage.getItem('box_auth') === 'true') switchScreen('game');
        };

        // --- –ê–£–î–ò–û –î–í–ò–ñ–û–ö (–ì–õ–ê–í–ù–ê–Ø –ß–ê–°–¢–¨) ---
        async function initAudio() {
            try {
                // 1. –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') await audioContext.resume();

                // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Android (–æ—Ç–∫–ª—é—á–∞–µ–º —à—É–º–æ–¥–∞–≤)
                const constraints = {
                    audio: {
                        echoCancellation: false, noiseSuppression: false, autoGainControl: false,
                        googEchoCancellation: false, googAutoGainControl: false, googNoiseSuppression: false, googHighpassFilter: false,
                        latency: 0
                    }
                };

                // 3. –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ç–æ–∫
                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                const source = audioContext.createMediaStreamSource(mediaStream);

                // 4. –¶–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏:
                // Source -> HighPass (—É–±—Ä–∞—Ç—å –≥—É–ª) -> Gain (—É—Å–∏–ª–∏—Ç—å) -> LowPass (—É–±—Ä–∞—Ç—å –ø–∏—Å–∫) -> Analyser
                
                const highPass = audioContext.createBiquadFilter();
                highPass.type = 'highpass'; highPass.frequency.value = 50; // –£–±–∏—Ä–∞–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π –≥—É–ª

                const gainNode = audioContext.createGain();
                gainNode.gain.value = 4.0; // –£—Å–∏–ª–∏–≤–∞–µ–º –≤ 4 —Ä–∞–∑–∞ (–¥–ª—è —Ç–∏—Ö–∏—Ö –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤)

                const lowPass = audioContext.createBiquadFilter();
                lowPass.type = 'lowpass'; lowPass.frequency.value = 800; // –õ–æ–≤–∏–º —â–µ–ª—á–æ–∫ —É–¥–∞—Ä–∞

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;

                // –°–æ–µ–¥–∏–Ω—è–µ–º
                source.connect(highPass);
                highPass.connect(gainNode);
                gainNode.connect(lowPass);
                lowPass.connect(analyser);

                // –ü—Ä–æ—Ü–µ—Å—Å–æ—Ä –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö
                scriptProcessor = audioContext.createScriptProcessor(1024, 1, 1);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                // –õ–û–ì–ò–ö–ê –û–ë–†–ê–ë–û–¢–ö–ò –í –†–ï–ê–õ–¨–ù–û–ú –í–†–ï–ú–ï–ù–ò
                scriptProcessor.onaudioprocess = processAudio;
                
                return true;

            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + e.message);
                return false;
            }
        }

        function processAudio() {
            if (!isGameRunning && !isCalibrating) return;

            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteTimeDomainData(array);

            let sum = 0;
            for (let i = 0; i < array.length; i++) {
                let x = array[i] - 128;
                sum += x * x;
            }
            let rms = Math.sqrt(sum / array.length); // –ì—Ä–æ–º–∫–æ—Å—Ç—å (0-128 –ø—Ä–∏–º–µ—Ä–Ω–æ)
            let val = Math.floor(rms);

            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
            const meter = isCalibrating ? document.getElementById('calibBarVisual') : document.getElementById('gameMicLevel');
            if(meter) meter.style.width = Math.min(val * 2, 100) + "%";
            
            if(isCalibrating) {
                calibrationData.push(val);
                return;
            }

            // --- –î–ï–¢–ï–ö–¢–û–† –£–î–ê–†–ê ---
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Ä–æ–≥ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
            if (val > sensitivity) {
                let now = Date.now();
                if (now - lastHitTime > 120) { // –ó–∞–¥–µ—Ä–∂–∫–∞ 120–º—Å –º–µ–∂–¥—É —É–¥–∞—Ä–∞–º–∏
                    registerHit();
                    lastHitTime = now;
                }
            }
        }

        function stopAudio() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
        }

        // --- –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ---
        async function startGame() {
            // Wake Lock (—á—Ç–æ–±—ã —ç–∫—Ä–∞–Ω –Ω–µ –≥–∞—Å)
            if ('wakeLock' in navigator) {
                try { await navigator.wakeLock.request('screen'); } catch(e) {}
            }

            const inited = await initAudio();
            if(!inited) return;

            // UI
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('bottomMenu').style.display = 'none';
            document.getElementById('scoreDisplay').classList.remove('pulse');
            
            score = 0;
            document.getElementById('scoreDisplay').innerText = "0";
            timeLeft = (gameMode === 'survival') ? 10 : 60;
            
            isGameRunning = true;
            
            // –¢–∞–π–º–µ—Ä
            timerInterval = setInterval(() => {
                if (gameMode === 'sprint') {
                    timeLeft--;
                } else {
                    timeLeft -= 1; // –í –≤—ã–∂–∏–≤–∞–Ω–∏–∏ —Ç–∞–π–º–µ—Ä –∏–¥–µ—Ç –≤–Ω–∏–∑, —É–¥–∞—Ä—ã –¥–æ–±–∞–≤–ª—è—é—Ç –≤—Ä–µ–º—è
                }
                
                document.getElementById('timer').innerText = Math.floor(timeLeft);

                if (timeLeft <= 0) finishGame();
            }, 1000);
        }

        function registerHit() {
            score++;
            const el = document.getElementById('scoreDisplay');
            el.innerText = score;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è —É–¥–∞—Ä–∞
            el.classList.add('hit');
            el.classList.add('shake');
            setTimeout(() => {
                el.classList.remove('hit');
                el.classList.remove('shake');
            }, 100);

            // –õ–æ–≥–∏–∫–∞ –≤—ã–∂–∏–≤–∞–Ω–∏—è
            if (gameMode === 'survival') {
                timeLeft += 0.5; // +0.5 —Å–µ–∫ –∑–∞ —É–¥–∞—Ä
                if(timeLeft > 10) timeLeft = 10;
                document.getElementById('timer').innerText = Math.floor(timeLeft);
            }
        }

        function finishGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            stopAudio(); // üõë –í–ê–ñ–ù–û: –í—ã–∫–ª—é—á–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∫–æ—Ä–¥–∞ –∏ –¢—Ä–∏–≥–≥–µ—Ä –†–∞–¥–æ—Å—Ç–∏
            if (score > personalBest && score > 10) {
                localStorage.setItem('box_pb', score);
                personalBest = score;
                document.getElementById('newRecordBadge').innerText = "üî• –ù–û–í–´–ô –†–ï–ö–û–†–î!";
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ –æ—Ç–∑—ã–≤–∞!
                setTimeout(() => { document.getElementById('reviewModal').style.display = 'flex'; }, 500);
            } else {
                document.getElementById('newRecordBadge').innerText = "";
            }

            document.getElementById('finalScore').innerText = score;
            switchScreen('save');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º UI
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('scoreDisplay').classList.add('pulse');
        }

        // --- –ö–ê–õ–ò–ë–†–û–í–ö–ê (–û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø) ---
        let isCalibrating = false;
        let calibrationData = [];

        async function startCalibration() {
            document.getElementById('calibModal').style.display = 'flex';
            calibrationData = [];
            
            const inited = await initAudio(); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¢–û–¢ –ñ–ï –¥–≤–∏–∂–æ–∫
            if(!inited) return;

            isCalibrating = true;
            let calTime = 15;
            
            const calInt = setInterval(() => {
                calTime--;
                document.getElementById('calibTimer').innerText = calTime;
                if(calTime <= 0) {
                    clearInterval(calInt);
                    finishCalibration();
                }
            }, 1000);
        }

        function finishCalibration() {
            isCalibrating = false;
            stopAudio();
            document.getElementById('calibModal').style.display = 'none';

            if (calibrationData.length === 0) return;

            // –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∏ –ø–∏–∫–∏
            // –û—Ç—Å–µ–∏–≤–∞–µ–º —Ç–∏—à–∏–Ω—É (–≤—Å–µ —á—Ç–æ < 3)
            const loudSamples = calibrationData.filter(v => v > 3);
            if (loudSamples.length < 10) {
                alert("–ë—ã–ª–æ —Å–ª–∏—à–∫–æ–º —Ç–∏—Ö–æ! –ü–æ–ø—Ä–æ–±—É–π –±–∏—Ç—å —Å–∏–ª—å–Ω–µ–µ.");
                return;
            }

            // –ù–∞—Ö–æ–¥–∏–º —Å—Ä–µ–¥–Ω–∏–π —É–¥–∞—Ä
            loudSamples.sort((a,b) => a-b);
            const p60 = loudSamples[Math.floor(loudSamples.length * 0.6)]; // –ë–µ—Ä–µ–º 60-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å (—á—É—Ç—å –≤—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ)
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á—É—Ç—å –Ω–∏–∂–µ —Å—Ä–µ–¥–Ω–∏—Ö —É–¥–∞—Ä–æ–≤
            let newSens = Math.floor(p60 * 0.8);
            if(newSens < 5) newSens = 5;
            
            updateSensUI(newSens);
            alert("–ì–æ—Ç–æ–≤–æ! –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –Ω–∞: " + newSens);
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        function updateSens(val) {
            sensitivity = parseInt(val);
            updateSensUI(sensitivity);
            localStorage.setItem('box_sens', sensitivity);
        }

        function updateSensUI(val) {
            document.getElementById('sensRange').value = val;
            document.getElementById('sensValDisplay').innerText = val;
            document.getElementById('debugSens').innerText = val;
            document.getElementById('gameMicThresh').style.left = Math.min(val*2, 100) + "%";
        }

        function switchScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            // –ú–µ–Ω—é –≤–∏–¥–Ω–æ –≤–µ–∑–¥–µ –∫—Ä–æ–º–µ –ª–æ–≥–∏–Ω–∞ –∏ –∏–≥—Ä—ã
            const menu = document.getElementById('bottomMenu');
            menu.style.display = (name === 'login' || name === 'game') ? 'none' : 'flex';
            
            // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
            const map = { 'game': 'navGame', 'skins': 'navSkins', 'leaders': 'navLeaders', 'settings': 'navSettings' };
            if(map[name]) document.getElementById(map[name]).classList.add('active-nav');

            document.getElementById('screen-' + name).classList.add('active');
            
            if(name === 'leaders') loadLeaders();
        }

        function checkCode() {
            const val = document.getElementById('passInput').value;
            if(VALID_CODES.includes(val)) {
                localStorage.setItem('box_auth', 'true');
                switchScreen('game');
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }
        
        function logout() { localStorage.removeItem('box_auth'); location.reload(); }
        function setMode(m) { gameMode = m; document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-mode')); event.target.classList.add('active-mode'); }
        
        // –õ–∏–¥–µ—Ä–±–æ—Ä–¥
        function saveScore() {
            const name = document.getElementById('nickInput').value || "–ê–Ω–æ–Ω–∏–º";
            fetch(GOOGLE_SCRIPT_URL, { 
                method: "POST", mode: "no-cors", 
                body: JSON.stringify({ name: name, score: score, mode: gameMode }) 
            }).then(() => switchScreen('leaders'));
        }
        
        function loadLeaders() {
            const list = document.getElementById('leaderList');
            list.innerHTML = "–ó–∞–≥—Ä—É–∑–∫–∞...";
            fetch(GOOGLE_SCRIPT_URL + "?mode=" + gameMode)
            .then(r => r.json())
            .then(data => {
                list.innerHTML = "";
                data.forEach((r, i) => {
                    list.innerHTML += `<div class="leader-row"><span>#${i+1} ${r.name}</span><b>${r.score}</b></div>`;
                });
            });
        }
        
        // –°—Ç–∞—Ä—Ç –ø–æ –∫–Ω–æ–ø–∫–µ
        document.getElementById('startBtn').addEventListener('click', startGame);
    </script>
</body>
</html>
