<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Pro</title>
    
    <script>
        const GOOGLE_SCRIPT_URL = ""; // –í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ Google Apps Script
        const POLICY_URL = "https://docs.google.com/document/d/YOUR_LINK";
        const WB_URL = "https://www.wildberries.ru/catalog/176733207/detail.aspx";
        const VALID_CODES = ["6433", "0309", "5528", "1111"]; // –ö–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞
        const TG_CHANNEL = "https://t.me/DUROV";
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #ff0055;
            --accent: #00ff88;
            --bg: #121212;
            --surface: #1e1e1e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: white;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –≠–ö–†–ê–ù–´ */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .screen.active { display: flex; opacity: 1; }

        /* –ì–õ–ê–í–ù–´–ô –ö–†–£–ì */
        .score-circle {
            width: 220px; height: 220px;
            border-radius: 50%;
            border: 6px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 100px; font-weight: 800;
            background: rgba(255,255,255,0.02);
            margin: 20px 0;
            position: relative;
            transition: transform 0.1s, border-color 0.1s, box-shadow 0.1s;
        }
        .score-circle.hit {
            transform: scale(1.05);
            border-color: var(--primary);
            box-shadow: 0 0 30px var(--primary);
            color: var(--primary);
        }

        /* –ö–ù–û–ü–ö–ò */
        .btn-main {
            background: var(--primary);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 50px;
            font-size: 20px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(255, 0, 85, 0.4);
            cursor: pointer;
            transition: transform 0.2s;
            width: 80%;
            max-width: 300px;
        }
        .btn-main:active { transform: scale(0.95); }
        .btn-main:disabled { background: #444; box-shadow: none; color: #888; }

        .btn-sec {
            background: transparent;
            color: #888;
            border: 1px solid #444;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            margin-top: 15px;
            cursor: pointer;
        }

        /* –¢–ê–ô–ú–ï–† –ò –ò–ù–§–û */
        .top-bar {
            position: absolute; top: 20px; width: 90%;
            display: flex; justify-content: space-between; align-items: center;
        }
        .timer-box {
            font-size: 42px; font-weight: 900; color: white;
            font-variant-numeric: tabular-nums;
        }
        .settings-btn {
            font-size: 24px; color: #666; cursor: pointer; padding: 10px;
        }

        /* COUNTDOWN OVERLAY */
        #countdown-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        .count-num { font-size: 120px; font-weight: 900; color: var(--accent); animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .count-hint { color: #aaa; margin-top: 20px; font-size: 14px; text-transform: uppercase; letter-spacing: 2px; }
        
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* –ù–ê–°–¢–†–û–ô–ö–ò (MODAL) */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; align-items: center; justify-content: center;
        }
        .modal-card {
            background: var(--surface); padding: 30px; border-radius: 20px;
            width: 85%; max-width: 320px; text-align: center;
            border: 1px solid #333;
        }
        
        /* SLIDER */
        .range-wrap { margin: 25px 0; }
        input[type=range] {
            width: 100%; height: 6px; background: #444;
            border-radius: 3px; outline: none; -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 24px; height: 24px;
            background: var(--primary); border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 10px var(--primary);
        }

        /* INPUT */
        .code-input {
            background: #222; border: 1px solid #444; color: white;
            padding: 15px; font-size: 20px; text-align: center;
            border-radius: 12px; width: 70%; margin-bottom: 20px; letter-spacing: 5px;
        }

        /* Debug info hidden by default */
        .debug-info {
            position: absolute; bottom: 10px; right: 10px;
            font-size: 10px; color: #444; font-family: monospace;
            display: none; /* –í–∫–ª—é—á–∏ display: block –¥–ª—è —Ç–µ—Å—Ç–æ–≤ */
        }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1 style="margin-bottom: 5px; letter-spacing: 3px;">BOXBALL</h1>
        <p style="color: #666; font-size: 12px; margin-bottom: 40px;">RUSSIA</p>
        
        <input type="tel" id="codeInput" class="code-input" placeholder="0000" maxlength="4">
        <button class="btn-main" onclick="tryLogin()">–í–û–ô–¢–ò</button>
        <div id="loginError" style="color:var(--primary); font-size:12px; margin-top:15px; display:none;">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥</div>
        
        <div style="margin-top: 50px; opacity: 0.5;">
            <p style="font-size: 10px; color: #666;">–ö–û–î–´: 6433, 0309, 5528</p>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="top-bar">
            <div class="timer-box" id="timerDisplay">60</div>
            <div class="settings-btn" onclick="openSettings()">‚öôÔ∏è</div>
        </div>

        <div class="score-circle" id="scoreCircle">0</div>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <span style="font-size: 12px; color: #666; letter-spacing: 1px;">–†–ï–ñ–ò–ú: –°–ü–†–ò–ù–¢</span>
        </div>

        <button class="btn-main" id="startBtn" onclick="startSequence()">–ù–ê–ß–ê–¢–¨</button>
        <button class="btn-sec" onclick="showLeaderboard()">üèÜ –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</button>

        <div class="debug-info">
            Noise: <span id="dbgNoise">0</span> | Thresh: <span id="dbgThresh">0</span> | Gain: <span id="dbgGain">1</span>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <div style="color: #888; font-size: 14px; margin-bottom: 10px;">–í–ê–® –†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h1 style="font-size: 90px; margin: 0; color: var(--primary);" id="finalScore">0</h1>
        <div id="rankBadge" style="background: #333; padding: 5px 15px; border-radius: 15px; font-size: 12px; margin-bottom: 30px; color: var(--accent);">–ù–û–í–ò–ß–û–ö</div>

        <input type="text" id="playerName" placeholder="–¢–≤–æ–µ –∏–º—è" style="background:none; border:none; border-bottom:1px solid #444; color:white; text-align:center; padding:10px; font-size:18px; width:60%; margin-bottom:20px;">

        <button class="btn-main" onclick="saveResult()" id="saveBtn">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button class="btn-sec" onclick="goHome()">–ó–ê–ù–û–í–û</button>
    </div>

    <div id="countdown-layer">
        <div class="count-num" id="countNum">3</div>
        <div class="count-hint">–ö–ê–õ–ò–ë–†–û–í–ö–ê –ú–ò–ö–†–û–§–û–ù–ê...</div>
        <div style="width: 200px; height: 4px; background: #333; margin-top: 20px; border-radius: 2px;">
            <div id="calibBar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.1s;"></div>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-card">
            <h3>–ù–ê–°–¢–†–û–ô–ö–ò</h3>
            
            <div class="range-wrap">
                <div style="display:flex; justify-content:space-between; font-size:12px; color:#aaa; margin-bottom:10px;">
                    <span>–ß–£–¢–ö–ò–ô (1)</span>
                    <span>–ñ–ï–°–¢–ö–ò–ô (10)</span>
                </div>
                <input type="range" id="sensSlider" min="1" max="10" value="5" step="1">
                <div style="font-size: 10px; color: #666; margin-top: 5px;">–†–µ–≥—É–ª–∏—Ä—É–µ—Ç —Å–∏–ª—É —É–¥–∞—Ä–∞</div>
            </div>

            <div style="margin-bottom: 20px; text-align: left; font-size: 14px;">
                <label style="display:flex; align-items:center; gap: 10px; cursor: pointer;">
                    <input type="checkbox" id="soundToggle" checked> üîä –ó–≤—É–∫–∏ —É–¥–∞—Ä–æ–≤
                </label>
            </div>

            <button class="btn-main" onclick="closeSettings()" style="font-size: 16px; padding: 12px;">–ì–û–¢–û–í–û</button>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        let audioCtx, analyser, microphone, gainNode, scriptNode;
        let isListening = false;
        let score = 0;
        let gameTimer = null;
        let lastHitTime = 0;
        
        // Settings
        let sensitivity = 5; // 1 to 10
        let threshold = 20;  // Auto-calculated
        let noiseFloor = 0;
        const MIN_DELAY_MS = 200; // Anti-debounce (ms)

        // Init
        window.onload = () => {
            if (window.Telegram?.WebApp) window.Telegram.WebApp.expand();
            
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) document.getElementById('sensSlider').value = savedSens;
            
            if(localStorage.getItem('box_auth')) showScreen('screen-game');
        };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- AUTH ---
        function tryLogin() {
            const code = document.getElementById('codeInput').value;
            if (VALID_CODES.includes(code)) {
                localStorage.setItem('box_auth', 'true');
                showScreen('screen-game');
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        // --- AUDIO ENGINE (THE CORE) ---
        async function initAudio() {
            if (audioCtx) return;
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: { echoCancellation: false, noiseSuppression: false, autoGainControl: false } });
                
                microphone = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.3;

                gainNode = audioCtx.createGain();
                gainNode.gain.value = 1.0; // Default gain

                // Chain: Mic -> Gain -> Analyser
                microphone.connect(gainNode);
                gainNode.connect(analyser);

                // Use ScriptProcessor for logic (Simpler for single-file than AudioWorklet)
                scriptNode = audioCtx.createScriptProcessor(2048, 1, 1);
                analyser.connect(scriptNode);
                scriptNode.connect(audioCtx.destination); // Mute output loop

                scriptNode.onaudioprocess = processAudio;
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É!");
            }
        }

        // --- PROCESS AUDIO LOOP ---
        let calibrationSamples = [];
        let isCalibrating = false;

        function processAudio() {
            if (!isListening && !isCalibrating) return;

            const array = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(array); // Get frequency data (better for impact)
            
            // Calculate Average Volume (Simple RMS-ish)
            let values = 0;
            const length = array.length;
            for (let i = 0; i < length; i++) values += array[i];
            const average = values / length;

            // --- 1. CALIBRATION LOGIC (INVISIBLE) ---
            if (isCalibrating) {
                calibrationSamples.push(average);
                // Visual feedback in debug/bar
                const percent = Math.min(average * 2, 100);
                document.getElementById('calibBar').style.width = percent + "%";
                return;
            }

            // --- 2. GAME LOGIC ---
            if (isListening) {
                // Check Auto-Gain display
                document.getElementById('dbgNoise').innerText = Math.floor(average);

                if (average > threshold) {
                    const now = Date.now();
                    if (now - lastHitTime > MIN_DELAY_MS) {
                        registerHit();
                        lastHitTime = now;
                    }
                }
            }
        }

        // --- GAME SEQUENCE ---
        async function startSequence() {
            await initAudio();
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            // Reset
            score = 0;
            document.getElementById('scoreCircle').innerText = "0";
            document.getElementById('countdown-layer').style.display = 'flex';
            
            // Start Calibration Countdown
            let count = 3;
            const countEl = document.getElementById('countNum');
            isCalibrating = true;
            calibrationSamples = [];
            gainNode.gain.value = 1.0; // Reset Gain

            const interval = setInterval(() => {
                count--;
                if (count > 0) {
                    countEl.innerText = count;
                    countEl.style.animation = 'none';
                    void countEl.offsetWidth; // trigger reflow
                    countEl.style.animation = 'popIn 0.5s';
                    
                    // AUTO-GAIN CHECK at T-2
                    if (count === 1) {
                        const currentMax = Math.max(...calibrationSamples);
                        if (currentMax < 5) {
                            gainNode.gain.value = 5.0; // Boost quiet mics
                            console.log("Auto-Gain Applied: 5x");
                            document.getElementById('dbgGain').innerText = "5.0";
                        }
                    }

                } else {
                    // GO!
                    clearInterval(interval);
                    finishCalibration();
                }
            }, 1000);
            
            // Initial render
            countEl.innerText = "3";
        }

        function finishCalibration() {
            isCalibrating = false;
            document.getElementById('countdown-layer').style.display = 'none';

            // Calculate Threshold
            // 1. Get average noise floor
            const sum = calibrationSamples.reduce((a, b) => a + b, 0);
            noiseFloor = sum / (calibrationSamples.length || 1);
            
            // 2. Get Sensitivity from Slider (1 = Sensitive, 10 = Hard)
            const sliderVal = parseInt(document.getElementById('sensSlider').value);
            
            // 3. Logic: Gap adds to noise. 
            // Slider 1 => Gap +5. Slider 10 => Gap +30.
            const gap = 3 + (sliderVal * 3); 
            
            threshold = noiseFloor + gap;
            
            // Safety clamp
            if (threshold < 8) threshold = 8; 

            // Debug
            document.getElementById('dbgThresh').innerText = Math.floor(threshold);
            console.log(`Noise: ${noiseFloor}, Slider: ${sliderVal}, Thresh: ${threshold}`);

            startGame();
        }

        function startGame() {
            isListening = true;
            let time = 60;
            document.getElementById('timerDisplay').innerText = time;
            document.getElementById('startBtn').style.display = 'none';

            gameTimer = setInterval(() => {
                time--;
                document.getElementById('timerDisplay').innerText = time;
                if (time <= 0) {
                    endGame();
                }
            }, 1000);
        }

        function endGame() {
            clearInterval(gameTimer);
            isListening = false;
            isCalibrating = false;
            
            document.getElementById('startBtn').style.display = 'block';
            document.getElementById('finalScore').innerText = score;
            
            // Rank
            let rank = "–ù–û–í–ò–ß–û–ö";
            if (score > 50) rank = "–õ–Æ–ë–ò–¢–ï–õ–¨";
            if (score > 100) rank = "–ü–†–û–§–ò";
            if (score > 150) rank = "–ú–ê–®–ò–ù–ê";
            document.getElementById('rankBadge').innerText = rank;

            showScreen('screen-result');
        }

        function registerHit() {
            score++;
            const el = document.getElementById('scoreCircle');
            el.innerText = score;
            el.classList.add('hit');
            setTimeout(() => el.classList.remove('hit'), 100);
            
            if (document.getElementById('soundToggle').checked) {
                playSound();
            }
            
            // Haptic
            if (window.navigator.vibrate) window.navigator.vibrate(10);
        }

        // --- UTILS ---
        function playSound() {
            // Short synth beep
            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g);
            g.connect(audioCtx.destination);
            
            osc.frequency.setValueAtTime(300, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.05);
            
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function goHome() {
            showScreen('screen-game');
        }

        function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
        function closeSettings() { 
            document.getElementById('settingsModal').style.display = 'none'; 
            localStorage.setItem('box_sens', document.getElementById('sensSlider').value);
        }

        function saveResult() {
            const name = document.getElementById('playerName').value;
            const btn = document.getElementById('saveBtn');
            if(!name) { alert("–í–≤–µ–¥–∏ –∏–º—è!"); return; }
            
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê...";
            
            // Fake send for demo (replace with fetch to GOOGLE_SCRIPT_URL)
            setTimeout(() => {
                alert(`–†–µ–∑—É–ª—å—Ç–∞—Ç ${score} —Å–æ—Ö—Ä–∞–Ω–µ–Ω –¥–ª—è ${name}!`);
                btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨";
                goHome();
            }, 1000);
        }
        
        function showLeaderboard() {
            alert("–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ç–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ (–ø–æ–¥–∫–ª—é—á–∏ Google Script)");
        }
    </script>
</body>
</html>
