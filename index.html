<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Pro</title>
    
    <script>
        const GOOGLE_SCRIPT_URL = "–í–°–¢–ê–í–¨–¢–ï_–°–Æ–î–ê_–í–ê–®–£_–°–°–´–õ–ö–£_–ò–ó_GOOGLE"; 
        const POLICY_URL = "https://docs.google.com/document/d/–í–ê–®–ê_–°–°–´–õ–ö–ê_–ù–ê_–ü–†–ê–í–ò–õ–ê";
        
        const WB_URL_SINGLE = "https://www.wildberries.ru/catalog/176733207/detail.aspx"; 
        const WB_URL_SET = "https://www.wildberries.ru/catalog/237586968/detail.aspx";     
        
        const VALID_CODES = ["6433", "0309", "5528"];
        const CHANNEL_URL = "https://t.me/DUROV";
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #ff0055;
            --accent: #ffcc00;
            --bg-grad-start: #1a0b0b;
            --bg-grad-end: #000000;
            --text-color: white;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: var(--text-color); display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
            transition: background 0.5s;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        /* –ò–ì–†–û–í–û–ô –ö–†–£–ì */
        .score-circle {
            width: 210px; height: 210px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 10px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: border-color 0.1s; position: relative; z-index: 2;
        }
        
        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä —ç–Ω–µ—Ä–≥–∏–∏ —É–¥–∞—Ä–∞ */
        .energy-bar-container {
            width: 200px; height: 6px; background: #333; border-radius: 3px; margin-top: 20px;
            position: relative; overflow: hidden;
        }
        .energy-bar-fill {
            height: 100%; width: 0%; background: #00ff88; transition: width 0.05s linear;
        }
        
        @keyframes shake-anim {
            0% { transform: translate(1px, 1px); } 25% { transform: translate(-2px, -2px); }
            50% { transform: translate(2px, 0px); } 75% { transform: translate(-1px, 2px); } 100% { transform: translate(0, 0); }
        }
        .shake { animation: shake-anim 0.1s; }

        .hit { border-color: var(--primary); box-shadow: 0 0 50px var(--primary); color: var(--primary); }

        button {
            padding: 16px 0; font-size: 17px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; z-index: 5;
            transition: background 0.3s;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #444; color: #888; box-shadow: none; cursor: not-allowed; }
        button.secondary-btn { background: transparent; border: 1px solid #444; color: #aaa; box-shadow: none; font-size: 14px; margin-top: 15px; padding: 12px; }

        /* –í–´–ë–û–† –†–ï–ñ–ò–ú–ê */
        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; width: 95%; max-width: 340px; }
        .mode-btn { flex: 1; padding: 10px 5px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #aaa; border-radius: 12px; font-size: 11px; font-weight: bold; margin: 0; box-shadow: none; }
        .mode-btn.active-mode { background: var(--primary); color: white; border-color: var(--primary); }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-panel { background: rgba(30,30,30,0.95); border: 1px solid #555; padding: 20px; border-radius: 15px; margin-bottom: 20px; width: 85%; max-width: 300px; display: none; z-index: 10; box-shadow: 0 10px 40px rgba(0,0,0,0.8); }
        input[type=range] { width: 100%; margin: 15px 0; accent-color: var(--primary); cursor: pointer; }
        
        .debug-info { font-size: 10px; color: #666; font-family: monospace; margin-top: 5px; }

        /* –ü–†–û–ß–ï–ï */
        .career-box { margin-bottom: 20px; padding: 10px; border-top: 1px solid #333; border-bottom: 1px solid #333; width: 100%; }
        .career-text { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .career-num { font-size: 24px; color: #fff; font-weight: 900; }
        
        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .player-profile { width: 80%; text-align: left; margin-bottom: 15px; border: 1px solid #444; border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.05); }
        .player-name-label { font-size: 10px; color: #888; }
        .player-name-val { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 5px; }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 12px; border: 1px solid #00ff88; z-index: 150; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="toast" class="toast">üì¢ –ì–æ—Ç–æ–≤–æ –∫ –±–æ—é!</div>

    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px; margin-bottom: 5px;">BOXBALL</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 20px;">SLOPE DETECTION SYSTEM</p>
        
        <div class="career-box">
            <div class="career-text">–í—Å–µ–≥–æ —É–¥–∞—Ä–æ–≤</div>
            <div class="career-num" id="totalHitsLogin">0</div>
        </div>

        <input type="text" id="passInput" placeholder="4 –¶–ò–§–†–´ –ü–û–î –®–¢–†–ò–•–ö–û–î–û–ú" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:16px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò –í –ò–ì–†–£</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px; font-size:12px;">–ö–æ–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç.</p>
    </div>

    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" id="btnSprint" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn" id="btnSurvival" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
        </div>

        <div style="display:flex; justify-content:space-between; width:90%; align-items: center; margin-bottom: 5px;">
            <div style="background:rgba(255,255,255,0.1); padding:8px 25px; border-radius:20px; font-weight:bold; color:#fff; font-size: 42px; min-width: 110px;" id="timer">60</div>
            <div style="font-size:12px; color:#aaa; cursor:pointer; border-bottom:1px dashed #555;" onclick="toggleSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        </div>
        
        <div class="settings-panel" id="settingsPanel">
            <h3 style="margin-top:0; font-size:14px; margin-bottom:15px;">–ù–ê–°–¢–†–û–ô–ö–ò –ú–ò–ö–†–û–§–û–ù–ê</h3>
            
            <label style="font-size:12px; color:#ccc;">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <span id="sensVal">5</span></label>
            <input type="range" id="sensRange" min="1" max="10" value="5" oninput="updateSens(this.value)">
            <p style="font-size:10px; color:#666; margin-top:-10px;">1 - –õ–æ–≤–∏—Ç –≤—Å—ë –ø–æ–¥—Ä—è–¥<br>10 - –¢–æ–ª—å–∫–æ —Å–∏–ª—å–Ω—ã–µ —É–¥–∞—Ä—ã</p>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px;">
                <span style="font-size:14px; color:#ccc;">üîä –ó–≤—É–∫ —É–¥–∞—Ä–∞</span>
                <input type="checkbox" id="soundCheck" checked style="width:20px; height:20px;">
            </div>

            <button onclick="toggleSettings()" style="margin-top:20px; padding:10px; font-size:12px; background:#222; border:1px solid #444;">–ó–ê–ö–†–´–¢–¨</button>
        </div>
        
        <div class="score-circle" id="scoreDisplay">0</div>
        
        <div class="energy-bar-container">
            <div class="energy-bar-fill" id="energyBar"></div>
        </div>
        <div class="debug-info" id="debugStr">–û–∂–∏–¥–∞–Ω–∏–µ —Å—Ç–∞—Ä—Ç–∞...</div>
        
        <div style="color:#666; font-size:12px; margin-top:15px; margin-bottom:10px;" id="modeHint">–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö</div>

        <button id="startBtn">–ù–ê–ß–ê–¢–¨</button>
        <button onclick="location.reload()" class="secondary-btn">üè† –í –ú–ï–ù–Æ</button>
    </div>

    <div id="screen-save" class="screen">
        <div style="font-size:14px; color:#aaa;">–í–ê–® –†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <h1 style="font-size:80px; margin:0; color:var(--primary);" id="finalScore">0</h1>

        <div id="nameInputArea">
            <input type="text" id="nicknameInput" placeholder="–í–∞—à–µ –ò–º—è" maxlength="15" style="padding:14px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; width:80%; margin-bottom: 10px;">
        </div>
        
        <button id="saveBtn" onclick="saveScore()">–°–û–•–†–ê–ù–ò–¢–¨</button>
        <button onclick="location.reload()" class="secondary-btn">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <script>
        // === –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ===
        let SENSITIVITY = 5; 
        // –ß–µ–º –Ω–∏–∂–µ –ø–æ—Ä–æ–≥ Slope, —Ç–µ–º –ª–µ–≥—á–µ –ø—Ä–æ–±–∏—Ç—å. 
        // 1 (–ú–∞–∫—Å —á—É–π–∫–∞) = 0.005. 10 (–ú–∏–Ω —á—É–π–∫–∞) = 0.05
        let SLOPE_THRESHOLD = 0.02; 
        
        const DEBOUNCE_TIME = 200; // 200–º—Å –ø–∞—É–∑–∞ –ø–æ—Å–ª–µ —É–¥–∞—Ä–∞ (–∑–∞—â–∏—Ç–∞ –æ—Ç —ç—Ö–∞)
        const SELF_MUTE_TIME = 150; // 150–º—Å –ø–∞—É–∑–∞ –ø–æ—Å–ª–µ –Ω–∞—à–µ–≥–æ –∑–≤—É–∫–∞ "–ø–∏—É"

        let score = 0, isRunning = false;
        let timeLeft = 60;
        let audioCtx, analyser, microphone, scriptProcessor;
        let lastEnergy = 0;
        let lastHitTime = 0;
        let isMutedByApp = false; // –§–ª–∞–≥ —Å–∞–º–æ-–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∑–≤—É–∫–æ–º
        let timerInterval;

        const startBtn = document.getElementById('startBtn');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const debugStr = document.getElementById('debugStr');
        const energyBar = document.getElementById('energyBar');

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) { window.Telegram.WebApp.expand(); }
            
            const savedSens = localStorage.getItem('box_sens_v3');
            if(savedSens) {
                document.getElementById('sensRange').value = savedSens;
                updateSens(savedSens);
            } else {
                updateSens(5);
            }

            const total = localStorage.getItem('box_total_hits') || 0;
            document.getElementById('totalHitsLogin').innerText = total;

            if (localStorage.getItem('box_auth') === 'true') {
                showScreen('screen-game');
            }
        };

        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
            document.getElementById(id).classList.add('active'); 
        }

        function checkCode() {
            const val = document.getElementById('passInput').value.trim();
            if(VALID_CODES.includes(val)) {
                localStorage.setItem('box_auth', 'true');
                showScreen('screen-game');
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function updateSens(val) {
            SENSITIVITY = parseInt(val);
            document.getElementById('sensVal').innerText = SENSITIVITY;
            
            // –ú–∞–ø–ø–∏–Ω–≥ 1..10 –≤ –ø–æ—Ä–æ–≥ –Ω–∞–∫–ª–æ–Ω–∞ (Slope)
            // 1 -> 0.005 (–æ—á–µ–Ω—å –ª–µ–≥–∫–æ)
            // 5 -> 0.025 (—Å—Ä–µ–¥–Ω–µ)
            // 10 -> 0.08 (—Ç—è–∂–µ–ª–æ)
            SLOPE_THRESHOLD = 0.005 + ((SENSITIVITY - 1) * 0.008);
            
            localStorage.setItem('box_sens_v3', SENSITIVITY);
        }

        function toggleSettings() {
            const el = document.getElementById('settingsPanel');
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }

        // === –ê–£–î–ò–û –î–í–ò–ñ–û–ö ===
        startBtn.addEventListener('click', async () => {
            if(isRunning) return;

            // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioContext
            try {
                if (!audioCtx) {
                    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }

                // 2. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false, // iOS —á–∞—Å—Ç–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ, –Ω–æ –º—ã –ø—Ä–æ–±—É–µ–º
                        latency: 0
                    }
                });

                // 3. –¶–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
                microphone = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256; // –ú–∞–ª–µ–Ω—å–∫–∏–π –±—É—Ñ–µ—Ä –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏

                // –í–ê–ñ–ù–û: –§–∏–ª—å—Ç—Ä –≤—ã—Å–æ–∫–∏—Ö —á–∞—Å—Ç–æ—Ç (High Pass)
                // –°—Ä–µ–∑–∞–µ–º –≤—Å—ë –Ω–∏–∂–µ 700–ì—Ü. –£–±–∏—Ä–∞–µ–º –≥—É–ª, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —â–µ–ª—á–æ–∫.
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 700;

                // –£—Å–∏–ª–∏—Ç–µ–ª—å (–ø—Ä–æ–≥—Ä–∞–º–º–Ω—ã–π –±—É—Å—Ç, —Ç–∞–∫ –∫–∞–∫ iPhone —Ç–∏—Ö–∏–π)
                const gainNode = audioCtx.createGain();
                gainNode.gain.value = 5.0; // –£–º–Ω–æ–∂–∞–µ–º –≥—Ä–æ–º–∫–æ—Å—Ç—å –≤ 5 —Ä–∞–∑

                // –°–æ–±–∏—Ä–∞–µ–º: Mic -> Filter -> Gain -> Analyser
                microphone.connect(filter);
                filter.connect(gainNode);
                gainNode.connect(analyser);

                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å–∫—Ä–∏–ø—Ç–æ–≤ (deprecated, –Ω–æ –Ω–∞–¥–µ–∂–Ω–µ–µ AudioWorklet –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á)
                scriptProcessor = audioCtx.createScriptProcessor(2048, 1, 1);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioCtx.destination);

                scriptProcessor.onaudioprocess = processAudio;

                startGame();

            } catch (err) {
                alert("–û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: " + err);
            }
        });

        function processAudio(event) {
            if (!isRunning) return;

            // –ï—Å–ª–∏ –º—ã —Å–∞–º–∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫ - –Ω–µ —Å–ª—É—à–∞–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω
            if (isMutedByApp) return;

            const inputBuffer = event.inputBuffer.getChannelData(0);
            let sum = 0;

            // –°—á–∏—Ç–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é (RMS)
            for (let i = 0; i < inputBuffer.length; i++) {
                sum += inputBuffer[i] * inputBuffer[i];
            }
            const rms = Math.sqrt(sum / inputBuffer.length);

            // === –ê–õ–ì–û–†–ò–¢–ú SLOPE (–ü–†–û–ò–ó–í–û–î–ù–ê–Ø) ===
            // –ú—ã –∏—â–µ–º –Ω–µ "–≥—Ä–æ–º–∫–æ—Å—Ç—å", –∞ "—Ä–∞–∑–Ω–∏—Ü—É" —Å –ø—Ä–æ—à–ª—ã–º –∫–∞–¥—Ä–æ–º
            const slope = rms - lastEnergy;
            
            // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
            const visual = Math.min(slope * 500, 100); 
            energyBar.style.width = Math.max(visual, 0) + "%";
            debugStr.innerText = `Slope: ${slope.toFixed(4)} | Thr: ${SLOPE_THRESHOLD.toFixed(4)}`;

            const now = Date.now();

            // –ü–†–û–í–ï–†–ö–ê –£–î–ê–†–ê
            // 1. –°–∫–ª–æ–Ω (—Ä–µ–∑–∫–æ—Å—Ç—å) –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞
            // 2. –ü—Ä–æ—à–ª–æ –≤—Ä–µ–º—è Debounce (–∑–∞—â–∏—Ç–∞ –æ—Ç —ç—Ö–∞)
            if (slope > SLOPE_THRESHOLD && (now - lastHitTime > DEBOUNCE_TIME)) {
                registerHit();
                lastHitTime = now;
            }

            // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∫–∞–¥—Ä–∞
            // –î–µ–ª–∞–µ–º –ø–ª–∞–≤–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ "–ø–∞–º—è—Ç–∏", —á—Ç–æ–±—ã –Ω–µ –∑–∞—Å—Ç—Ä—è—Ç—å –Ω–∞ –ø–∏–∫–µ
            lastEnergy = rms;
        }

        function registerHit() {
            score++;
            scoreDisplay.innerText = score;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è
            scoreDisplay.classList.add('hit');
            scoreDisplay.classList.add('shake');
            setTimeout(() => {
                scoreDisplay.classList.remove('hit');
                scoreDisplay.classList.remove('shake');
            }, 100);

            // –ó–≤—É–∫
            if(document.getElementById('soundCheck').checked) {
                playBeep();
            }
        }

        function playBeep() {
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞ –º–≥–Ω–æ–≤–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ —É—Å–ª—ã—à–∞—Ç—å —Å–µ–±—è
            isMutedByApp = true;
            setTimeout(() => { isMutedByApp = false; }, SELF_MUTE_TIME);

            const osc = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            osc.connect(g);
            g.connect(audioCtx.destination);
            
            // –ö–æ—Ä–æ—Ç–∫–∏–π –≤—ã—Å–æ–∫–∏–π "–ü–ò–ü" (1200–ì—Ü), –∫–æ—Ç–æ—Ä—ã–π —Ö–æ—Ä–æ—à–æ —Å–ª—ã—à–Ω–æ, –Ω–æ –æ–Ω –∫–æ—Ä–æ—Ç–∫–∏–π
            osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
            
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        }

        function startGame() {
            score = 0;
            scoreDisplay.innerText = "0";
            timeLeft = 60;
            isRunning = true;
            
            startBtn.style.display = 'none';
            document.querySelector('.mode-selector').style.opacity = '0.5';

            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timer').innerText = timeLeft;
                if(timeLeft <= 0) endGame();
            }, 1000);
        }

        function endGame() {
            isRunning = false;
            clearInterval(timerInterval);
            
            // –û—á–∏—Å—Ç–∫–∞ –∞—É–¥–∏–æ
            if (scriptProcessor) scriptProcessor.disconnect();
            if (analyser) analyser.disconnect();
            if (microphone) microphone.disconnect();
            
            document.getElementById('finalScore').innerText = score;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
            let total = parseInt(localStorage.getItem('box_total_hits') || 0);
            total += score;
            localStorage.setItem('box_total_hits', total);

            showScreen('screen-save');
        }

        function saveScore() {
            const name = document.getElementById('nicknameInput').value;
            if(!name) { alert("–í–≤–µ–¥–∏ –∏–º—è!"); return; }
            
            const btn = document.getElementById('saveBtn');
            btn.innerText = "–û–¢–ü–†–ê–í–õ–ï–ù–û!";
            btn.disabled = true;

            // –ü—Ä–æ—Å—Ç–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –æ–∂–∏–¥–∞–Ω–∏—è (–¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏)
            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ name: name, score: score, date: new Date().toLocaleDateString() })
            });
        }
        
        function setMode(m) {
            // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –∫–Ω–æ–ø–æ–∫
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-mode'));
            if(m === 'sprint') document.getElementById('btnSprint').classList.add('active-mode');
            if(m === 'survival') document.getElementById('btnSurvival').classList.add('active-mode');
        }
    </script>
</body>
</html>
