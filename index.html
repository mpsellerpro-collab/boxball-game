<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Pro Elite</title>
    
    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const GOOGLE_SCRIPT_URL = "–í–°–¢–ê–í–¨_–°–Æ–î–ê_–°–°–´–õ–ö–£_–ù–ê_–°–ö–†–ò–ü–¢"; 
        const WB_URL_SINGLE = "https://www.wildberries.ru/catalog/176733207/detail.aspx"; 
        const VALID_CODES = ["6433", "0309", "5528"];
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <style>
        :root {
            --primary: #ff0055;
            --accent: #00ff88;
            --bg-grad-start: #1a0b0b;
            --bg-grad-end: #000000;
            --nav-height: 70px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: white; display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; padding-bottom: 90px; box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        /* –ò–ì–†–û–í–û–ô –ö–†–£–ì */
        .score-circle {
            width: 220px; height: 220px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 20px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: all 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative;
        }
        
        .hit { border-color: var(--primary) !important; box-shadow: 0 0 60px var(--primary); color: var(--primary); transform: scale(1.1); }

        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä */
        .volume-meter { width: 260px; height: 12px; background: #222; border-radius: 6px; margin-top: 10px; position: relative; overflow: hidden; border: 1px solid #333; }
        .volume-bar { height: 100%; background: linear-gradient(90deg, #00ff88, #bcff00); width: 0%; transition: width 0.05s; }
        .volume-threshold { position: absolute; top:0; bottom:0; width: 3px; background: var(--primary); z-index: 5; box-shadow: 0 0 10px var(--primary); }

        /* –ö–ù–û–ü–ö–ò */
        button {
            padding: 18px; font-size: 16px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 16px;
            width: 100%; max-width: 280px; margin-top: 12px; cursor: pointer; text-transform: uppercase;
            box-shadow: 0 6px 20px rgba(255, 0, 85, 0.3); transition: 0.2s;
        }
        button:active { transform: scale(0.95); box-shadow: none; }
        .secondary-btn { background: transparent; border: 1px solid #444; color: #aaa; margin-top: 15px; box-shadow: none; }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(15px);
            border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; padding-bottom: env(safe-area-inset-bottom); 
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: #555; font-size: 10px;
            background: none; border: none; box-shadow: none; padding: 5px; margin: 0; width: auto;
        }
        .nav-item.active-nav { color: var(--primary); }
        .nav-icon { font-size: 24px; margin-bottom: 2px; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 30px; border-radius: 24px; border: 1px solid #333; text-align: center; width: 85%; max-width: 320px; }
        
        .mode-selector { display: flex; gap: 8px; margin-bottom: 15px; width: 100%; max-width: 300px; }
        .mode-btn { flex: 1; padding: 12px; background: #222; border: 1px solid #444; color: #888; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .mode-btn.active-mode { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(255,0,85,0.4); }
        
        input[type=range] { width: 100%; margin: 20px 0; accent-color: var(--primary); }
    </style>
</head>
<body>

    <div id="bottomMenu" class="bottom-nav" style="display:none;">
        <button class="nav-item active-nav" id="navGame" onclick="switchScreen('game')"><span class="nav-icon">ü•ä</span>–ò–ì–†–ê</button>
        <button class="nav-item" id="navLeaders" onclick="switchScreen('leaders')"><span class="nav-icon">üèÜ</span>–¢–û–ü</button>
        <button class="nav-item" id="navSettings" onclick="switchScreen('settings')"><span class="nav-icon">‚öôÔ∏è</span>–û–ü–¶–ò–ò</button>
    </div>

    <div id="calibModal" class="modal-overlay">
        <div class="modal-content" style="border-color: var(--accent);">
            <h2 style="color:var(--accent); margin:0;">–ö–ê–õ–ò–ë–†–û–í–ö–ê</h2>
            <p style="color:#aaa; font-size:13px;">–°–¥–µ–ª–∞–π –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–µ–∑–∫–∏—Ö —É–¥–∞—Ä–æ–≤ –ø–æ –º—è—á—É. –ú—ã –Ω–∞—Å—Ç—Ä–æ–∏–º –¥–∞—Ç—á–∏–∫–∏ –ø–æ–¥ —Ç–µ–±—è.</p>
            <div style="font-size: 48px; color: var(--accent); margin: 20px 0;" id="calibTimer">15</div>
            <div class="volume-meter"><div class="volume-bar" id="calibBarVisual"></div></div>
        </div>
    </div>

    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 4px; margin-bottom: 5px;">BOXBALL PRO</h1>
        <div style="color:var(--primary); font-weight: bold; margin-bottom: 30px; font-size: 12px;">ADVANCED AUDIO ENGINE V3.1</div>
        <input type="tel" id="passInput" placeholder="–ö–û–î –ò–ó –ò–ù–°–¢–†–£–ö–¶–ò–ò" style="padding:18px; border-radius:15px; border:1px solid #444; background:#111; color:white; text-align:center; font-size:20px; width:85%; margin-bottom: 15px;">
        <button onclick="checkCode()">–ü–û–î–¢–í–ï–†–î–ò–¢–¨</button>
        <p id="errorMsg" style="color:var(--primary); display:none; font-size:12px; margin-top:15px;">–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞</p>
    </div>

    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" onclick="setMode('sprint', this)">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn" onclick="setMode('survival', this)">üíÄ –ñ–ò–í–£–ß–ò–ô</button>
        </div>

        <div style="font-size:70px; font-weight:900; margin:5px 0; font-variant-numeric: tabular-nums;" id="timer">60</div>
        <div class="score-circle" id="scoreDisplay">0</div>
        
        <div class="volume-meter">
            <div class="volume-bar" id="gameMicLevel"></div>
            <div class="volume-threshold" id="gameMicThresh"></div>
        </div>
        <div style="font-size:10px; color:#555; margin-top:8px; letter-spacing: 1px;">SENSITIVITY THRESHOLD</div>

        <button id="startBtn" style="margin-top: 30px;">–ù–ê–ß–ê–¢–¨ –¢–†–ï–ù–ò–†–û–í–ö–£</button>
    </div>

    <div id="screen-settings" class="screen">
        <h3>–ù–ê–°–¢–†–û–ô–ö–ò –î–ê–¢–ß–ò–ö–ê</h3>
        <button onclick="startCalibration()" style="background: linear-gradient(90deg, #00ff88, #008844); color:black; font-weight: 900;">ü™Ñ –ê–í–¢–û-–ö–ê–õ–ò–ë–†–û–í–ö–ê</button>
        
        <div style="width:100%; text-align:left; margin-top:40px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px;">
            <label style="font-size:12px; color:#aaa; display: block; margin-bottom: 10px;">–†–£–ß–ù–ê–Ø –ß–£–í–°–¢–í–ò–¢–ï–õ–¨–ù–û–°–¢–¨: <span id="sensValDisplay" style="color:white; font-weight: bold;">15</span></label>
            <input type="range" id="sensRange" min="3" max="80" value="15" oninput="updateSens(this.value)">
            <p style="font-size: 10px; color: #666;">–ú–µ–Ω—å—à–µ —á–∏—Å–ª–æ ‚Äî –≤—ã—à–µ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ª–æ–≤–∏—Ç –¥–∞–∂–µ —Ç–∏—Ö–∏–µ –∫–∞—Å–∞–Ω–∏—è).</p>
        </div>

        <button onclick="logout()" class="secondary-btn" style="color: #ff4444; border-color: #440000;">–í–´–ô–¢–ò –ò–ó –ê–ö–ö–ê–£–ù–¢–ê</button>
    </div>

    <div id="screen-save" class="screen">
        <h2 style="margin:0; color:#aaa;">–†–ï–ó–£–õ–¨–¢–ê–¢</h2>
        <h1 style="font-size:100px; margin:10px 0; color:var(--primary);" id="finalScore">0</h1>
        <div id="newRecordBadge" style="color:var(--accent); font-weight:bold; margin-bottom:20px; font-size: 20px;"></div>
        
        <input type="text" id="nickInput" placeholder="–¢–í–û–ï –ò–ú–Ø" style="padding:18px; background:#222; border:1px solid #444; color:white; border-radius:15px; text-align:center; width: 80%; font-size: 18px; margin-bottom: 15px;">
        <button onclick="saveScore()">–í –¢–ê–ë–õ–ò–¶–£ –õ–ò–î–ï–†–û–í</button>
        <button onclick="switchScreen('game')" class="secondary-btn">–ò–ì–†–ê–¢–¨ –°–ù–û–í–ê</button>
    </div>

    <script>
        // --- –î–í–ò–ñ–û–ö –ò –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let audioContext, mediaStream, analyser, scriptProcessor;
        let sensitivity = 15; 
        let lastRms = 0;
        let score = 0, isGameRunning = false, gameMode = 'sprint';
        let timeLeft = 60, timerInterval, lastHitTime = 0, personalBest = 0;
        let isCalibrating = false, calibrationData = [];

        window.onload = () => {
            if(window.Telegram?.WebApp) {
                window.Telegram.WebApp.expand();
                window.Telegram.WebApp.enableClosingConfirmation();
            }
            
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) sensitivity = parseInt(savedSens);
            updateSensUI(sensitivity);

            personalBest = parseInt(localStorage.getItem('box_pb')) || 0;
            if(localStorage.getItem('box_auth') === 'true') switchScreen('game');
        };

        // --- AUDIO ENGINE V3.1 (TRANSIENT DETECTION) ---
        async function initAudio() {
            try {
                if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
                if (audioContext.state === 'suspended') await audioContext.resume();

                const constraints = {
                    audio: {
                        echoCancellation: false, noiseSuppression: false, autoGainControl: false,
                        googEchoCancellation: false, googNoiseSuppression: false,
                    }
                };

                mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
                const source = audioContext.createMediaStreamSource(mediaStream);

                // –§–∏–ª—å—Ç—Ä –≤—ã—Å–æ–∫–∏—Ö —á–∞—Å—Ç–æ—Ç (—É–±–∏—Ä–∞–µ–º –≥—É–ª)
                const hp = audioContext.createBiquadFilter();
                hp.type = 'highpass'; hp.frequency.value = 150;

                // –£—Å–∏–ª–∏—Ç–µ–ª—å
                const gain = audioContext.createGain();
                gain.gain.value = 5.0;

                // –§–∏–ª—å—Ç—Ä –Ω–∏–∑–∫–∏—Ö —á–∞—Å—Ç–æ—Ç (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –¥–∏–∞–ø–∞–∑–æ–Ω —É–¥–∞—Ä–∞)
                const lp = audioContext.createBiquadFilter();
                lp.type = 'lowpass'; lp.frequency.value = 1200;

                analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;

                source.connect(hp); hp.connect(gain); gain.connect(lp); lp.connect(analyser);

                scriptProcessor = audioContext.createScriptProcessor(1024, 1, 1);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                scriptProcessor.onaudioprocess = () => {
                    if (!isGameRunning && !isCalibrating) return;

                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteTimeDomainData(array);

                    let sum = 0;
                    for (let i = 0; i < array.length; i++) {
                        let x = array[i] - 128;
                        sum += x * x;
                    }
                    let rms = Math.sqrt(sum / array.length);
                    
                    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                    const val = Math.floor(rms);
                    const meter = isCalibrating ? document.getElementById('calibBarVisual') : document.getElementById('gameMicLevel');
                    if(meter) meter.style.width = Math.min(val * 3, 100) + "%";

                    if(isCalibrating) {
                        calibrationData.push(val);
                        return;
                    }

                    // –î–ï–¢–ï–ö–¶–ò–Ø –ê–¢–ê–ö–ò (Transient Detection)
                    let now = Date.now();
                    let attack = val - lastRms; 

                    if (val > sensitivity && attack > (sensitivity * 0.4)) {
                        if (now - lastHitTime > 110) { 
                            registerHit();
                            lastHitTime = now;
                        }
                    }
                    lastRms = val;
                };
                return true;
            } catch (e) {
                alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.");
                return false;
            }
        }

        function registerHit() {
            score++;
            const el = document.getElementById('scoreDisplay');
            el.innerText = score;
            el.classList.add('hit');
            setTimeout(() => el.classList.remove('hit'), 100);

            if (gameMode === 'survival') {
                timeLeft = Math.min(timeLeft + 0.4, 10);
                document.getElementById('timer').innerText = timeLeft.toFixed(1);
            }
            if(window.Telegram?.WebApp) window.Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
        }

        // --- GAME LOGIC ---
        async function startGame() {
            const inited = await initAudio();
            if(!inited) return;

            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('bottomMenu').style.display = 'none';
            
            score = 0;
            document.getElementById('scoreDisplay').innerText = "0";
            timeLeft = (gameMode === 'survival') ? 10 : 60;
            isGameRunning = true;
            
            timerInterval = setInterval(() => {
                if (gameMode === 'sprint') timeLeft--;
                else timeLeft -= 0.1;
                
                document.getElementById('timer').innerText = (gameMode === 'sprint') ? timeLeft : timeLeft.toFixed(1);
                if (timeLeft <= 0) finishGame();
            }, (gameMode === 'sprint' ? 1000 : 100));
        }

        function finishGame() {
            isGameRunning = false;
            clearInterval(timerInterval);
            if(mediaStream) mediaStream.getTracks().forEach(t => t.stop());

            if (score > personalBest && score > 5) {
                localStorage.setItem('box_pb', score);
                personalBest = score;
                document.getElementById('newRecordBadge').innerText = "üî• –ù–û–í–´–ô –†–ï–ö–û–†–î!";
            } else {
                document.getElementById('newRecordBadge').innerText = "";
            }

            document.getElementById('finalScore').innerText = score;
            switchScreen('save');
            document.getElementById('startBtn').style.display = 'block';
        }

        // --- CALIBRATION ---
        async function startCalibration() {
            document.getElementById('calibModal').style.display = 'flex';
            calibrationData = [];
            const inited = await initAudio();
            if(!inited) return;

            isCalibrating = true;
            let calTime = 15;
            const calInt = setInterval(() => {
                calTime--;
                document.getElementById('calibTimer').innerText = calTime;
                if(calTime <= 0) {
                    clearInterval(calInt);
                    isCalibrating = false;
                    if(mediaStream) mediaStream.getTracks().forEach(t => t.stop());
                    
                    const loudSamples = calibrationData.filter(v => v > 3).sort((a,b) => a-b);
                    if(loudSamples.length < 5) {
                        alert("–°–ª–∏—à–∫–æ–º —Ç–∏—Ö–æ! –ë–µ–π –ø–æ –º—è—á—É –≤–æ –≤—Ä–µ–º—è –∫–∞–ª–∏–±—Ä–æ–≤–∫–∏.");
                    } else {
                        let p60 = loudSamples[Math.floor(loudSamples.length * 0.6)];
                        let newSens = Math.max(Math.floor(p60 * 0.7), 5);
                        updateSens(newSens);
                        alert("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: " + newSens);
                    }
                    document.getElementById('calibModal').style.display = 'none';
                }
            }, 1000);
        }

        // --- UI HELPERS ---
        function updateSens(val) {
            sensitivity = parseInt(val);
            updateSensUI(sensitivity);
            localStorage.setItem('box_sens', sensitivity);
        }

        function updateSensUI(val) {
            document.getElementById('sensRange').value = val;
            document.getElementById('sensValDisplay').innerText = val;
            document.getElementById('gameMicThresh').style.left = Math.min(val * 3, 100) + "%";
        }

        function switchScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('bottomMenu').style.display = (['login', 'game', 'save'].includes(name)) ? 'none' : 'flex';
            if(name === 'game') document.getElementById('bottomMenu').style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∏–≥—Ä–µ

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));
            const map = { 'game': 'navGame', 'leaders': 'navLeaders', 'settings': 'navSettings' };
            if(map[name]) document.getElementById(map[name]).classList.add('active-nav');
            document.getElementById('screen-' + name).classList.add('active');
        }

        function checkCode() {
            if(VALID_CODES.includes(document.getElementById('passInput').value)) {
                localStorage.setItem('box_auth', 'true');
                switchScreen('game');
            } else {
                document.getElementById('errorMsg').style.display = 'block';
            }
        }

        function setMode(m, btn) {
            gameMode = m;
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active-mode'));
            btn.classList.add('active-mode');
        }

        function logout() { localStorage.clear(); location.reload(); }
        
        document.getElementById('startBtn').addEventListener('click', startGame);
    </script>
</body>
</html>
