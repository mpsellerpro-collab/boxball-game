<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxBall Pro</title>
    
    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const GOOGLE_SCRIPT_URL = "–í–°–¢–ê–í–¨–¢–ï_–°–Æ–î–ê_–í–ê–®–£_–°–°–´–õ–ö–£_–ò–ó_GOOGLE"; 
        const POLICY_URL = "https://docs.google.com/document/d/–í–ê–®–ê_–°–°–´–õ–ö–ê_–ù–ê_–ü–†–ê–í–ò–õ–ê";
        
        const WB_URL_SINGLE = "https://www.wildberries.ru/catalog/176733207/detail.aspx"; 
        const WB_URL_SET = "https://www.wildberries.ru/catalog/237586968/detail.aspx";     
        
        const VALID_CODES = ["6433", "0309", "5528", "1111"]; // –î–æ–±–∞–≤–∏–ª —Ç–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥
        const CHANNEL_URL = "https://t.me/DUROV";
    </script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --primary: #ff0055;
            --accent: #ffcc00;
            --bg-grad-start: #1a0b0b;
            --bg-grad-end: #000000;
            --text-color: white;
            --nav-height: 70px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at center, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            color: var(--text-color); display: flex; flex-direction: column; align-items: center;
            height: 100vh; margin: 0; overflow: hidden; text-align: center;
            user-select: none; -webkit-tap-highlight-color: transparent;
            transition: background 0.5s;
        }

        .screen { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; top: 0; left: 0; padding: 20px; padding-bottom: calc(var(--nav-height) + 20px); box-sizing: border-box; opacity: 0; transition: opacity 0.3s; }
        .active { display: flex; opacity: 1; }

        /* –ò–ì–†–û–í–û–ô –ö–†–£–ì */
        .score-circle {
            width: 210px; height: 210px; border-radius: 50%; border: 8px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 90px; font-weight: 900; margin: 10px 0;
            background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, rgba(0,0,0,0) 70%);
            transition: border-color 0.1s; position: relative; z-index: 2;
        }
        
        /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ç–æ—Ä –≥—Ä–æ–º–∫–æ—Å—Ç–∏ */
        .volume-meter {
            width: 240px; height: 16px; background: #222; border-radius: 8px; margin-top: 15px;
            position: relative; overflow: hidden; border: 1px solid #444;
        }
        .volume-bar {
            height: 100%; background: #00ff88; width: 0%; transition: width 0.05s;
        }
        
        .volume-threshold {
            position: absolute; top: 0; bottom: 0; width: 4px; background: #ff0055; z-index: 5;
            left: 20%; box-shadow: 0 0 8px #ff0055; transition: left 0.2s; opacity: 0.8;
        }
        
        .last-hit-info {
            font-size: 12px; color: #aaa; margin-top: 8px; font-family: monospace; font-weight: bold;
        }
        
        @keyframes shake-anim {
            0% { transform: translate(1px, 1px); } 25% { transform: translate(-2px, -2px); }
            50% { transform: translate(2px, 0px); } 75% { transform: translate(-1px, 2px); } 100% { transform: translate(0, 0); }
        }
        .shake { animation: shake-anim 0.1s; }

        /* –ü–£–õ–¨–°–ê–¶–ò–Ø */
        @keyframes pulse-anim {
            0% { transform: scale(1); border-color: #333; }
            50% { transform: scale(1.02); border-color: #444; }
            100% { transform: scale(1); border-color: #333; }
        }
        .pulse { animation: pulse-anim 2s infinite ease-in-out; }

        .hit { border-color: var(--primary) !important; box-shadow: 0 0 50px var(--primary); color: var(--primary); animation: none; }
        .hit-survival { border-color: #ffcc00 !important; box-shadow: 0 0 50px #ffcc00; color: #ffcc00; animation: none; }

        button {
            padding: 16px 0; font-size: 17px; font-weight: 800; background: var(--primary); color: white; border: none; border-radius: 14px;
            width: 100%; max-width: 280px; margin-top: 10px; cursor: pointer; text-transform: uppercase; box-shadow: 0 4px 15px rgba(0,0,0,0.3); position: relative; z-index: 5;
            transition: background 0.3s;
        }
        button:active { transform: scale(0.96); }
        button:disabled { background: #444; color: #888; box-shadow: none; cursor: not-allowed; }
        button.secondary-btn { background: transparent; border: 1px solid #444; color: #aaa; box-shadow: none; font-size: 14px; margin-top: 15px; padding: 12px; }

        /* –í–´–ë–û–† –†–ï–ñ–ò–ú–ê */
        .mode-selector { display: flex; gap: 5px; margin-bottom: 10px; width: 95%; max-width: 340px; }
        .mode-btn { flex: 1; padding: 10px 5px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #aaa; border-radius: 12px; font-size: 11px; font-weight: bold; margin: 0; box-shadow: none; }
        .mode-btn.active-mode { background: var(--primary); color: white; border-color: var(--primary); }

        /* –ù–ê–°–¢–†–û–ô–ö–ò */
        .settings-panel { display: none; width: 100%; flex-direction: column; align-items: center; } 
        input[type=range] { width: 100%; margin: 15px 0; accent-color: var(--primary); cursor: pointer; }
        
        .toggle-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 14px; color: #ccc; width: 100%; max-width: 280px;}
        .toggle-switch { width: 40px; height: 20px; background: #555; border-radius: 10px; position: relative; cursor: pointer; }
        .toggle-switch.on { background: var(--primary); }
        .toggle-knob { width: 16px; height: 16px; background: white; border-radius: 50%; position: absolute; top: 2px; left: 2px; transition: 0.2s; }
        .toggle-switch.on .toggle-knob { left: 22px; }

        /* –õ–ò–î–ï–†–ë–û–†–î */
        .leaderboard-box { background: rgba(0,0,0,0.3); width: 100%; max-height: 50vh; overflow-y: auto; border-radius: 16px; margin: 15px 0; }
        .leader-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .leader-name { font-size: 14px; font-weight: bold; display: block; color: #eee; text-align: left; }
        .leader-date { font-size: 10px; color: #888; display: block; margin-top: 3px; text-align: left; }
        .leader-score { font-size: 18px; font-weight: bold; color: #fff; }
        .leader-row:nth-child(1) .leader-name, .leader-row:nth-child(1) .leader-score { color: var(--accent); }

        .shield-icon { font-size: 10px; color: #00ff88; margin-bottom: 10px; border: 1px solid #00ff88; padding: 4px 8px; border-radius: 20px; align-self: center; margin-top: 10px; }
        .legal-checkbox-area { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px; width: 90%; max-width: 300px; text-align: left; font-size: 11px; color: #aaa; }
        .legal-link { color: var(--primary); text-decoration: underline; cursor: pointer; }

        /* –ú–ê–ì–ê–ó–ò–ù –°–ö–ò–ù–û–í */
        .skins-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; margin-top: 10px; max-width: 320px;}
        .skin-card { background: rgba(255,255,255,0.05); border: 1px solid #444; border-radius: 10px; padding: 10px; cursor: pointer; position: relative; opacity: 0.5; }
        .skin-card.unlocked { opacity: 1; border-color: #666; }
        .skin-card.active-skin { border-color: var(--primary); box-shadow: 0 0 10px var(--primary); }
        .skin-color { width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 5px; }
        .skin-name { font-size: 12px; font-weight: bold; }
        .lock-icon { font-size: 20px; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; }

        /* –û–ö–ù–ê */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center; }
        .modal-content { background: #1a1a1a; padding: 25px; border-radius: 20px; border: 2px solid var(--primary); text-align: center; width: 85%; max-width: 320px; max-height: 80vh; overflow-y: auto; }

        /* –ö–ê–õ–ò–ë–†–û–í–ö–ê */
        .calibration-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 300; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .calib-circle { width: 180px; height: 180px; border: 5px solid #00ff88; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 60px; color: #00ff88; margin-bottom: 20px; background: rgba(0,255,136,0.1); }
        .calib-progress { width: 80%; height: 4px; background: #333; margin-top: 20px; border-radius: 2px; }
        .calib-bar { height: 100%; width: 0%; background: #00ff88; transition: width 1s linear; }
        
        /* –£–í–ï–î–û–ú–õ–ï–ù–ò–ï (–¢–û–°–¢) */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 10px 20px; border-radius: 20px; font-size: 12px; border: 1px solid #00ff88; z-index: 150; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .toast.show { opacity: 1; }

        .career-box { margin-bottom: 20px; padding: 10px; border-top: 1px solid #333; border-bottom: 1px solid #333; width: 100%; }
        .career-text { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        .career-num { font-size: 24px; color: #fff; font-weight: 900; }
        .rank-badge { font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 5px; text-transform: uppercase; }
        
        .confetti { position: absolute; width: 10px; height: 10px; animation: fall linear forwards; z-index: 100; }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        
        /* –í–∫–ª–∞–¥–∫–∏ –ª–∏–¥–µ—Ä–±–æ—Ä–¥–∞ */
        .leader-tabs { display: flex; width: 100%; margin-bottom: 10px; border-bottom: 1px solid #444; }
        .leader-tab { flex: 1; padding: 10px; font-size: 10px; font-weight: bold; color: #666; cursor: pointer; }
        .leader-tab.active-tab { color: #ff0055; border-bottom: 2px solid #ff0055; }
        .leader-tab.survival-tab.active-tab { color: #ffcc00; border-bottom: 2px solid #ffcc00; }
        .leader-tab.rhythm-tab.active-tab { color: #00ff88; border-bottom: 2px solid #00ff88; }
        
        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .player-profile { width: 80%; text-align: left; margin-bottom: 15px; border: 1px solid #444; border-radius: 12px; padding: 12px; background: rgba(255,255,255,0.05); }
        .player-name-label { font-size: 10px; color: #888; }
        .player-name-val { font-size: 18px; font-weight: bold; color: #fff; margin-bottom: 5px; }
        .edit-link { font-size: 11px; color: var(--accent); text-decoration: underline; cursor: pointer; float: right; }

        /* –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(20, 20, 20, 0.98); backdrop-filter: blur(10px);
            border-top: 1px solid #333; display: flex; justify-content: space-around; align-items: center;
            z-index: 1000; padding-bottom: 10px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: #666; font-size: 9px; font-weight: bold;
            background: none; border: none; box-shadow: none; padding: 5px; margin: 0; width: auto; max-width: none;
            cursor: pointer;
        }
        .nav-item.active-nav { color: var(--primary); }
        .nav-icon { font-size: 22px; margin-bottom: 3px; transition: transform 0.2s; }
        .nav-item:active .nav-icon { transform: scale(0.8); }
    </style>
</head>
<body>

    <div id="bottomMenu" class="bottom-nav" style="display:none;">
        <button class="nav-item active-nav" id="navGame" onclick="switchScreen('game')">
            <span class="nav-icon">ü•ä</span>–ò–ì–†–ê
        </button>
        <button class="nav-item" id="navSkins" onclick="switchScreen('skins')">
            <span class="nav-icon">üéí</span>–°–ö–ò–ù–´
        </button>
        <button class="nav-item" id="navLeaders" onclick="switchScreen('leaders')">
            <span class="nav-icon">üèÜ</span>–¢–û–ü
        </button>
        <button class="nav-item" id="navSettings" onclick="switchScreen('settings')">
            <span class="nav-icon">‚öôÔ∏è</span>–û–ü–¶–ò–ò
        </button>
    </div>

    <div id="calibModal" class="calibration-overlay">
        <h2 style="color:white; margin-bottom:5px;">ü•ä –ë–ï–ô –ü–û –ú–Ø–ß–£!</h2>
        <p style="color:#aaa; max-width:80%; font-size:14px; margin-bottom:20px;">–ù–∞–±–∏–≤–∞–π –≤ –æ–±—ã—á–Ω–æ–º —Ä–∏—Ç–º–µ 15 —Å–µ–∫—É–Ω–¥.<br>–ú—ã –Ω–∞—Å—Ç—Ä–æ–∏–º –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–¥ —Ç–≤–æ–π —É–¥–∞—Ä.</p>
        <div class="calib-circle" id="calibTimer">15</div>
        <div class="calib-progress"><div class="calib-bar" id="calibBar"></div></div>
        <p style="color:#666; font-size:12px; margin-top:15px;">–ê–Ω–∞–ª–∏–∑ —Ä–µ–∑–∫–æ—Å—Ç–∏ —É–¥–∞—Ä–∞...</p>
    </div>
    
    <div id="toast" class="toast">üì¢ –ù–æ–≤–æ–µ –º–µ—Å—Ç–æ? –°–¥–µ–ª–∞–π –∫–∞–ª–∏–±—Ä–æ–≤–∫—É –≤ –æ–ø—Ü–∏—è—Ö!</div>

    <div id="reviewModal" class="modal-overlay">
        <div class="modal-content">
            <div style="font-size: 24px; margin-bottom: 10px;">üéâ –ù–û–í–´–ô –†–ï–ö–û–†–î!</div>
            <div style="color: #ccc; font-size: 14px; margin-bottom: 20px;">
                –¢—ã –º–∞—à–∏–Ω–∞! ü§ñ<br>–ü–æ–º–æ–≥–∏ –Ω–∞–º —Å—Ç–∞—Ç—å –ª—É—á—à–µ ‚Äî –æ—Å—Ç–∞–≤—å –æ—Ç–∑—ã–≤.
            </div>
            <p style="font-size:12px; color:#888; margin-bottom:5px;">–í–´–ë–ï–†–ò –°–í–û–ô –ù–ê–ë–û–†:</p>
            <button onclick="openReviewLink(WB_URL_SINGLE)" style="background: var(--accent); color: #000; margin-bottom: 10px;">‚≠êÔ∏è –ú–Ø–ß 60–≥—Ä (1—à—Ç)</button>
            <button onclick="openReviewLink(WB_URL_SET)" style="background: var(--accent); color: #000; margin-bottom: 10px;">‚≠êÔ∏è –ù–ê–ë–û–† (3—à—Ç)</button>
            <button onclick="document.getElementById('reviewModal').style.display='none'" style="background: transparent; border: 1px solid #555;">–ü–û–ó–ñ–ï</button>
        </div>
    </div>

    <div id="screen-login" class="screen active">
        <h1 style="letter-spacing: 2px; margin-bottom: 5px;">BOXBALL</h1>
        <p style="color:#666; font-size:12px; margin-bottom: 20px;">AI SOUND TRACKING</p>
        
        <div class="career-box">
            <div class="career-text">–í—Å–µ–≥–æ —É–¥–∞—Ä–æ–≤</div>
            <div class="career-num" id="totalHitsLogin">0</div>
        </div>

        <input type="text" id="passInput" placeholder="4 –¶–ò–§–†–´ –ü–û–î –®–¢–†–ò–•–ö–û–î–û–ú" style="padding:15px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; font-size:16px; margin-bottom:15px; width:80%;">
        <button onclick="checkCode()">–í–û–ô–¢–ò –í –ò–ì–†–£</button>
        <p id="errorMsg" style="color:#ff4d4d; display:none; margin-top:10px; font-size:12px;">–ö–æ–¥ –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç. –ü–æ–ø—Ä–æ–±—É–π 6433, 0309 –∏–ª–∏ 5528</p>
        
        <div style="position: absolute; bottom: 10px; font-size: 9px; color: #444; width: 100%; text-align: center;">
            ¬© 2026 BOXBALL RUSSIA. v2.1 PRO
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="mode-selector">
            <button class="mode-btn active-mode" id="btnSprint" onclick="setMode('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</button>
            <button class="mode-btn" id="btnSurvival" onclick="setMode('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</button>
            <button class="mode-btn" id="btnRhythm" onclick="setMode('rhythm')">üéµ –†–ò–¢–ú</button>
        </div>

        <div style="display:flex; justify-content:center; width:100%; align-items: center; margin-bottom: 5px;">
            <div style="background:rgba(255,255,255,0.1); padding:8px 25px; border-radius:20px; font-weight:bold; color:#fff; font-size: 42px; min-width: 110px;" id="timer">60</div>
        </div>
        
        <div class="shield-icon">üõ°Ô∏è SMART FILTER ACTIVE</div>
        
        <div class="score-circle pulse" id="scoreDisplay">0</div>
        
        <div class="volume-meter">
            <div class="volume-bar" id="micLevel"></div>
            <div class="volume-threshold" id="micThresh"></div>
        </div>
        <div class="last-hit-info">
            –£–†–û–í–ï–ù–¨: <span id="lastHitVal" style="color:#00ff88; font-weight:bold;">0</span> / <span id="debugDelta" style="color:#aaa;">0</span>
        </div>
        
        <div style="color:#666; font-size:12px; margin-top:5px; margin-bottom:10px;" id="modeHint">–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö</div>

        <button id="startBtn">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
    </div>

    <div id="screen-skins" class="screen">
        <h3>üéí –†–ê–ó–î–ï–í–ê–õ–ö–ê</h3>
        <p style="font-size:12px; color:#888;">–ù–∞–±–∏–≤–∞–π —É–¥–∞—Ä—ã, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç–∏–ª–∏</p>
        <div class="skins-grid" id="skinsGrid"></div>
    </div>

    <div id="screen-settings" class="screen">
        <h3>‚öôÔ∏è –û–ü–¶–ò–ò</h3>
        
        <div class="settings-panel" style="display:flex;">
            <div class="toggle-row">
                <span>üîä –ó–≤—É–∫ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤</span>
                <div class="toggle-switch on" id="togSound" onclick="toggleOption('sound')"><div class="toggle-knob"></div></div>
            </div>

            <hr style="border:0; border-top:1px solid #444; margin: 15px 0; width:100%;">

            <button onclick="startAutoCalibration()" style="background: linear-gradient(90deg, #00ff88, #00cc6a); color: #004422; margin-bottom: 15px; font-weight:bold;">ü™Ñ –ö–ê–õ–ò–ë–†–û–í–ö–ê (15 —Å–µ–∫)</button>
            
            <label style="font-size:12px; color:#ccc;">–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: <span id="sensVal">15</span></label>
            <input type="range" id="sensRange" min="5" max="80" value="15" oninput="updateSens(this.value)">
            
            <button onclick="setRecommended()" style="background: #333; border: 1px solid #666; color: #ccc; padding: 10px; font-size: 12px; width: 100%; margin-bottom: 15px;">–°–±—Ä–æ—Å (–ê–≤—Ç–æ)</button>
            
            <button onclick="logout()" style="background: #220000; border: 1px solid #ff4d4d; color: #ff4d4d; padding: 10px; font-size: 12px; margin-bottom: 5px;">üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
    </div>

    <div id="screen-save" class="screen">
        <div style="font-size:14px; color:#aaa;">–í–ê–® –†–ï–ó–£–õ–¨–¢–ê–¢</div>
        <div class="rank-badge" id="rankDisplay">–ù–û–í–ò–ß–û–ö</div>
        <h1 style="font-size:80px; margin:0; color:var(--primary);" id="finalScore">0</h1>
        <div style="font-size:12px; color:var(--accent); font-weight:bold; margin-bottom:10px;" id="recordMsg"></div>

        <div style="display:flex; gap:15px; justify-content:center; margin-bottom:15px;">
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:5px;">üî• <span id="resCalories">0</span> –ö–ö–ê–õ</div>
            <div style="background:rgba(255,255,255,0.1); padding:5px 10px; border-radius:5px;">üéÆ <span id="resMode">–°–ü–†–ò–ù–¢</span></div>
        </div>
        
        <div id="nameInputArea">
            <input type="text" id="nicknameInput" placeholder="–í–∞—à–µ –ò–º—è" maxlength="15" style="padding:14px; border-radius:12px; border:1px solid #444; background:#222; color:white; text-align:center; width:80%; margin-bottom: 10px;">
        </div>
        
        <div id="nameDisplayArea" style="display:none;" class="player-profile">
            <div class="player-name-label">–ò–≥—Ä–æ–∫: <span class="edit-link" onclick="editName()">(–∏–∑–º.)</span></div>
            <div class="player-name-val" id="displayName">–ê–Ω–æ–Ω–∏–º</div>
        </div>
        
        <div class="legal-checkbox-area">
            <input type="checkbox" id="legalCheck" onchange="toggleSaveBtn()">
            <label for="legalCheck">–Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ <span class="legal-link" onclick="openPolicy()">–æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö</span></label>
        </div>

        <button id="saveBtn" onclick="saveScore()" disabled>–°–û–•–†–ê–ù–ò–¢–¨ –í –¢–û–ü</button>
        <button onclick="switchScreen('game')" class="secondary-btn">–ù–ï –°–û–•–†–ê–ù–Ø–¢–¨</button>
    </div>

    <div id="screen-leaders" class="screen">
        <h3>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h3>
        <div class="leader-tabs">
            <div class="leader-tab active-tab" id="tabSprint" onclick="switchLeaderTab('sprint')">‚ö°Ô∏è –°–ü–†–ò–ù–¢</div>
            <div class="leader-tab" id="tabSurvival" onclick="switchLeaderTab('survival')">üíÄ –í–´–ñ–ò–í–ê–ù–ò–ï</div>
            <div class="leader-tab" id="tabRhythm" onclick="switchLeaderTab('rhythm')">üéµ –†–ò–¢–ú</div>
        </div>
        <div class="leaderboard-box" id="leaderList"><div style="padding:20px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </div>

    <script>
        // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ---
        let MIN_HIT_DELAY = 120; // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
        let SENSITIVITY = 15;     // –ü–æ—Ä–æ–≥ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
        let SHARPNESS_THRESH = 4; // –ü–æ—Ä–æ–≥ "—Ä–µ–∑–∫–æ—Å—Ç–∏" (Delta)
        
        let score = 0, isRunning = false, lastHitTime = 0;
        let currentMode = 'sprint'; 
        let timeLeft = 60.0;
        let audioCtx;
        const synth = window.speechSynthesis;
        let timerInterval;
        let metronomeInterval;
        let totalHits = 0;
        let personalBest = 0;
        
        let isSoundOn = true;
        let currentTheme = 'default';

        // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∑–≤—É–∫–∞
        let previousRms = 0; 
        let noiseFloor = 5;

        const THEMES = {
            'default': { name: '–ù–µ–æ–Ω (–°—Ç–∞–Ω–¥–∞—Ä—Ç)', color: '#ff0055', bg1: '#1a0b0b', bg2: '#000000', cost: 0 },
            'cyber': { name: '–ö–∏–±–µ—Ä (500 —É–¥.)', color: '#00ccff', bg1: '#0b1a1a', bg2: '#000000', cost: 500 },
            'toxic': { name: '–¢–æ–∫—Å–∏–∫ (1–∫ —É–¥.)', color: '#00ff88', bg1: '#0b1a0b', bg2: '#000000', cost: 1000 },
            'gold': { name: '–≠–õ–ò–¢–ê (5–∫ —É–¥.)', color: '#FFD700', bg1: '#1a1500', bg2: '#000000', cost: 5000 }
        };

        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) { window.Telegram.WebApp.expand(); }
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const savedSens = localStorage.getItem('box_sens');
            if(savedSens) updateSens(savedSens); else updateSens(15);

            totalHits = parseInt(localStorage.getItem('box_total_hits')) || 0;
            document.getElementById('totalHitsLogin').innerText = totalHits.toLocaleString();
            personalBest = parseInt(localStorage.getItem('box_pb_sprint')) || 0;
            
            if(localStorage.getItem('box_sound') === 'false') toggleOption('sound');
            
            const savedTheme = localStorage.getItem('box_theme');
            if(savedTheme && THEMES[savedTheme]) applyTheme(savedTheme);

            if (localStorage.getItem('box_auth') === 'true') {
                switchScreen('game');
                showToast(); 
            }
        };
        
        function showToast() {
            const t = document.getElementById('toast');
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê–ú–ò ---
        function switchScreen(screenName) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('bottomMenu').style.display = 'flex'; 

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active-nav'));

            if (screenName === 'game') {
                document.getElementById('screen-game').classList.add('active');
                document.getElementById('navGame').classList.add('active-nav');
            } 
            else if (screenName === 'skins') {
                openSkins(); 
                document.getElementById('screen-skins').classList.add('active');
                document.getElementById('navSkins').classList.add('active-nav');
            }
            else if (screenName === 'leaders') {
                showLeaderboard(false, currentMode);
                document.getElementById('screen-leaders').classList.add('active');
                document.getElementById('navLeaders').classList.add('active-nav');
            }
            else if (screenName === 'settings') {
                document.getElementById('screen-settings').classList.add('active');
                document.getElementById('navSettings').classList.add('active-nav');
            }
        }

        // --- –£–ú–ù–ê–Ø –ö–ê–õ–ò–ë–†–û–í–ö–ê (SMART CALIBRATION) ---
        async function startAutoCalibration() {
            document.getElementById('calibModal').style.display = 'flex';
            
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: false, noiseSuppression: false, autoGainControl: false,
                        googEchoCancellation: false, googAutoGainControl: false, googNoiseSuppression: false, googHighpassFilter: false,
                        latency: 0
                    }
                });
                
                const mic = audioCtx.createMediaStreamSource(stream); 
                const preGain = audioCtx.createGain(); preGain.gain.value = 3.0; 
                const analyser = audioCtx.createAnalyser(); 
                const script = audioCtx.createScriptProcessor(2048, 1, 1);
                
                // –§–∏–ª—å—Ç—Ä –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —É–¥–∞—Ä–æ–≤
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 600; 

                mic.connect(preGain);
                preGain.connect(filter);
                filter.connect(analyser);
                analyser.connect(script);
                
                const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0.0;
                script.connect(zeroGain); zeroGain.connect(audioCtx.destination);
                
                let peaks = [];
                let noiseSamples = [];
                let calibTime = 15;
                let lastCalibRms = 0;
                
                const countInt = setInterval(() => {
                    calibTime--;
                    document.getElementById('calibTimer').innerText = calibTime;
                    document.getElementById('calibBar').style.width = ((15 - calibTime) / 15 * 100) + "%";
                    if(calibTime <= 0) clearInterval(countInt);
                }, 1000);

                script.onaudioprocess = function() {
                    const buf = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteTimeDomainData(buf);
                    
                    let sum = 0;
                    for (let i = 0; i < buf.length; i++) { let x = buf[i] - 128; sum += x * x; }
                    let rms = Math.sqrt(sum / buf.length);
                    
                    // –°–æ–±–∏—Ä–∞–µ–º —à—É–º
                    noiseSamples.push(rms);
                    
                    // –ò—â–µ–º –ø–∏–∫–∏ (—É–¥–∞—Ä—ã) - –µ—Å–ª–∏ —Ä–µ–∑–∫–∏–π —Å–∫–∞—á–æ–∫
                    if(rms > lastCalibRms + 5 && rms > 10) {
                         peaks.push(rms);
                    }
                    lastCalibRms = rms;
                };

                setTimeout(() => {
                    script.disconnect(); mic.disconnect(); filter.disconnect(); analyser.disconnect(); zeroGain.disconnect();
                    
                    if (noiseSamples.length > 0) {
                        // 1. –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π —à—É–º
                        let sumNoise = noiseSamples.reduce((a, b) => a + b, 0);
                        let avgNoise = sumNoise / noiseSamples.length;
                        
                        // 2. –°—á–∏—Ç–∞–µ–º —Å—Ä–µ–¥–Ω–∏–π —É–¥–∞—Ä (–µ—Å–ª–∏ –±—ã–ª–∏)
                        let avgPeak = 40; // –î–µ—Ñ–æ–ª—Ç
                        if(peaks.length > 2) {
                            peaks.sort((a,b) => b-a); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é
                            let topPeaks = peaks.slice(0, Math.min(peaks.length, 5)); // –ë–µ—Ä–µ–º —Ç–æ–ø-5 —É–¥–∞—Ä–æ–≤
                            avgPeak = topPeaks.reduce((a,b)=>a+b,0) / topPeaks.length;
                        }
                        
                        // 3. –§–æ—Ä–º—É–ª–∞ –∏–¥–µ–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä–æ–≥–∞: –®—É–º + (–£–¥–∞—Ä - –®—É–º) * 0.5
                        // –ú—ã —Å—Ç–∞–≤–∏–º –ø–æ—Ä–æ–≥ –ø–æ—Å–µ—Ä–µ–¥–∏–Ω–µ –º–µ–∂–¥—É —à—É–º–æ–º –∏ —É–¥–∞—Ä–æ–º
                        let newSens = avgNoise + (avgPeak - avgNoise) * 0.45;
                        
                        // –ó–∞—â–∏—Ç–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã
                        if(newSens < 5) newSens = 5; 
                        if(newSens > 60) newSens = 60;
                        
                        let finalSens = Math.floor(newSens);
                        updateSens(finalSens);
                        
                        alert(`–ì–æ—Ç–æ–≤–æ!\n–ü–æ—Ä–æ–≥ —É–¥–∞—Ä–∞: ${finalSens}\n–®—É–º –∫–æ–º–Ω–∞—Ç—ã: ${Math.floor(avgNoise)}`);
                    }
                    document.getElementById('calibModal').style.display = 'none';
                    switchScreen('settings');
                }, 15000); 
            } catch (e) {
                alert("–û—à–∏–±–∫–∞: –†–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω!");
                document.getElementById('calibModal').style.display = 'none';
            }
        }

        // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ (–û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ) ---
        const startBtn = document.getElementById('startBtn');
        startBtn.addEventListener('click', async () => {
            if(isRunning) return;
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è WebView Android
                const constraints = {
                    audio: {
                        echoCancellation: false, noiseSuppression: false, autoGainControl: false,
                        googEchoCancellation: false, googAutoGainControl: false, googNoiseSuppression: false, googHighpassFilter: false,
                        latency: 0
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const mic = audioCtx.createMediaStreamSource(stream); 
                
                // Pre-Amp (—É—Å–∏–ª–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–∞)
                const preGain = audioCtx.createGain();
                preGain.gain.value = 3.5; 

                // LowPass –§–∏–ª—å—Ç—Ä (—É–±–∏—Ä–∞–µ—Ç —Å–≤–∏—Å—Ç –∏ –≤—ã—Å–æ–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã)
                const filter = audioCtx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 600; 
                
                const analyser = audioCtx.createAnalyser(); 
                analyser.fftSize = 512; 
                
                const script = audioCtx.createScriptProcessor(1024, 1, 1);
                const zeroGain = audioCtx.createGain(); zeroGain.gain.value = 0.0;
                
                mic.connect(preGain);
                preGain.connect(filter);
                filter.connect(analyser);
                analyser.connect(script);
                script.connect(zeroGain);
                zeroGain.connect(audioCtx.destination);
                
                // UI —Å—Ç–∞—Ä—Ç
                startBtn.style.display = 'none'; 
                document.querySelector('.mode-selector').style.opacity = '0.3';
                document.getElementById('bottomMenu').style.display = 'none';
                document.getElementById('scoreDisplay').classList.remove('pulse');

                isRunning = true; score = 0; document.getElementById('scoreDisplay').innerText = 0; 
                timeLeft = (currentMode === 'survival') ? 10 : 60;
                document.getElementById('timer').innerText = timeLeft;

                if (timerInterval) clearInterval(timerInterval);
                if (metronomeInterval) clearInterval(metronomeInterval);

                if(currentMode === 'rhythm') {
                    playSound('tick');
                    metronomeInterval = setInterval(() => { if(isRunning) playSound('tick'); }, 600);
                }

                timerInterval = setInterval(() => { 
                    timeLeft -= 1; document.getElementById('timer').innerText = Math.floor(timeLeft); 
                    if(timeLeft <= 0) { 
                        clearInterval(timerInterval); if(metronomeInterval) clearInterval(metronomeInterval);
                        isRunning = false; finishGame(); 
                    } 
                }, 1000);

                previousRms = 0; // –°–±—Ä–æ—Å –ø–∞–º—è—Ç–∏ —É—Ä–æ–≤–Ω—è

                // === –ì–õ–ê–í–ù–´–ô –ê–õ–ì–û–†–ò–¢–ú –û–ë–†–ê–ë–û–¢–ö–ò ===
                script.onaudioprocess = function() {
                    if(!isRunning) return;
                    
                    const buf = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteTimeDomainData(buf);
                    
                    let sum = 0;
                    for (let i = 0; i < buf.length; i++) { let x = buf[i] - 128; sum += x * x; }
                    let rms = Math.sqrt(sum / buf.length);
                    let val = Math.floor(rms); 

                    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
                    const visual = Math.min(val * 2, 100);
                    document.getElementById('micLevel').style.width = visual + "%";
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º "–†–µ–∑–∫–æ—Å—Ç—å" (Delta)
                    let delta = val - previousRms;
                    document.getElementById('lastHitVal').innerText = val;
                    document.getElementById('debugDelta').innerText = delta;

                    // –£–°–õ–û–í–ò–ï –£–î–ê–†–ê:
                    // 1. –ì—Ä–æ–º–∫–æ—Å—Ç—å –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞ (SENSITIVITY)
                    // 2. –†–µ–∑–∫–∏–π —Å–∫–∞—á–æ–∫ –≤–≤–µ—Ä—Ö (delta > 3-4) - —ç—Ç–æ –æ—Ç—Å–µ–∫–∞–µ—Ç –ø–ª–∞–≤–Ω—ã–µ –∫—Ä–∏–∫–∏
                    if (val > SENSITIVITY && delta >= SHARPNESS_THRESH) {
                        const now = Date.now();
                        
                        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: –µ—Å–ª–∏ —É–¥–∞—Ä—ã —á–∞—Å—Ç—ã–µ, —É–º–µ–Ω—å—à–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫—É
                        let currentDelay = MIN_HIT_DELAY;
                        if(score > 50) currentDelay = 90; // –ë—ã—Å—Ç—Ä–µ–µ –Ω–∞ –≤—ã—Å–æ–∫–∏—Ö —Å–∫–æ—Ä–æ—Å—Ç—è—Ö
                        
                        if(now - lastHitTime > currentDelay) {
                            score++; 
                            registerHitVisual();
                            lastHitTime = now;
                            
                            // –•–∞–∫: –í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–≤—ã—à–∞–µ–º "–ø—Ä–µ–¥—ã–¥—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ", 
                            // —á—Ç–æ–±—ã —ç—Ö–æ –æ—Ç —É–¥–∞—Ä–∞ –Ω–µ –∑–∞—Å—á–∏—Ç–∞–ª–æ—Å—å –∫–∞–∫ –≤—Ç–æ—Ä–æ–π —É–¥–∞—Ä
                            previousRms = val + 15; 
                            return; 
                        }
                    }
                    
                    // –ü–ª–∞–≤–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ "—Ñ–æ–Ω–∞" (–¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å–æ —Å–ª–µ–¥—É—é—â–∏–º –∫–∞–¥—Ä–æ–º)
                    previousRms = val;
                }
            } catch(e) { alert("–û—à–∏–±–∫–∞: –†–∞–∑—Ä–µ—à–∏—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω!"); }
        });

        // --- –û–°–¢–ê–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò (–í–ò–ó–£–ê–õ, –°–û–•–†–ê–ù–ï–ù–ò–ï) ---
        function registerHitVisual() {
            const el = document.getElementById('scoreDisplay'); el.innerText = score; 
            el.classList.add('shake'); setTimeout(()=>el.classList.remove('shake'), 300);

            if (currentMode === 'survival') {
                el.classList.add('hit-survival');
                let bonus = 1.0; if (score > 20) bonus = 0.5; if (score > 50) bonus = 0.25;
                timeLeft += bonus; if (timeLeft > 10) timeLeft = 10;
                document.getElementById('timer').innerText = Math.floor(timeLeft);
            } else { 
                el.classList.add('hit'); 
            }
            
            setTimeout(()=>el.className = 'score-circle', 100); 
            playSound('hit'); 
        }

        function finishGame() { 
            isRunning = false; playSound('end'); launchConfetti();
            document.getElementById('scoreDisplay').classList.add('pulse');
            
            const cals = Math.floor(score * 0.05); 
            let rank = "–ù–û–í–ò–ß–û–ö";
            if(score > 30) rank = "–õ–Æ–ë–ò–¢–ï–õ–¨";
            if(score > 60) rank = "–ë–û–ï–¶";
            if(score > 100) rank = "–ú–ê–®–ò–ù–ê";
            if(score > 150) rank = "–õ–ï–ì–ï–ù–î–ê";

            totalHits += score;
            localStorage.setItem('box_total_hits', totalHits);

            document.getElementById('finalScore').innerText = score; 
            document.getElementById('resCalories').innerText = cals;
            document.getElementById('resMode').innerText = currentMode.toUpperCase();
            document.getElementById('rankDisplay').innerText = rank;
            
            personalBest = parseInt(localStorage.getItem('box_pb_' + currentMode)) || 0;
            if (score > personalBest && score > 5) {
                localStorage.setItem('box_pb_' + currentMode, score);
                document.getElementById('recordMsg').innerText = "üèÜ –ù–û–í–´–ô –õ–ò–ß–ù–´–ô –†–ï–ö–û–†–î!";
                document.getElementById('reviewModal').style.display = 'flex';
            } else {
                document.getElementById('recordMsg').innerText = "";
            }

            document.querySelector('.mode-selector').style.opacity = '1';
            document.getElementById('legalCheck').checked = false;
            document.getElementById('startBtn').style.display = 'block'; 
            
            checkSavedName(); 
            toggleSaveBtn(); 
            
            document.getElementById('screen-game').classList.remove('active');
            document.getElementById('screen-save').classList.add('active');
            document.getElementById('bottomMenu').style.display = 'flex';
        }
        
        function saveScore() {
            let name = "";
            const savedName = localStorage.getItem('box_username');
            
            if (savedName && document.getElementById('nameDisplayArea').style.display !== 'none') {
                name = savedName;
            } else {
                name = document.getElementById('nicknameInput').value.trim();
                if(name.length < 2) { alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è!"); return; }
                localStorage.setItem('box_username', name); 
            }

            const btn = document.querySelector('#screen-save button');
            btn.innerText = "–û–¢–ü–†–ê–í–ö–ê..."; btn.disabled = true;
            fetch(GOOGLE_SCRIPT_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ name: name, score: score, mode: currentMode, date: new Date().toLocaleDateString() }) })
            .then(() => {
                switchScreen('leaders');
                btn.innerText = "–°–û–•–†–ê–ù–ò–¢–¨ –í –¢–û–ü"; btn.disabled = false;
            })
            .catch(() => switchScreen('leaders'));
        }

        // --- –¢–ï–ú–´ –ò –°–ö–ò–ù–´ ---
        function openSkins() {
            const grid = document.getElementById('skinsGrid');
            grid.innerHTML = '';
            for (const [key, theme] of Object.entries(THEMES)) {
                const locked = totalHits < theme.cost;
                const active = currentTheme === key ? 'active-skin' : '';
                const lockIcon = locked ? '<div class="lock-icon">üîí</div>' : '';
                const opacity = locked ? '0.5' : '1';
                grid.innerHTML += `
                <div class="skin-card ${active}" style="opacity:${opacity}" onclick="selectTheme('${key}', ${theme.cost})">
                    <div class="skin-color" style="background:${theme.color}"></div>
                    <div class="skin-name">${theme.name}</div>
                    ${lockIcon}
                </div>`;
            }
        }

        function selectTheme(key, cost) {
            if (totalHits < cost) {
                alert(`–ù—É–∂–Ω–æ –Ω–∞–±—Ä–∞—Ç—å ${cost} —É–¥–∞—Ä–æ–≤! –£ —Ç–µ–±—è –ø–æ–∫–∞ ${totalHits}.`);
                return;
            }
            applyTheme(key);
            openSkins();
        }

        function applyTheme(key) {
            currentTheme = key;
            localStorage.setItem('box_theme', key);
            const t = THEMES[key];
            const root = document.documentElement;
            root.style.setProperty('--primary', t.color);
            root.style.setProperty('--bg-grad-start', t.bg1);
            root.style.setProperty('--bg-grad-end', t.bg2);
        }

        // --- –£–¢–ò–õ–ò–¢–´ ---
        function toggleOption(opt) {
            const el = document.getElementById('togSound');
            const isOn = el.classList.contains('on');
            if(isOn) { el.classList.remove('on'); isSoundOn = false; } 
            else { el.classList.add('on'); isSoundOn = true; }
            localStorage.setItem('box_sound', !isOn);
        }
        
        function checkCode() { 
            const val = document.getElementById('passInput').value.trim();
            if(VALID_CODES.includes(val)) { 
                localStorage.setItem('box_auth', 'true'); 
                document.getElementById('screen-login').classList.remove('active');
                switchScreen('game'); 
                showToast(); 
            } 
            else { document.getElementById('errorMsg').style.display = 'block'; }
        }
        
        function logout() { localStorage.removeItem('box_auth'); location.reload(); }
        
        function checkSavedName() {
            const savedName = localStorage.getItem('box_username');
            if(savedName) {
                document.getElementById('nameInputArea').style.display = 'none';
                document.getElementById('nameDisplayArea').style.display = 'block';
                document.getElementById('displayName').innerText = savedName;
            } else {
                document.getElementById('nameInputArea').style.display = 'block';
                document.getElementById('nameDisplayArea').style.display = 'none';
            }
        }
        
        function editName() {
            document.getElementById('nameInputArea').style.display = 'block';
            document.getElementById('nameDisplayArea').style.display = 'none';
        }
        
        function toggleSaveBtn() { document.getElementById('saveBtn').disabled = !document.getElementById('legalCheck').checked; }
        function openPolicy() { window.Telegram.WebApp.openLink(POLICY_URL); }
        
        function updateSens(val) { 
            SENSITIVITY = parseInt(val); 
            document.getElementById('sensVal').innerText = SENSITIVITY; 
            document.getElementById('sensRange').value = SENSITIVITY;
            const percent = Math.min(SENSITIVITY * 2, 100); 
            document.getElementById('micThresh').style.left = percent + "%";
            localStorage.setItem('box_sens', SENSITIVITY); 
        }
        
        function setRecommended() { updateSens(15); } 
        function openReviewLink(url) { 
            window.Telegram.WebApp.openLink(url); 
            document.getElementById('reviewModal').style.display = 'none'; 
        }

        function setMode(mode) {
            if(isRunning) return;
            currentMode = mode;
            document.querySelectorAll('.mode-btn').forEach(b => b.className = 'mode-btn');
            
            if(mode === 'sprint') {
                document.getElementById('btnSprint').className += ' active-mode';
                document.getElementById('timer').innerText = "60";
                document.getElementById('modeHint').innerText = "–ù–ê–ë–ï–ô –ú–ê–ö–°–ò–ú–£–ú –ó–ê 60 –°–ï–ö";
                document.getElementById('timer').style.color = "#fff";
            } else if (mode === 'survival') {
                document.getElementById('btnSurvival').className += ' active-mode';
                document.getElementById('timer').innerText = "10";
                document.getElementById('modeHint').innerText = "–£–°–ö–û–†–Ø–ô–°–Ø, –ß–¢–û–ë–´ –í–´–ñ–ò–¢–¨!";
                document.getElementById('timer').style.color = "#ffcc00";
            } else if (mode === 'rhythm') {
                document.getElementById('btnRhythm').className += ' active-mode';
                document.getElementById('timer').innerText = "60";
                document.getElementById('modeHint').innerText = "–ë–ï–ô –í –¢–ê–ö–¢ –ú–ï–¢–†–û–ù–û–ú–ê";
                document.getElementById('timer').style.color = "#00ff88";
            }
        }

        function playSound(type) {
            if (!isSoundOn) return;
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            
            if (type === 'hit') {
                osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
                osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime+0.1);
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.1);
                osc.start(); osc.stop(audioCtx.currentTime+0.1);
            } else if (type === 'tick') {
                osc.frequency.setValueAtTime(1000, audioCtx.currentTime);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.05);
                osc.type = 'square'; osc.start(); osc.stop(audioCtx.currentTime+0.05);
            } else if (type === 'end') {
                osc.frequency.value = 200; gain.gain.setValueAtTime(0.5, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime+1.5);
                osc.start(); osc.stop(audioCtx.currentTime+1.5);
            }
        }

        function launchConfetti() {
            const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
            for(let i=0; i<30; i++) {
                const c = document.createElement('div');
                c.className = 'confetti';
                c.style.left = Math.random()*100 + 'vw';
                c.style.background = colors[Math.floor(Math.random()*colors.length)];
                c.style.animationDuration = (Math.random()*2+2) + 's';
                document.body.appendChild(c);
                setTimeout(()=>c.remove(), 4000);
            }
        }

        function switchLeaderTab(mode) {
            document.querySelectorAll('.leader-tab').forEach(t => t.className = 'leader-tab');
            document.getElementById('tab' + mode.charAt(0).toUpperCase() + mode.slice(1)).classList.add('active-tab');
            fetchLeaderboardData(mode);
        }

        function showLeaderboard(fromMenu = false, initialMode = 'sprint') {
            switchLeaderTab(initialMode);
        }

        function fetchLeaderboardData(mode) {
            const list = document.getElementById('leaderList'); 
            list.innerHTML = "<div style='padding:20px'>–ó–∞–≥—Ä—É–∑–∫–∞...</div>";
            fetch(GOOGLE_SCRIPT_URL + "?mode=" + mode)
            .then(r=>r.json())
            .then(data => {
                list.innerHTML = "";
                if(!data.length) list.innerHTML = "<div style='padding:20px'>–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>";
                data.forEach((row, i) => {
                    let dateStr = row.date ? row.date : ''; 
                    list.innerHTML += `
                    <div class="leader-row">
                        <div class="leader-left">
                            <span class="leader-name">#${i+1} ${row.name}</span>
                            <span class="leader-date">${dateStr}</span>
                        </div>
                        <span class="leader-score">${row.score}</span>
                    </div>`;
                });
            })
            .catch(()=>list.innerHTML = "<div style='padding:20px'>–û—à–∏–±–∫–∞ —Å–µ—Ç–∏</div>");
        }
    </script>
</body>
</html>
